<Window x:Class="Comfizen.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
        xmlns:local="clr-namespace:Comfizen"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="Comfizen v1.3" Height="600" Width="1000"
        WindowStartupLocation="CenterScreen"
        MinWidth="800" MinHeight="500"
        Background="{StaticResource PrimaryBackground}"
        Foreground="{StaticResource TextBrush}"
        Style="{StaticResource CustomWindowStyle}"
        KeyDown="MainWindow_OnKeyDown"
        AllowDrop="True"
        DragOver="Window_DragOver"
        Drop="Window_Drop">
    <Window.DataContext>
        <local:MainViewModel/>
    </Window.DataContext>
    <Window.Resources>
        <DataTemplate x:Key="WorkflowItemTemplate" DataType="{x:Type sys:String}">
            <TextBlock Text="{Binding Converter={StaticResource FileNameTrimmerConverter}}" Padding="5,3"/>
        </DataTemplate>

        <DataTemplate x:Key="WorkflowHeaderTemplate" DataType="{x:Type local:WorkflowListHeader}">
            <TextBlock Text="{Binding Title}" FontWeight="Bold" Margin="2,5,2,2" Foreground="{StaticResource TextSecondaryBrush}"/>
        </DataTemplate>

        <local:WorkflowTemplateSelector x:Key="WorkflowTemplateSelector"
                                        WorkflowTemplate="{StaticResource WorkflowItemTemplate}"
                                        HeaderTemplate="{StaticResource WorkflowHeaderTemplate}"/>
        
        <Style x:Key="WorkflowTabControlStyle" TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabControl">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="{Binding Items.Count, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource TabCountToHeaderHeightConverter}}"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <!-- This Border acts as the "tab bar" background -->
                            <Border Grid.Row="0" Background="{StaticResource TertiaryBackground}" CornerRadius="3" Padding="5,5,5,0">
                                <TabPanel IsItemsHost="True" Background="Transparent"/>
                            </Border>
                            <Border Grid.Row="1" Background="Transparent" BorderThickness="0">
                                <ContentPresenter ContentSource="SelectedContent"/>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="WorkflowTabItemStyle" TargetType="TabItem">
            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <!-- This Border is the clickable tab itself -->
                        <Border x:Name="Border" 
                                Background="{TemplateBinding Background}" 
                                BorderThickness="0" 
                                CornerRadius="3,3,0,0" 
                                Margin="0,0,2,0"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <!-- Style for the selected tab -->
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                <!-- The background matches the content area, making it look connected -->
                                <Setter TargetName="Border" Property="Background" Value="{StaticResource SecondaryBackground}"/>
                            </Trigger>
                            <!-- Style for hovering over an unselected tab -->
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsSelected" Value="False"/>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                </MultiTrigger.Conditions>
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                <Setter TargetName="Border" Property="Background" Value="{StaticResource PrimaryBackground}"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <ControlTemplate x:Key="CustomContextMenuTemplate" TargetType="ContextMenu">
            <Border x:Name="Border" 
                    Background="{StaticResource SecondaryBackground}"
                    BorderBrush="{StaticResource TertiaryBackground}"
                    BorderThickness="1">
                <ItemsPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
            </Border>
            <ControlTemplate.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter TargetName="Border" Property="Background" Value="{StaticResource TertiaryBackground}"/>
                    <Setter TargetName="Border" Property="BorderBrush" Value="#454545"/>
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>
    
        <Style x:Key="AppContextMenuStyle" TargetType="ContextMenu">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Template" Value="{StaticResource CustomContextMenuTemplate}"/>
        </Style>
    
        <Style TargetType="MenuItem">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border x:Name="Border" 
                                Background="Transparent"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header" 
                                              RecognizesAccessKey="True"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="Gray"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
            
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition x:Name="ConsoleRow" Height="200">
                <RowDefinition.Style>
                    <Style TargetType="RowDefinition">
                        <Setter Property="MaxHeight" Value="0"/>
                        <Setter Property="MinHeight" Value="0"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsConsoleVisible}" Value="True">
                                <Setter Property="MaxHeight" Value="10000"/> 
                                <Setter Property="MinHeight" Value="40"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </RowDefinition.Style>
            </RowDefinition>
        </Grid.RowDefinitions>
        
        <Border Grid.Row="0" Background="{StaticResource SecondaryBackground}" Margin="5,5,5,0" CornerRadius="5,5,0,0">
            <DockPanel Margin="8">
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="10,0,0,0">
                    <Button Content="&#xE70F;" Style="{StaticResource IconButton}" Command="{Binding EditWorkflowCommand}" ToolTip="{local:Translate Toolbar_EditWorkflow}"/>
                    <Button Content="&#xE710;" Style="{StaticResource IconButton}" Command="{Binding OpenConstructorCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_NewWorkflow}"/>
                    <Button Content="&#xE74D;" Style="{StaticResource IconButton}" Command="{Binding DeleteWorkflowCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_DeleteWorkflow}"/>
                    <Button Content="&#xE7A7;" Style="{StaticResource IconButton}" Command="{Binding ClearSessionCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_ResetSession}"/>
                    <Button Content="&#xE738;" Style="{StaticResource IconButton}" Command="{Binding ClearBlockedNodesCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_ClearBlockedNodes}"/>
                    <Button Content="&#xE74E;" Style="{StaticResource IconButton}" Command="{Binding SaveChangesToWorkflowCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_SaveChanges}"/>
                    <Button Content="&#xE78C;" Style="{StaticResource IconButton}" Command="{Binding ExportCurrentStateCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_ExportState}"/>
                    <Button Content="&#xE72C;" Style="{StaticResource IconButton}" Command="{Binding RefreshModelsCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_RefreshModels}"/>
                    <Button Content="&#xE75F;" Style="{StaticResource IconButton}" Command="{Binding ToggleConsoleCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_ToggleConsole}"/>
                    <Button Content="&#xE713;" Style="{StaticResource IconButton}" Command="{Binding OpenSettingsCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_Settings}"/>
                    <Button Content="&#xE897;" Style="{StaticResource IconButton}" Command="{Binding OpenHelpCommand}" Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_Help}"/>
                </StackPanel>

                <local:FilterableComboBox
                    ItemsSource="{Binding WorkflowDisplayList}"
                    SelectedItem="{Binding SelectedWorkflow, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource FileNameTrimmerConverter}}"
                    SearchFilter="{Binding WorkflowSearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    ItemSelected="FilterableComboBox_ItemSelected"
                    PlaceholderText="{local:Translate FilterableComboBox_Placeholder}"
                    ItemTemplateSelector="{StaticResource WorkflowTemplateSelector}"
                    ShowCycleButtons="False"/>
            </DockPanel>
        </Border>
        
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <TabControl Grid.Row="0" ItemsSource="{Binding OpenTabs}" SelectedItem="{Binding SelectedTab, Mode=TwoWay}" Margin="5,0,5,0" Background="Transparent" BorderThickness="0">
                <TabControl.ContentTemplate>
                    <DataTemplate />
                </TabControl.ContentTemplate>
                <TabControl.Style>
                    <Style TargetType="TabControl">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding OpenTabs.Count}" Value="0">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TabControl.Style>
                <TabControl.ItemContainerStyle>
                    <Style TargetType="TabItem">
                        <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                        <Setter Property="Background" Value="{StaticResource SecondaryBackground}"/>
                        <Setter Property="Padding" Value="8,5"/>
                        <Setter Property="AllowDrop" Value="True"/>
                        <EventSetter Event="DragOver" Handler="TabItem_DragOver"/>
                        <EventSetter Event="DragEnter" Handler="TabItem_DragEnter"/>
                        <EventSetter Event="PreviewMouseLeftButtonDown" Handler="TabItem_PreviewMouseLeftButtonDown"/>
                        <EventSetter Event="Drop" Handler="TabItem_Drop"/>
                        <EventSetter Event="MouseMove" Handler="TabItem_MouseMove"/>
                        <EventSetter Event="PreviewMouseUp" Handler="TabItem_PreviewMouseUp"/>
                        
                        <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=TabControl}}"/>
                        
                        <Setter Property="ContextMenu">
                            <Setter.Value>
                                <ContextMenu Style="{StaticResource AppContextMenuStyle}">
                                    <MenuItem Header="{local:Translate ContextMenu_CopyMarkdownLink}"
                                              Command="{Binding PlacementTarget.Tag.CopyWorkflowLinkCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}"/>
                                </ContextMenu>
                            </Setter.Value>
                        </Setter>
                        
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TabItem">
                                    <Border x:Name="Border" BorderThickness="0,0,0,2" BorderBrush="Transparent" Background="{TemplateBinding Background}" Margin="0,0,2,0">
                                        <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                            <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource PrimaryAccentBrush}"/>
                                            <Setter Property="Background" Value="{StaticResource PrimaryBackground}"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TabControl.ItemContainerStyle>
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" ToolTip="{Binding RelativePathTooltip}">
                            <TextBlock Text="{Binding Header}" VerticalAlignment="Center" />
                            <Button Content="&#xE711;" FontFamily="Segoe MDL2 Assets"
                                    Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                                    CommandParameter="{Binding}"
                                    Style="{StaticResource IconButton}" Width="20" Height="20" Margin="8,0,0,0"/>
                        </StackPanel>
                    </DataTemplate>
                </TabControl.ItemTemplate>
            </TabControl>
            
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1.2*" MinWidth="350"/>
                    <ColumnDefinition Width="5" />
                    <ColumnDefinition Width="2*" MinWidth="400" />
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="{Binding IsQueueManagerVisible, Converter={StaticResource BoolToGridLengthConverter}, ConverterParameter='1*'}" MinWidth="0"/>
                </Grid.ColumnDefinitions>
                
                <Border Grid.Column="0" Background="{StaticResource SecondaryBackground}" CornerRadius="0,0,0,5" Margin="5,0,0,5">
                   <ScrollViewer x:Name="ControlsScrollViewer" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                                  Visibility="{Binding SelectedTab, Converter={StaticResource StringToIsNotNullOrEmptyConverter}}"
                                  PreviewMouseWheel="ControlsScrollViewer_PreviewMouseWheel"
                                  Button.Click="WorkflowField_ButtonClick">
                        <StackPanel>
                            <StackPanel.Resources>
                                <DataTemplate DataType="{x:Type local:GlobalControlsViewModel}">
                                    <Expander Header="{Binding Header}" IsExpanded="{Binding IsExpanded, Mode=TwoWay}" BorderBrush="Orange" Margin="5"
                                              Visibility="{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <StackPanel Margin="5">
                                            <!-- Seed Controls -->
                                            <Grid Visibility="{Binding IsSeedSectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,10,0" VerticalAlignment="Center">
                                                    <TextBlock Text="{local:Translate Tab_WildcardSeed}"/>
                                                    <TextBlock Text="💡" VerticalAlignment="Center" Margin="5,0,0,0" Foreground="{StaticResource TextSecondaryBrush}" />
                                                </StackPanel>
                                                <Grid Grid.Column="1">
                                                    <TextBox Text="{Binding WildcardSeed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Padding="5,5,28,5" />
                                                    <ToggleButton IsChecked="{Binding IsSeedLocked, Mode=TwoWay}" Style="{StaticResource LockToggleButtonStyle}" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                                </Grid>
                                            </Grid>
                                            <!-- Preset Controls -->
                                            <Grid Visibility="{Binding IsPresetsSectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,5,0,0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="{local:Translate GlobalPresets_Label}" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                                <local:FilterableComboBox Grid.Column="1"
                                                                          ItemsSource="{Binding GlobalPresetNames}"
                                                                          SelectedItem="{Binding SelectedGlobalPreset, Mode=TwoWay}"
                                                                          PlaceholderText="{local:Translate Presets_LoadPlaceholder}">
                                                    <local:FilterableComboBox.ItemTemplate>
                                                        <DataTemplate>
                                                            <TextBlock Text="{Binding}" Padding="2"/>
                                                        </DataTemplate>
                                                    </local:FilterableComboBox.ItemTemplate>
                                                    <local:FilterableComboBox.Style>
                                                        <Style TargetType="local:FilterableComboBox">
                                                            <Setter Property="IsEnabled" Value="True"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding GlobalPresetNames.Count}" Value="0">
                                                                    <Setter Property="IsEnabled" Value="False"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </local:FilterableComboBox.Style>
                                                </local:FilterableComboBox>
                                            </Grid>
                                            
                                            <Border Margin="0,5,0,0" Padding="0,5,0,0" BorderThickness="0,1,0,0" BorderBrush="{StaticResource TertiaryBackground}"
                                                    Visibility="{Binding IsHooksSectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <ItemsControl ItemsSource="{Binding ImplementedHooks}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel Orientation="Horizontal"/>
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="{x:Type local:HookToggleViewModel}">
                                                            <CheckBox IsChecked="{Binding IsEnabled, Mode=TwoWay}"
                                                                      Margin="0,0,15,5"
                                                                      VerticalContentAlignment="Center">
                                                                <TextBlock Text="{Binding HookName}"/>
                                                            </CheckBox>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </Border>
                                        </StackPanel>
                                    </Expander>
                                </DataTemplate>
                            </StackPanel.Resources>
                            
                            <ContentControl Content="{Binding SelectedTab.WorkflowInputsController.GlobalControls}" />
                            
                            <TabControl x:Name="WorkflowTabsControl" 
                                        ItemsSource="{Binding SelectedTab.WorkflowInputsController.TabLayoouts}" 
                                        SelectedItem="{Binding SelectedTab.WorkflowInputsController.SelectedTabLayout, Mode=TwoWay}"
                                        Margin="5,0,5,5"
                                        Style="{StaticResource WorkflowTabControlStyle}"
                                        ItemContainerStyle="{StaticResource WorkflowTabItemStyle}">
                                <TabControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Header}" />
                                    </DataTemplate>
                                </TabControl.ItemTemplate>
                                <TabControl.ContentTemplate>
                                    <DataTemplate>
                                        <ItemsControl ItemsSource="{Binding Groups}" Margin="0,5,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type local:WorkflowGroupViewModel}">
                                                    <ContentControl>
                                                        <ContentControl.Style>
                                                            <Style TargetType="ContentControl">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                <Style.Triggers>
                                                                    <!-- ADD: This trigger hides the group from the main list when it's undocked -->
                                                                    <DataTrigger Binding="{Binding IsUndocked}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </ContentControl.Style>
                                                        
                                                    <Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}" Margin="5">
                                                        <Expander.Header>
                                                            <TextBlock Text="{Binding Name}" FontWeight="Bold" />
                                                        </Expander.Header>
                                                        <Expander.Template>
                                                <ControlTemplate TargetType="Expander">
                                                    <Border BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="3" Background="Transparent">
                                                        <DockPanel>
                                                            <ToggleButton DockPanel.Dock="Top" IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}" OverridesDefaultStyle="True" Content="{TemplateBinding Header}" ContentTemplate="{TemplateBinding HeaderTemplate}">
                                                                <ToggleButton.Template>
                                                                    <ControlTemplate TargetType="ToggleButton">
                                                                        <Grid>
                                                                            <Border Background="{StaticResource TertiaryBackground}" CornerRadius="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=Expander}, Converter={StaticResource ExpanderCornerRadiusConverter}}" />
                                                                            <Border CornerRadius="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=Expander}, Converter={StaticResource ExpanderCornerRadiusConverter}}" Background="{Binding DataContext.HighlightColor, RelativeSource={RelativeSource AncestorType=Expander}, Converter={StaticResource HexToBrushConverter}}">
                                                                                <Border.Style>
                                                                                    <Style TargetType="Border">
                                                                                        <Setter Property="Opacity" Value="0.2" />
                                                                                        <Style.Triggers>
                                                                                            <DataTrigger Binding="{Binding DataContext.HighlightColor, RelativeSource={RelativeSource AncestorType=Expander}}" Value="{x:Null}">
                                                                                                <Setter Property="Opacity" Value="0" />
                                                                                            </DataTrigger>
                                                                                        </Style.Triggers>
                                                                                    </Style>
                                                                                </Border.Style>
                                                                            </Border>
                                                                            <Border Padding="8">
                                                                                <Grid>
                                                                                    <Grid.ColumnDefinitions>
                                                                                        <ColumnDefinition Width="Auto"/>
                                                                                        <ColumnDefinition Width="*"/>
                                                                                        <ColumnDefinition Width="Auto"/>
                                                                                    </Grid.ColumnDefinitions>
                                                                                    
                                                                                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                                                                                        <TextBlock x:Name="Arrow" Text="▶" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                                                                        <ContentPresenter Grid.Column="1" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" RecognizesAccessKey="True"/>
                                                                                    </StackPanel>
                                                                                    
                                                                                    <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right"
                                                                                        Visibility="{Binding Fields.Count, Converter={StaticResource TaskCountToVisibilityConverter}}">
                                                                                        
                                                                                        <ContentPresenter Content="{Binding}"
                                                                                            ContentTemplate="{StaticResource GroupHeaderPresetControls}"
                                                                                            VerticalAlignment="Center"/>
                                                                                        
                                                                                        <Button Content="&#xE8A7;" FontFamily="Segoe MDL2 Assets" 
                                                                                            Style="{StaticResource IconButton}" Width="24" Height="24"
                                                                                            Command="{Binding DataContext.ToggleUndockGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                            CommandParameter="{Binding}"
                                                                                            ToolTip="Undock Group"
                                                                                            Margin="5,0,0,0"/>

                                                                                    </StackPanel>
                                                                                </Grid>
                                                                            </Border>
                                                                        </Grid>
                                                                        <ControlTemplate.Triggers>
                                                                            <Trigger Property="IsChecked" Value="True">
                                                                                <Setter TargetName="Arrow" Property="Text" Value="▼"/>
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </ToggleButton.Template>
                                                            </ToggleButton>
                                                            
                                                            <Popup IsOpen="{Binding IsSavePresetPopupOpen, Mode=TwoWay}" 
                                                                   StaysOpen="False" 
                                                                   Placement="Bottom" 
                                                                   PlacementTarget="{Binding ElementName=HeaderToggleButton}"
                                                                   AllowsTransparency="True"
                                                                   Opened="PresetPopup_Opened"> 
                                                                <Border Background="{StaticResource SecondaryBackground}" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="1" CornerRadius="3" Padding="10" Margin="0,2,0,0">
                                                                    <StackPanel>
                                                                        <TextBlock Text="{local:Translate Presets_SaveCurrentState}" FontWeight="Bold" Margin="0,0,0,5"/>
                                                                        
                                                                        <Grid>
                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                            </Grid.RowDefinitions>
                                                                            
                                                                            <!-- Preset Name Input -->
                                                                            <TextBox Grid.Row="0" x:Name="PresetNameTextBox" MinWidth="250"
                                                                                     Text="{Binding NewPresetName, UpdateSourceTrigger=PropertyChanged}" />

                                                                            <!-- Field Selection List -->
                                                                            <Border Grid.Row="1" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="0,1" Margin="0,8" Padding="0,8,0,5">
                                                                                <StackPanel>
                                                                                    <TextBlock Text="{local:Translate Presets_FieldsToInclude}" Margin="0,0,0,5" Foreground="{StaticResource TextSecondaryBrush}"/>
                                                                                    <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
                                                                                        <ItemsControl ItemsSource="{Binding FieldsForPresetSelection}">
                                                                                            <ItemsControl.ItemTemplate>
                                                                                                <DataTemplate>
                                                                                                    <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                                                                              Margin="2" VerticalContentAlignment="Center">
                                                                                                        <TextBlock Text="{Binding Name}" />
                                                                                                    </CheckBox>
                                                                                                </DataTemplate>
                                                                                            </ItemsControl.ItemTemplate>
                                                                                        </ItemsControl>
                                                                                    </ScrollViewer>

                                                                                    <StackPanel Orientation="Horizontal" Margin="2,5,0,0">
                                                                                        <Button Content="{local:Translate Presets_SelectAll}"
                                                                                                Command="{Binding SelectAllFieldsForPresetCommand}"
                                                                                                Style="{StaticResource TextButtonStyle}"/>
                                                                                        <Button Content="{local:Translate Presets_DeselectAll}"
                                                                                                Command="{Binding DeselectAllFieldsForPresetCommand}"
                                                                                                Style="{StaticResource TextButtonStyle}"
                                                                                                Margin="10,0,0,0"/>
                                                                                    </StackPanel>
                                                                        
                                                                                </StackPanel>
                                                                            </Border>

                                                                            <!-- Save Button -->
                                                                            <Button Grid.Row="2" Content="{local:Translate Presets_SaveButton}" 
                                                                                    Command="{Binding SavePresetCommand}"
                                                                                    HorizontalAlignment="Right"
                                                                                    IsDefault="True"/>
                                                                        </Grid>
                                                                    </StackPanel>
                                                                </Border>
                                                            </Popup>
                    
                                                            <Grid x:Name="ContentSite" DockPanel.Dock="Bottom" Visibility="Collapsed">
                                                                <Border Opacity="0.2" Background="{Binding DataContext.HighlightColor, RelativeSource={RelativeSource AncestorType=Expander}, Converter={StaticResource HexToBrushConverter}}"/>
                                                                <ContentPresenter ContentSource="Content" Margin="8"/>
                                                            </Grid>
                                                        </DockPanel>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsExpanded" Value="True">
                                                            <Setter TargetName="ContentSite" Property="Visibility" Value="Visible"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Expander.Template>
                                            <ItemsControl ItemsSource="{Binding Fields}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <DataTemplate.Resources>
                                                            <ControlTemplate x:Key="NormalFieldLayoutTemplate" TargetType="ContentControl">
                                                                <Grid Margin="0,4">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                        <ColumnDefinition Width="Auto" MinWidth="120"/>
                                                                        <ColumnDefinition Width="*" />
                                                                    </Grid.ColumnDefinitions>
                                                                    
                                                                    <Border Grid.Column="0" Width="3" CornerRadius="1.5" HorizontalAlignment="Left">
                                                                        <Border.Background>
                                                                            <MultiBinding Converter="{StaticResource PriorityColorToBrushConverter}">
                                                                                <Binding Path="HighlightColor"/>
                                                                                <Binding Path="DataContext.HighlightColor" RelativeSource="{RelativeSource AncestorType=Expander}"/>
                                                                            </MultiBinding>
                                                                        </Border.Background>
                                                                    </Border>
                                                                    
                                                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="10,0,10,0" VerticalAlignment="Top">
                                                                        <TextBlock Text="{Binding Name}">
                                                                            <TextBlock.ToolTip>
                                                                                <ToolTip>
                                                                                    <TextBlock>
                                                                                        <Run Text="{Binding NodeTitle, Mode=OneWay, StringFormat='Node: {0}'}" FontWeight="Bold"/>
                                                                                        <LineBreak/>
                                                                                        <Run Text="{Binding NodeType, Mode=OneWay, StringFormat='Type: {0}'}" Foreground="{StaticResource TextSecondaryBrush}"/>
                                                                                        <LineBreak/>
                                                                                        <Run Text="{Binding Path, Mode=OneWay, StringFormat='Path: {0}'}"/>
                                                                                    </TextBlock>
                                                                                </ToolTip>
                                                                            </TextBlock.ToolTip>
                                                                        </TextBlock>
                                                                        <TextBlock Margin="5,0,0,0" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding Type}" Value="Seed"><Setter Property="Text" Value="🎲"/></DataTrigger>
                                                                                        <DataTrigger Binding="{Binding Type}" Value="WildcardSupportPrompt"><Setter Property="Text" Value="💡"/></DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                    </StackPanel>
                                                                    <ContentPresenter Grid.Column="2" Content="{Binding}" ContentTemplateSelector="{StaticResource FieldTemplateSelector}" VerticalAlignment="Top" />

                                                                    <!-- english: This border is now last, so it will be drawn on top of the other elements. -->
                                                                    <Border x:Name="HighlightOverlay"
                                                                            Grid.Column="0" Grid.ColumnSpan="3"
                                                                            Background="{StaticResource PrimaryAccentBrush}"
                                                                            Opacity="0"
                                                                            CornerRadius="3"
                                                                            IsHitTestVisible="False"/>
                                                                </Grid>
                                                                <!-- english: Trigger for the highlight animation. -->
                                                                <ControlTemplate.Triggers>
                                                                    <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                                                        <DataTrigger.EnterActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetName="HighlightOverlay"
                                                                                                     Storyboard.TargetProperty="Opacity"
                                                                                                     From="0" To="0.3" Duration="0:0:0.2"
                                                                                                     AutoReverse="True" RepeatBehavior="2x" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.EnterActions>
                                                                    </DataTrigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                            <ControlTemplate x:Key="InpaintLayoutTemplate" TargetType="ContentControl">
                                                                <Grid>
                                                                    <ContentPresenter Content="{Binding}" ContentTemplateSelector="{StaticResource FieldTemplateSelector}" />
                                                                    <!-- english: This border is now last, so it will be drawn on top of the other elements. -->
                                                                    <Border x:Name="HighlightOverlay"
                                                                            Background="{StaticResource PrimaryAccentBrush}"
                                                                            Opacity="0"
                                                                            CornerRadius="3"
                                                                            IsHitTestVisible="False"/>
                                                                </Grid>
                                                                <!-- english: Trigger for the highlight animation. -->
                                                                <ControlTemplate.Triggers>
                                                                    <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                                                        <DataTrigger.EnterActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetName="HighlightOverlay"
                                                                                                     Storyboard.TargetProperty="Opacity"
                                                                                                     From="0" To="0.3" Duration="0:0:0.2"
                                                                                                     AutoReverse="True" RepeatBehavior="2x" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.EnterActions>
                                                                    </DataTrigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                            <ControlTemplate x:Key="FullWidthLayoutTemplate" TargetType="ContentControl">
                                                                    <Grid>
                                                                    <ContentPresenter Content="{Binding}" ContentTemplateSelector="{StaticResource FieldTemplateSelector}" Margin="0,4" />
                                                                    <!-- english: This border is now last, so it will be drawn on top of the other elements. -->
                                                                    <Border x:Name="HighlightOverlay"
                                                                            Background="{StaticResource PrimaryAccentBrush}"
                                                                            Opacity="0"
                                                                            CornerRadius="3"
                                                                            IsHitTestVisible="False"/>
                                                                </Grid>
                                                                <!-- english: Trigger for the highlight animation. -->
                                                                <ControlTemplate.Triggers>
                                                                    <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                                                        <DataTrigger.EnterActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetName="HighlightOverlay"
                                                                                                     Storyboard.TargetProperty="Opacity"
                                                                                                     From="0" To="0.3" Duration="0:0:0.2"
                                                                                                     AutoReverse="True" RepeatBehavior="2x" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.EnterActions>
                                                                    </DataTrigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </DataTemplate.Resources>
                                                        <ContentControl Content="{Binding}">
                                                            <ContentControl.Style>
                                                                <Style TargetType="ContentControl">
                                                                    <Setter Property="Template" Value="{StaticResource NormalFieldLayoutTemplate}"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding Converter={StaticResource IsInpaintViewModelConverter}}" Value="True">
                                                                            <Setter Property="Template" Value="{StaticResource InpaintLayoutTemplate}"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding Converter={StaticResource IsMarkdownViewModelConverter}}" Value="True">
                                                                            <Setter Property="Template" Value="{StaticResource FullWidthLayoutTemplate}"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding Type}" Value="ScriptButton">
                                                                            <Setter Property="Template" Value="{StaticResource FullWidthLayoutTemplate}"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </ContentControl.Style>
                                                        </ContentControl>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Expander>
                                                        </ContentControl>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </DataTemplate>
                                </TabControl.ContentTemplate>
                            </TabControl>
                            
                        </StackPanel>
                    </ScrollViewer>
                </Border>
                
                <GridSplitter Grid.Column="1" 
                              Style="{StaticResource VerticalGridSplitterStyle}"
                              ResizeBehavior="PreviousAndNext"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Stretch"/>
            
                <Grid Grid.Column="2">
                    <Border Background="{StaticResource SecondaryBackground}" CornerRadius="0,0,5,0" Margin="0,0,5,5">
                        <DockPanel>
                            <Border DockPanel.Dock="Top" Padding="8" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="0,0,0,1">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox Grid.Column="0" Text="{Binding ImageProcessing.SearchFilterText, UpdateSourceTrigger=PropertyChanged}" Width="120" HorizontalAlignment="Left" VerticalAlignment="Center" ToolTip="{local:Translate Tab_GallerySearchPlaceholder}"/>

                                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                        
                                        <!-- Type Filter -->
                                        <TextBlock Text="{local:Translate Tab_GalleryFilterType}" Margin="0,0,5,0" VerticalAlignment="Center"/>
                                        <Border BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="0,0,1,0">
                                            <StackPanel Orientation="Horizontal">
                                                <RadioButton Tag="First" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="FileType" Content="{local:Translate Tab_GalleryFilterAll}" IsChecked="{Binding ImageProcessing.SelectedFileTypeFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:FileTypeFilter.All}}"/>
                                                <RadioButton Tag="Middle" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="FileType" Content="{local:Translate Tab_GalleryFilterImages}" IsChecked="{Binding ImageProcessing.SelectedFileTypeFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:FileTypeFilter.Images}}"/>
                                                <RadioButton Tag="Last" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="FileType" Content="{local:Translate Tab_GalleryFilterVideo}" IsChecked="{Binding ImageProcessing.SelectedFileTypeFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:FileTypeFilter.Video}}"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- Saved Status Filter -->
                                        <TextBlock Text="{local:Translate Tab_GalleryFilterSavedStatus}" Margin="15,0,5,0" VerticalAlignment="Center"/>
                                         <Border BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="0,0,1,0">
                                            <StackPanel Orientation="Horizontal">
                                                <RadioButton Tag="First" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="SavedStatus" Content="{local:Translate Tab_GalleryFilterAll}" IsChecked="{Binding ImageProcessing.SelectedSavedStatusFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:SavedStatusFilter.All}}"/>
                                                <RadioButton Tag="Middle" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="SavedStatus" Content="{local:Translate Tab_GalleryFilterSaved}" IsChecked="{Binding ImageProcessing.SelectedSavedStatusFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:SavedStatusFilter.Saved}}"/>
                                                <RadioButton Tag="Last" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="SavedStatus" Content="{local:Translate Tab_GalleryFilterUnsaved}" IsChecked="{Binding ImageProcessing.SelectedSavedStatusFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:SavedStatusFilter.Unsaved}}"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,15,0"
                                                    Visibility="{Binding ImageProcessing.IsSimilaritySortActive, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <TextBlock Text="{local:Translate Tab_GallerySimilarityThreshold}" VerticalAlignment="Center"/>
                                            <Slider Width="70" Margin="5,0" Minimum="50" Maximum="100" IsSnapToTickEnabled="True" TickFrequency="1"
                                                    Value="{Binding ImageProcessing.SimilarityThreshold, Mode=TwoWay, Delay=200}"/>
                                            <TextBlock Text="{Binding ImageProcessing.SimilarityThreshold, StringFormat={}{0:F0}%}" MinWidth="30"/>
                                        </StackPanel>
                                        
                                        <TextBlock Text="{local:Translate Tab_GallerySort}" Margin="15,0,5,0"/>
                                        <ComboBox ItemsSource="{Binding Source={local:EnumBindingSource {x:Type local:SortOption}}}" SelectedItem="{Binding ImageProcessing.SelectedSortOption}" Width="120"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                            <Border DockPanel.Dock="Bottom" Padding="8" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="0,1,0,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <TextBlock Text="{local:Translate Tab_GalleryThumbnailSize}" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                        <Slider x:Name="ThumbnailSizeSlider" Minimum="64" Maximum="1024" 
                                                Value="{Binding ImageProcessing.GalleryThumbnailSize, Mode=TwoWay}" 
                                                Width="100"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="20,0"
                                                Visibility="{Binding TotalTasks, Converter={StaticResource TaskCountToVisibilityConverter}}">
                                        <ProgressBar Value="{Binding CurrentProgress}" Maximum="100" Height="5" MinWidth="200" />
                                        <Grid MinWidth="200">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" HorizontalAlignment="Left" Margin="0,2,0,0" FontSize="10" Foreground="{StaticResource TextSecondaryBrush}">
                                                <TextBlock.Text>
                                                    <MultiBinding Converter="{StaticResource MultiBindingStringFormatConverter}">
                                                        <Binding Path="[Tab_CompletedTasks]" Source="{x:Static local:LocalizationService.Instance}" Mode="OneWay"/>
                                                        <Binding Path="CompletedTasks"/>
                                                        <Binding Path="TotalTasks"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                            <TextBlock Grid.Column="1" Text="{Binding EstimatedTimeRemaining}"
                                                       HorizontalAlignment="Right" Margin="0,2,0,0" FontSize="10" Foreground="{StaticResource TextSecondaryBrush}"
                                                       Visibility="{Binding EstimatedTimeRemaining, Converter={StaticResource StringToIsNotNullOrEmptyConverter}}"/>
                                        </Grid>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,10,0">
                                            <TextBlock Text="🎲" FontSize="14" VerticalAlignment="Center" Margin="0,0,5,0" ToolTip="{local:Translate Tab_SeedControl}"/>
                                            <ComboBox x:Name="SeedControlComboBox" ItemsSource="{Binding SeedControlEnumValues}" SelectedItem="{Binding SelectedTab.WorkflowInputsController.SelectedSeedControl}" MinWidth="100"/>
                                        </StackPanel>
                                        
                                        <Button Content="&#xE945;" Style="{StaticResource IconButton}" 
                                                Command="{Binding ToggleQueueManagerCommand}" 
                                                Margin="0,0,10,0"
                                                ToolTip="{local:Translate QueueManager_Title}"/>

                                        <ToggleButton x:Name="XyGridToggleButton"
                                                      Content="XY"
                                                      FontWeight="Bold"
                                                      IsChecked="{Binding SelectedTab.WorkflowInputsController.IsXyGridPopupOpen, Mode=TwoWay}"
                                                      ToolTip="{local:Translate XYGrid_Title}"
                                                      Margin="0,0,10,0">
                                            <ToggleButton.Style>
                                                <Style TargetType="ToggleButton" BasedOn="{StaticResource IconToggleButton}">
                                                    <Setter Property="IsEnabled" Value="{Binding SelectedTab.WorkflowInputsController.GridableFields.Count, Converter={StaticResource CountToBooleanConverter}}"/>
                                                    <Style.Triggers>
                                                        <!-- Highlight button when grid is active -->
                                                        <DataTrigger Binding="{Binding SelectedTab.WorkflowInputsController.IsXyGridEnabled}" Value="True">
                                                            <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                                                            <Setter Property="Foreground" Value="White"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ToggleButton.Style>
                                        </ToggleButton>

                                        <Popup IsOpen="{Binding IsChecked, ElementName=XyGridToggleButton}"
                                               StaysOpen="False"
                                               PlacementTarget="{Binding ElementName=XyGridToggleButton}"
                                               Placement="Top"
                                               AllowsTransparency="True">
                                            <Border Background="{StaticResource TertiaryBackground}" CornerRadius="5" Padding="15" Margin="0,0,0,5"
                                                    BorderBrush="{StaticResource PrimaryAccentBrush}" BorderThickness="1">
                                                <StackPanel MinWidth="350">
                                                    <CheckBox Content="{local:Translate XYGrid_Enable}" 
                                                              IsChecked="{Binding SelectedTab.WorkflowInputsController.IsXyGridEnabled, Mode=TwoWay}"
                                                              FontWeight="Bold" Margin="0,0,0,10"/>
                                                    
                                                    <StackPanel Margin="15,0,0,10">
                                                        <CheckBox Content="{local:Translate XYGrid_CreateGridImage}" IsChecked="{Binding SelectedTab.WorkflowInputsController.XyGridCreateGridImage, Mode=TwoWay}"/>
                                                        <CheckBox Content="{local:Translate XYGrid_ShowIndividualImages}" IsChecked="{Binding SelectedTab.WorkflowInputsController.XyGridShowIndividualImages, Mode=TwoWay}" Margin="0,5,0,0"/>
                                                    </StackPanel>
                                                    
                                                    <!-- X AXIS -->
                                                    <TextBlock Text="{local:Translate XYGrid_XAxisField}" Margin="0,0,0,2"/>
                                                    <ComboBox Margin="0,0,0,5"
                                                              ItemsSource="{Binding SelectedTab.WorkflowInputsController.GridableFields}"
                                                              SelectedItem="{Binding SelectedTab.WorkflowInputsController.SelectedXField}">
                                                        <ComboBox.ItemTemplate>
                                                            <DataTemplate>
                                                                <TextBlock Text="{Binding Name}" ToolTip="{Binding Path}"/>
                                                            </DataTemplate>
                                                        </ComboBox.ItemTemplate>
                                                    </ComboBox>

                                                    <!-- START OF XY GRID CHANGES -->
                                                    <local:FilterableComboBox ItemsSource="{Binding SelectedTab.WorkflowInputsController.XFieldItemsSource}"
                                                                              PlaceholderText="{local:Translate XYGrid_AddValuePlaceholder}"
                                                                              Margin="0,0,0,5"
                                                                              ItemSelectedCommand="{Binding SelectedTab.WorkflowInputsController.AddValueToGridCommand}"
                                                                              ItemSelectedCommandParameter="X">
                                                        <local:FilterableComboBox.Style>
                                                            <Style TargetType="local:FilterableComboBox">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding SelectedTab.WorkflowInputsController.IsXFieldComboBox}" Value="True">
                                                                        <Setter Property="Visibility" Value="Visible" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </local:FilterableComboBox.Style>
                                                    </local:FilterableComboBox>
                                                    <!-- END OF XY GRID CHANGES -->

                                                    <TextBlock Text="{local:Translate XYGrid_XValues}" Margin="0,0,0,2"/>
                                                    <TextBox Margin="0,0,0,10" MinHeight="60"
                                                             Text="{Binding SelectedTab.WorkflowInputsController.XValues, UpdateSourceTrigger=PropertyChanged}"
                                                             AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto"/>

                                                    <!-- Y AXIS -->
                                                    <TextBlock Text="{local:Translate XYGrid_YAxisField}" Margin="0,0,0,2"/>
                                                    <ComboBox Margin="0,0,0,5"
                                                              ItemsSource="{Binding SelectedTab.WorkflowInputsController.GridableFields}"
                                                              SelectedItem="{Binding SelectedTab.WorkflowInputsController.SelectedYField}">
                                                        <ComboBox.ItemTemplate>
                                                            <DataTemplate>
                                                                <TextBlock Text="{Binding Name}" ToolTip="{Binding Path}"/>
                                                            </DataTemplate>
                                                        </ComboBox.ItemTemplate>
                                                    </ComboBox>

                                                    <!-- START OF XY GRID CHANGES -->
                                                    <local:FilterableComboBox ItemsSource="{Binding SelectedTab.WorkflowInputsController.YFieldItemsSource}"
                                                                              PlaceholderText="{local:Translate XYGrid_AddValuePlaceholder}"
                                                                              Margin="0,0,0,5"
                                                                              ItemSelectedCommand="{Binding SelectedTab.WorkflowInputsController.AddValueToGridCommand}"
                                                                              ItemSelectedCommandParameter="Y">
                                                        <local:FilterableComboBox.Style>
                                                            <Style TargetType="local:FilterableComboBox">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding SelectedTab.WorkflowInputsController.IsYFieldComboBox}" Value="True">
                                                                        <Setter Property="Visibility" Value="Visible" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </local:FilterableComboBox.Style>
                                                    </local:FilterableComboBox>
                                                    <!-- END OF XY GRID CHANGES -->

                                                    <TextBlock Text="{local:Translate XYGrid_YValues}" Margin="0,0,0,2"/>
                                                    <TextBox Text="{Binding SelectedTab.WorkflowInputsController.YValues, UpdateSourceTrigger=PropertyChanged}"
                                                             MinHeight="60" AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto"/>
                                                </StackPanel>
                                            </Border>
                                        </Popup>
                                        
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                
                                            <Border Grid.Column="0" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="1" CornerRadius="3" Height="30">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                
                                                    <Button Grid.Column="0"
                                                            Content="{local:Translate Tab_Queue}"
                                                            Background="{StaticResource SuccessBrush}"
                                                            Command="{Binding QueueCommand}"
                                                            BorderThickness="0"
                                                            Padding="10,0">
                                                        <Button.Template>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}" CornerRadius="3,0,0,3">
                                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Button.Template>
                                                    </Button>
                                                    
                                                    <Border Grid.Column="1" Width="1" Background="{StaticResource TertiaryBackground}" />
                
                                                    <ToggleButton Grid.Column="1" Margin="1,0,0,0"
                                                                  Content="&#xE8EE;" 
                                                                  FontFamily="Segoe MDL2 Assets"
                                                                  Style="{StaticResource IconToggleButton}"
                                                                  ToolTip="{local:Translate Tab_ToggleInfiniteQueue}"
                                                                  IsChecked="{Binding IsInfiniteQueueEnabled, Mode=TwoWay}"
                                                                  Width="30">
                                                        <ToggleButton.Template>
                                                            <ControlTemplate TargetType="ToggleButton">
                                                                <Border x:Name="Bg" Background="{TemplateBinding Background}" CornerRadius="0,3,3,0">
                                                                    <TextBlock Text="{TemplateBinding Content}" FontFamily="{TemplateBinding FontFamily}" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="{TemplateBinding Foreground}"/>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter TargetName="Bg" Property="Background" Value="{StaticResource TertiaryBackground}"/>
                                                                    </Trigger>
                                                                    <Trigger Property="IsChecked" Value="True">
                                                                        <Setter TargetName="Bg" Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                                                                        <Setter Property="Foreground" Value="White"/>
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </ToggleButton.Template>
                                                    </ToggleButton>
                                                </Grid>
                                            </Border>
                
                                            <xctk:IntegerUpDown Grid.Column="1" Margin="5,0,0,0"
                                                                Value="{Binding QueueSize}"
                                                                Minimum="1"
                                                                Maximum="{Binding MaxQueueSize}"
                                                                Spinned="QueueSizeUpDown_OnSpinned"
                                                                Width="60"/>
                
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="5,0,0,0">
                                                <ToggleButton Command="{Binding TogglePauseQueueCommand}" IsChecked="{Binding IsQueuePaused, Mode=OneWay}" Margin="0,0,5,0">
                                                    <ToggleButton.Style>
                                                        <Style TargetType="ToggleButton" BasedOn="{StaticResource IconToggleButton}">
                                                            <!-- Default state: Not paused, shows PAUSE icon -->
                                                            <Setter Property="Content" Value="&#xE769;"/>
                                                            <Setter Property="ToolTip" Value="{local:Translate Tab_PauseQueue}"/>
                                                            <Style.Triggers>
                                                                <!-- When checked: Paused, shows RESUME (Play) icon -->
                                                                <Trigger Property="IsChecked" Value="True">
                                                                    <Setter Property="Content" Value="&#xE768;"/>
                                                                    <Setter Property="ToolTip" Value="{local:Translate Tab_ResumeQueue}"/>
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </ToggleButton.Style>
                                                </ToggleButton>
                                                <Button Content="&#xE8BB;" 
                                                        Style="{StaticResource IconButton}"
                                                        Background="{StaticResource ErrorBrush}"
                                                        Command="{Binding InterruptCommand}"
                                                        ToolTip="{local:Translate Tab_InterruptGeneration}"/>
                                                <Button Content="&#xE71A;" 
                                                        Style="{StaticResource IconButton}"
                                                        Background="{StaticResource ErrorBrush}"
                                                        Command="{Binding ClearLocalQueueCommand}"
                                                        Margin="5,0,0,0"
                                                        ToolTip="{local:Translate Tab_ClearLocalQueue}"/>
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>
                                </Grid>
                            </Border>
                            <Grid>
                                <ListView x:Name="lvOutputs" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                          ItemsSource="{Binding ImageProcessing.FilteredImageOutputs}"
                                          Background="Transparent" BorderThickness="0"
                                          SelectionMode="Extended"
                                          SelectionChanged="LvOutputs_SelectionChanged"
                                          PreviewKeyDown="LvOutputs_PreviewKeyDown"
                                          KeyDown="LvOutputs_KeyDown"
                                          SelectedItem="{Binding ImageProcessing.SelectedGalleryImage, Mode=TwoWay}">
                                <ListView.ItemsPanel><ItemsPanelTemplate><WrapPanel Orientation="Horizontal" Margin="5"/></ItemsPanelTemplate></ListView.ItemsPanel>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Border x:Name="ItemBorder" CornerRadius="3" Margin="5" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="1"
                                                Width="{Binding ElementName=ThumbnailSizeSlider, Path=Value}"
                                                Height="{Binding ElementName=ThumbnailSizeSlider, Path=Value}">
                                            <Grid>
                                                <Border Background="Transparent"/>
                                                <Image x:Name="ImgDisplay" Source="{Binding Image}" Visibility="Visible" Stretch="Uniform" />
                                                <MediaElement x:Name="VidDisplay" Visibility="Collapsed"
                                                              LoadedBehavior="Manual" UnloadedBehavior="Stop" IsMuted="True"
                                                              Loaded="MediaElement_Loaded"
                                                              Unloaded="MediaElement_Unloaded"
                                                              MediaEnded="MediaElement_MediaEnded" Stretch="Uniform"/>
                                                <TextBlock x:Name="SavedIndicator" Text="💾" 
                                                           HorizontalAlignment="Left" VerticalAlignment="Top"
                                                           Margin="4" FontSize="16"
                                                           ToolTip="Saved"
                                                           Visibility="Collapsed">
                                                    <TextBlock.Effect>
                                                        <DropShadowEffect ShadowDepth="1" Color="Black" Opacity="0.7" BlurRadius="2"/>
                                                    </TextBlock.Effect>
                                                </TextBlock>
                                                <Border x:Name="NameOverlay" VerticalAlignment="Bottom" Background="#B22D2D30" Padding="5,2" CornerRadius="0,0,2,2" Opacity="0" IsHitTestVisible="False">
                                                    <Border.Style><Style TargetType="Border"><Style.Triggers><DataTrigger Binding="{Binding IsMouseOver, ElementName=ItemBorder}" Value="True"><DataTrigger.EnterActions><BeginStoryboard><Storyboard><DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.2"/></Storyboard></BeginStoryboard></DataTrigger.EnterActions><DataTrigger.ExitActions><BeginStoryboard><Storyboard><DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.3"/></Storyboard></BeginStoryboard></DataTrigger.ExitActions></DataTrigger></Style.Triggers></Style></Border.Style>
                                                    <TextBlock Text="{Binding FileName}" Foreground="White" TextTrimming="CharacterEllipsis"/>
                                                </Border>
                                                <Button x:Name="DeleteButton" Content="&#xE74D;" Style="{StaticResource IconButton}"
                                                        HorizontalAlignment="Right" VerticalAlignment="Top"
                                                        Width="24" Height="24" Margin="2"
                                                        ToolTip="{local:Translate Tab_DeleteFile}"
                                                        Command="{Binding DataContext.ImageProcessing.DeleteImageCommand, ElementName=lvOutputs}"
                                                        CommandParameter="{Binding}"
                                                        Visibility="Collapsed"/>
                                            </Grid>
                                        </Border>
                                        <DataTemplate.Triggers>
                                            <DataTrigger Binding="{Binding Type}" Value="Video"><Setter TargetName="VidDisplay" Property="Visibility" Value="Visible"/><Setter TargetName="ImgDisplay" Property="Visibility" Value="Collapsed"/></DataTrigger>
                                            <DataTrigger Binding="{Binding IsMouseOver, ElementName=ItemBorder}" Value="True"><Setter TargetName="DeleteButton" Property="Visibility" Value="Visible"/></DataTrigger>
                                            <DataTrigger Binding="{Binding IsSaved}" Value="True">
                                                <Setter TargetName="ItemBorder" Property="BorderBrush" Value="{StaticResource SuccessBrush}"/>
                                                <Setter TargetName="SavedIndicator" Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListViewItem}}" Value="True">
                                                <Setter TargetName="ItemBorder" Property="BorderBrush" Value="{StaticResource PrimaryAccentBrush}"/>
                                                <Setter TargetName="ItemBorder" Property="BorderThickness" Value="2"/>
                                            </DataTrigger>
                                        </DataTemplate.Triggers>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="{x:Type ListViewItem}">
                                        <Setter Property="Template"><Setter.Value><ControlTemplate TargetType="ListViewItem"><ContentPresenter/></ControlTemplate></Setter.Value></Setter>
                                        <EventSetter Event="MouseDoubleClick" Handler="ListViewItem_MouseDoubleClick"/>
                                        <EventSetter Event="PreviewMouseLeftButtonDown" Handler="ListViewItem_PreviewMouseLeftButtonDown"/>
                                        <EventSetter Event="MouseMove" Handler="ListViewItem_MouseMove"/>
                                        
                                        <Setter Property="Tag" Value="{Binding DataContext, ElementName=lvOutputs}"/>
                                        
                                        <Setter Property="ContextMenu">
                                            <Setter.Value>
                                                <ContextMenu Style="{StaticResource AppContextMenuStyle}">
                                                    <MenuItem Header="{local:Translate ContextMenu_BlockNode}"
                                                              Command="{Binding PlacementTarget.Tag.BlockNodeCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                              CommandParameter="{Binding}"/>
                                                </ContextMenu>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ListView.ItemContainerStyle>
                            </ListView>
                            
                            <Border Background="#DD3F3F46" CornerRadius="5" Padding="10"
                                HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,10"
                                Visibility="{Binding ImageProcessing.SelectedItemsCount, Converter={StaticResource CountToVisibilityConverter}}"> <!-- ИЗМЕНЕНО: Используем другой конвертер -->
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock VerticalAlignment="Center" Margin="0,0,10,0">
                                        <Run Text="{local:Translate Tab_SelectedItems}"/>
                                        <Run Text="{Binding ImageProcessing.SelectedItemsCount}"/>
                                    </TextBlock>
                                    
                                    <Button Content="{local:Translate SliderCompare_Compare}" Margin="0,0,5,0"
                                            Command="{Binding CompareSelectedImagesCommand}"
                                            CommandParameter="{Binding ElementName=lvOutputs, Path=SelectedItems}"/>
                                    <Button Content="{local:Translate Tab_SaveSelected}" Background="{StaticResource SuccessBrush}"
                                            Command="{Binding ImageProcessing.SaveSelectedImagesCommand}"
                                            CommandParameter="{Binding ElementName=lvOutputs, Path=SelectedItems}"/>
                                    <Button Content="{local:Translate Tab_DeleteSelected}" Background="{StaticResource ErrorBrush}"
                                            Command="{Binding ImageProcessing.DeleteSelectedImagesCommand}"
                                            CommandParameter="{Binding ElementName=lvOutputs, Path=SelectedItems}"
                                         Margin="5,0,0,0"/>
                                </StackPanel>
                            </Border>
                            <Button Content="&#xE74D;" Style="{StaticResource IconButton}" Command="{Binding ImageProcessing.ClearOutputsCommand}" Background="{StaticResource ErrorBrush}" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,10,10" ToolTip="{local:Translate Tab_ClearFilteredResults}"/>
                        </Grid>
                        </DockPanel>
                    </Border>
                </Grid>
                
                <GridSplitter Grid.Column="3"
                              Style="{StaticResource VerticalGridSplitterStyle}"
                              ResizeBehavior="PreviousAndNext"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Stretch"/>

                <Border Grid.Column="4" Background="{StaticResource SecondaryBackground}" CornerRadius="0,0,5,0" Margin="0,0,5,5">
                    <DockPanel>
                        <Border DockPanel.Dock="Top" Padding="8,5" Background="{StaticResource TertiaryBackground}">
                            <Grid>
                                <TextBlock Text="{local:Translate QueueManager_Title}" FontWeight="Bold" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                <Button Content="&#xE711;" Style="{StaticResource IconButton}" 
                                        Command="{Binding HideQueueManagerCommand}"
                                        Width="24" Height="24"
                                        ToolTip="{local:Translate Window_Close}"
                                        HorizontalAlignment="Right" VerticalAlignment="Center"/>
                            </Grid>
                        </Border>

                        <ListBox ItemsSource="{Binding PendingQueueItems}" SelectedItem="{Binding SelectedQueueItem}"
                                 Background="{StaticResource TertiaryBackground}" Margin="5" BorderThickness="0"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="AllowDrop" Value="True"/>
                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="QueueItem_PreviewMouseLeftButtonDown"/>
                                    <EventSetter Event="MouseMove" Handler="QueueItem_MouseMove"/>
                                    <EventSetter Event="Drop" Handler="QueueItem_Drop"/>
                                    <EventSetter Event="DragOver" Handler="QueueItem_DragOver"/>
                                    <EventSetter Event="DragLeave" Handler="QueueItem_DragLeave"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <ContentPresenter/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Effect">
                                                <Setter.Value>
                                                    <DropShadowEffect ShadowDepth="0" Color="{Binding Source={StaticResource PrimaryAccentBrush}, Path=Color}" BlurRadius="8" Opacity="0.8"/>
                                                </Setter.Value>
                                            </Setter>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ListBox.ItemContainerStyle>

                            <ListBox.ItemTemplate>
                                <DataTemplate DataType="{x:Type local:QueueItemViewModel}">
                                    <StackPanel>
                                        <Border x:Name="DropIndicatorBefore" Height="2" Background="{StaticResource PrimaryAccentBrush}" CornerRadius="1" Margin="0,1" Visibility="Collapsed" IsHitTestVisible="False"/>
                                        <Border Background="{StaticResource PrimaryBackground}" CornerRadius="3" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="1" Margin="0,2" Padding="8">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                
                                                <Grid Grid.Row="0">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <TextBlock Grid.Column="0" FontWeight="Bold" VerticalAlignment="Center">
                                                        <Run Text="{Binding DisplayIndex, StringFormat='{}{0}: '}"/>
                                                        <Run Text="{Binding WorkflowName, Mode=OneWay}"/>
                                                    </TextBlock>
                                                    
                                                    <Button Grid.Column="1" Content="&#xE74D;" Style="{StaticResource IconButton}" 
                                                            Width="20" Height="20"
                                                            ToolTip="{local:Translate QueueManager_DeleteItem}"
                                                            Command="{Binding DataContext.DeleteSelectedQueueItemCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                            CommandParameter="{Binding}"/>
                                                </Grid>

                                                <ItemsControl Grid.Row="1" ItemsSource="{Binding Details}" Margin="0,5,0,0">
                                                    <ItemsControl.Style>
                                                        <Style TargetType="ItemsControl">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Details.Count, Converter={StaticResource CountToBooleanConverter}}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </ItemsControl.Style>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="{x:Type local:QueueItemDetailViewModel}">
                                                            <TextBlock FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" TextTrimming="CharacterEllipsis">
                                                                <TextBlock.ToolTip>
                                                                    <ToolTip>
                                                                        <TextBlock Text="{Binding NewValue}" MaxWidth="500" TextWrapping="Wrap"/>
                                                                    </ToolTip>
                                                                </TextBlock.ToolTip>
                                                                <Run Text="{Binding DisplayName}" FontWeight="SemiBold"/>:
                                                                <Run Text="{Binding NewValue}" Foreground="#E6DB74"/>
                                                            </TextBlock>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </Grid>
                                        </Border>
                                        <Border x:Name="DropIndicatorAfter" Height="2" Background="{StaticResource PrimaryAccentBrush}" CornerRadius="1" Margin="0,1" Visibility="Collapsed" IsHitTestVisible="False"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </DockPanel>
                </Border>

                <Border Grid.Column="0" Grid.ColumnSpan="3" Background="{StaticResource PrimaryBackground}" Margin="5,0,5,5">
                     <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding OpenTabs.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <TextBlock Text="{local:Translate Tab_NoWorkflowSelected}" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}" FontSize="16"/>
                </Border>
            </Grid>
        </Grid>

        <GridSplitter Grid.Row="2"
                      Height="5"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Center" 
                      Background="{StaticResource TertiaryBackground}"
                      ResizeDirection="Rows"
                      ResizeBehavior="PreviousAndNext"
                      Visibility="{Binding IsConsoleVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        
        <Border Grid.Row="3" 
                Background="{StaticResource SecondaryBackground}"
                Margin="5,0,5,5"
                BorderBrush="{StaticResource TertiaryBackground}"
                BorderThickness="0,1,0,0"
                Visibility="{Binding IsConsoleVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <DockPanel>
                <Border DockPanel.Dock="Top" Padding="8,5" Background="{StaticResource TertiaryBackground}">
                    <Grid>
                        <TextBlock Text="{local:Translate Console_Title}" FontWeight="Bold" HorizontalAlignment="Left"/>
                        
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <RadioButton Content="{local:Translate Console_FilterAll}" GroupName="LogFilter" 
                                         IsChecked="{Binding SelectedLogFilterType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:LogFilterType.All}}"/>
                            <RadioButton Content="{local:Translate Console_FilterComfy}" GroupName="LogFilter" Margin="10,0,0,0"
                                         IsChecked="{Binding SelectedLogFilterType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:LogFilterType.Comfy}}"/>
                            <RadioButton Content="{local:Translate Console_FilterLocal}" GroupName="LogFilter" Margin="10,0,0,0"
                                         IsChecked="{Binding SelectedLogFilterType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:LogFilterType.Local}}"/>
                            <RadioButton Content="{local:Translate Console_FilterPython}" GroupName="LogFilter" Margin="10,0,0,0"
                                         IsChecked="{Binding SelectedLogFilterType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:LogFilterType.Python}}"/>
                        </StackPanel>
                        
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Button Content="&#xE8C8;" Style="{StaticResource IconButton}" 
                                    Command="{Binding CopyConsoleCommand}"
                                    Width="24" Height="24"
                                    ToolTip="{local:Translate Console_Copy}" 
                                    Margin="0,0,5,0"/>
            
                            <Button Content="&#xE74D;" Style="{StaticResource IconButton}" 
                                    Command="{Binding ClearConsoleCommand}"
                                    Width="24" Height="24"
                                    ToolTip="{local:Translate Console_Clear}"/>
                            
                            <Button Content="&#xE711;" Style="{StaticResource IconButton}" 
                                    Command="{Binding HideConsoleCommand}"
                                    Width="24" Height="24"
                                    ToolTip="{local:Translate Window_Close}"/>
                        </StackPanel>
                    </Grid>
                </Border>
                    
                <Grid x:Name="ConsoleContentGrid"
                      PreviewMouseLeftButtonDown="Console_PreviewMouseLeftButtonDown"
                      PreviewMouseMove="Console_PreviewMouseMove"
                      PreviewMouseLeftButtonUp="Console_PreviewMouseLeftButtonUp">
                    <Border Background="{StaticResource TertiaryBackground}" CornerRadius="3" Padding="15" Margin="10"
                            HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ConsoleLogMessages.Count}" Value="0">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock TextWrapping="Wrap" TextAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}" MaxWidth="500">
                            <Run Text="{local:Translate Console_Instructions}"/>
                        </TextBlock>
                    </Border>

                    <ScrollViewer x:Name="ConsoleScrollViewer" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <ScrollViewer.Style>
                            <Style TargetType="ScrollViewer">
                                <Setter Property="Visibility" Value="Visible" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ConsoleLogMessages.Count}" Value="0">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ScrollViewer.Style>
                        <ListBox x:Name="ConsoleListBox" ItemsSource="{Binding ConsoleLogMessages}" Background="Transparent" BorderThickness="0" Margin="5"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                 ScrollViewer.VerticalScrollBarVisibility="Disabled"
                                 PreviewMouseWheel="ConsoleListBox_PreviewMouseWheel">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <ContentPresenter/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=ListBox}}"/>
                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource AppContextMenuStyle}">
                                                <MenuItem Header="{local:Translate Console_CopyItem}"
                                                          Command="{Binding PlacementTarget.Tag.CopyConsoleItemCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding}"/>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate DataType="{x:Type local:LogMessage}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="{Binding Timestamp, StringFormat='HH:mm:ss'}" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,10,0" VerticalAlignment="Top"/>
                                        <TextBlock Grid.Column="1" local:TextBlockExtensions.BindableInlines="{Binding Segments}" TextWrapping="Wrap">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Level}" Value="Warning">
                                                            <Setter Property="Foreground" Value="Orange"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Level}" Value="Error">
                                                            <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Level}" Value="Critical">
                                                            <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                                            <Setter Property="FontWeight" Value="Bold"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Grid>
            </DockPanel>
        </Border>
        
        <Grid x:Name="FullScreenViewer" Grid.Row="0" Grid.RowSpan="4" Background="#D8000000"
              Focusable="True" PreviewKeyDown="FullScreenViewer_PreviewKeyDown"
              Visibility="{Binding FullScreen.IsFullScreenOpen, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"
              MouseLeftButtonDown="FullScreenViewer_MouseLeftButtonDown"
              IsVisibleChanged="FullScreenViewer_IsVisibleChanged"
              SizeChanged="FullScreenViewer_SizeChanged">
            <Grid.Resources>
                <Style x:Key="OverlayButton" TargetType="Button"><Setter Property="Background" Value="#80000000"/> <Setter Property="Foreground" Value="White"/> <Setter Property="BorderThickness" Value="0"/> <Setter Property="FontSize" Value="24"/> <Setter Property="FontWeight" Value="Bold"/> <Setter Property="Width" Value="50"/> <Setter Property="Height" Value="50"/> <Setter Property="Cursor" Value="Hand"/><Setter Property="Template"><Setter.Value><ControlTemplate TargetType="Button"><Border Background="{TemplateBinding Background}" CornerRadius="25"><ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/></Border></ControlTemplate></Setter.Value></Setter><Style.Triggers><Trigger Property="IsMouseOver" Value="True"><Setter Property="Background" Value="#A0000000"/></Trigger><Trigger Property="IsEnabled" Value="False"><Setter Property="Opacity" Value="0.3"/></Trigger></Style.Triggers></Style>
                <Style x:Key="ToolbarButton" TargetType="Button">
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="BorderThickness" Value="0"/>
                    <Setter Property="FontSize" Value="20"/>
                    <Setter Property="Margin" Value="10,0"/>
                    <Setter Property="Cursor" Value="Hand"/>
                    <Setter Property="Template"><Setter.Value><ControlTemplate TargetType="Button"><Border Background="{TemplateBinding Background}" CornerRadius="3"><ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/></Border></ControlTemplate></Setter.Value></Setter>
                    <Style.Triggers><Trigger Property="IsMouseOver" Value="True"><Setter Property="Background" Value="#A0000000"/></Trigger></Style.Triggers>
                </Style>
                <Style x:Key="FullScreenSaveButton" TargetType="Button">
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="BorderThickness" Value="0"/>
                    <Setter Property="FontSize" Value="24"/>
                    <Setter Property="Padding" Value="8"/>
                    <Setter Property="Cursor" Value="Hand"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="Button">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Opacity" Value="0.8"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Grid.Resources>
            <Viewbox><Image Source="{Binding FullScreen.CurrentFullScreenImage.Image}" Stretch="Uniform"><Image.Style><Style TargetType="Image"><Setter Property="Visibility" Value="Visible"/><Style.Triggers><DataTrigger Binding="{Binding FullScreen.CurrentFullScreenImage.Type}" Value="Video"><Setter Property="Visibility" Value="Collapsed"/></DataTrigger></Style.Triggers></Style></Image.Style></Image></Viewbox>
            <MediaElement x:Name="FullScreenMediaElement"
                          Stretch="Uniform" LoadedBehavior="Manual"
                          UnloadedBehavior="Stop" IsMuted="False"
                          DataContext="{Binding FullScreen.CurrentFullScreenImage}"
                          DataContextChanged="FullScreenMediaElement_DataContextChanged"
                          MediaOpened="FullScreenMediaElement_MediaOpened"
                          MediaEnded="FullScreenMediaElement_MediaEnded">
                <MediaElement.Style>
                    <Style TargetType="MediaElement">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers><DataTrigger Binding="{Binding Type}" Value="Video"><Setter Property="Visibility" Value="Visible"/></DataTrigger></Style.Triggers>
                    </Style>
                </MediaElement.Style>
            </MediaElement>
            <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="#A0000000" CornerRadius="10" Padding="20,10" IsHitTestVisible="False">
                <Border.Style><Style TargetType="Border"><Setter Property="Visibility" Value="Collapsed"/><Setter Property="Opacity" Value="0"/><Style.Triggers><DataTrigger Binding="{Binding FullScreen.ShowSaveConfirmation}" Value="True"><Setter Property="Visibility" Value="Visible"/><DataTrigger.EnterActions><BeginStoryboard><Storyboard><DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.3"/></Storyboard></BeginStoryboard></DataTrigger.EnterActions><DataTrigger.ExitActions><BeginStoryboard><Storyboard><DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.3"/></Storyboard></BeginStoryboard></DataTrigger.ExitActions></DataTrigger></Style.Triggers></Style></Border.Style>
                <TextBlock Text="{Binding FullScreen.SaveConfirmationText}" Foreground="White" FontSize="18"/>
            </Border>
                
            <Grid x:Name="ControlsOverlay">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Opacity" Value="1"/>
                        <Setter Property="IsHitTestVisible" Value="True"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsMouseOver, ElementName=SafeZone}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.3"/>
                                            <BooleanAnimationUsingKeyFrames Storyboard.TargetProperty="IsHitTestVisible">
                                                <DiscreteBooleanKeyFrame KeyTime="0:0:0.3" Value="False"/>
                                            </BooleanAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.2"/>
                                            <BooleanAnimationUsingKeyFrames Storyboard.TargetProperty="IsHitTestVisible">
                                                <DiscreteBooleanKeyFrame KeyTime="0:0:0" Value="True"/>
                                            </BooleanAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.ExitActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>
                
                <Border HorizontalAlignment="Left" VerticalAlignment="Top" Margin="20" Background="#A0000000" CornerRadius="5" Padding="8,4">
                    <TextBlock Text="{Binding FullScreen.CurrentFullScreenImage.Resolution}" Foreground="White" FontSize="14" />
                </Border>
                
                <Border HorizontalAlignment="Left" VerticalAlignment="Top" Margin="20" Background="#A0000000" CornerRadius="5" Padding="8,4">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding FullScreen.CurrentFullScreenImage.Resolution}" Foreground="White" FontSize="14" />
                        <TextBlock Foreground="White" FontSize="14" Margin="10,0,0,0">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} / {1}">
                                    <Binding Path="FullScreen.CurrentImageIndex"/>
                                    <Binding Path="FullScreen.TotalImages"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Border>
                
                <Button Content="✕" Style="{StaticResource OverlayButton}" Command="{Binding FullScreen.CloseFullScreenCommand}"
                        HorizontalAlignment="Right" VerticalAlignment="Top" Margin="20" Width="40" Height="40" FontSize="20"
                        ToolTip="{x:Static local:Hotkeys.CloseFullscreenTooltip}"/>
                        
                <Button Content="‹" Style="{StaticResource OverlayButton}" Command="{Binding FullScreen.MovePreviousCommand}"
                        HorizontalAlignment="Left" VerticalAlignment="Center" Margin="20,0"
                        ToolTip="{x:Static local:Hotkeys.MovePreviousTooltip}"/>
                        
                <Button Content="›" Style="{StaticResource OverlayButton}" Command="{Binding FullScreen.MoveNextCommand}"
                        HorizontalAlignment="Right" VerticalAlignment="Center" Margin="20,0"
                        ToolTip="{x:Static local:Hotkeys.MoveNextTooltip}"/>
                <Border VerticalAlignment="Bottom"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,20"
                        Background="#A0000000"
                        CornerRadius="10">
                    <StackPanel Orientation="Vertical">
                        <Grid Margin="10,5,10,0" MinWidth="400">
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding FullScreen.CurrentFullScreenImage.Type}" Value="{x:Static local:FileType.Video}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" Command="{Binding FullScreen.PlayPauseCommand}" Width="40" Height="40" FontSize="16" Margin="0,0,10,0">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource OverlayButton}">
                                        <Setter Property="Content" Value="▶"/> <!-- Play Icon -->
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding FullScreen.IsPlaying}" Value="True">
                                                <Setter Property="Content" Value="⏸"/> <!-- Pause Icon -->
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            
                            <TextBlock x:Name="CurrentTimeTextBlock" Grid.Column="1" Text="00:00" Margin="0,0,10,0" Foreground="White" VerticalAlignment="Center"/>
                            
                            <Slider x:Name="PositionSlider" Grid.Column="2" VerticalAlignment="Center"
                                    Style="{StaticResource VideoSliderStyle}"
                                    ValueChanged="PositionSlider_ValueChanged"
                                    MouseMove="PositionSlider_MouseMove"
                                    PreviewMouseLeftButtonUp="PositionSlider_PreviewMouseLeftButtonUp"
                                    Thumb.DragStarted="PositionSlider_DragStarted"
                                    Thumb.DragCompleted="PositionSlider_DragCompleted"/>

                            <TextBlock x:Name="DurationTextBlock" Grid.Column="3" Text="00:00" Margin="10,0,0,0" Foreground="White" VerticalAlignment="Center"/>
                        </Grid>
                        <Button Content="💾"
                                ToolTip="{x:Static local:Hotkeys.SaveImageTooltip}"
                                Style="{StaticResource FullScreenSaveButton}"
                                Command="{Binding FullScreen.SaveCurrentImageCommand}"
                                HorizontalAlignment="Center"
                                Margin="5"/>
                    </StackPanel>
                </Border>
            </Grid>
            <Border x:Name="SafeZone" Background="Transparent" Margin="120, 80, 120, 100"/>
        </Grid>
        
        <local:SliderCompareView DataContext="{Binding SliderCompare}" Grid.Row="0" Grid.RowSpan="4" Panel.ZIndex="99"/>
        
        <Popup x:Name="GroupNavigationPopup"
               IsOpen="{Binding IsGroupNavigationPopupOpen}"
               StaysOpen="False"
               Placement="Center"
               AllowsTransparency="True">
            <Border Background="{StaticResource SecondaryBackground}"
                    BorderBrush="{StaticResource PrimaryAccentBrush}"
                    BorderThickness="1"
                    CornerRadius="5"
                    MinWidth="250"
                    MaxHeight="400">
                <DockPanel Margin="5">
                    <TextBlock DockPanel.Dock="Top" Text="{local:Translate GroupNavigation_Title}" FontWeight="Bold" Margin="5"/>
                    <ListBox ItemsSource="{Binding AllGroupsInSelectedTab}"
                             Background="Transparent"
                             BorderThickness="0"
                             ScrollViewer.VerticalScrollBarVisibility="Auto">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="8,5"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="ItemBorder" Background="Transparent" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="ItemBorder" Property="Background" Value="{StaticResource TertiaryBackground}"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <EventSetter Event="PreviewMouseLeftButtonUp" Handler="GroupNavigationListBoxItem_Click" />
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Name}"/>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>
    </Popup>
            
    </Grid>
</Window>