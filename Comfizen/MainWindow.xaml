<Window x:Class="Comfizen.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
        xmlns:local="clr-namespace:Comfizen"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="Comfizen v1.3" Height="600" Width="1000"
        WindowStartupLocation="CenterScreen"
        MinWidth="800" MinHeight="500"
        Foreground="{StaticResource TextBrush}"
        Style="{StaticResource CustomWindowStyle}"
        KeyDown="MainWindow_OnKeyDown"
        AllowDrop="True"
        DragOver="Window_DragOver"
        Drop="Window_Drop">
    <Window.DataContext>
        <local:MainViewModel />
    </Window.DataContext>
    <Window.Resources>
        <DataTemplate x:Key="WorkflowItemTemplate" DataType="{x:Type sys:String}">
            <TextBlock Text="{Binding Converter={StaticResource FileNameTrimmerConverter}}" Padding="5,3" />
        </DataTemplate>

        <DataTemplate x:Key="WorkflowHeaderTemplate" DataType="{x:Type local:WorkflowListHeader}">
            <TextBlock Text="{Binding Title}" FontWeight="Bold" Margin="2,5,2,2"
                       Foreground="{StaticResource TextSecondaryBrush}" />
        </DataTemplate>

        <local:WorkflowTemplateSelector x:Key="WorkflowTemplateSelector"
                                        WorkflowTemplate="{StaticResource WorkflowItemTemplate}"
                                        HeaderTemplate="{StaticResource WorkflowHeaderTemplate}" />

    </Window.Resources>

    <Grid>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition x:Name="ConsoleRow" Height="200">
                <RowDefinition.Style>
                    <Style TargetType="RowDefinition">
                        <Setter Property="MaxHeight" Value="0" />
                        <Setter Property="MinHeight" Value="0" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsConsoleVisible}" Value="True">
                                <Setter Property="MaxHeight" Value="10000" />
                                <Setter Property="MinHeight" Value="40" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </RowDefinition.Style>
            </RowDefinition>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="{StaticResource SecondaryBackground}" Margin="5,5,5,0" CornerRadius="5,5,0,0">
            <DockPanel Margin="8">
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="10,0,0,0">
                    <Button Content="&#xE70F;" Style="{StaticResource IconButton}"
                            Command="{Binding EditWorkflowCommand}" ToolTip="{local:Translate Toolbar_EditWorkflow}" />
                    <Button Content="&#xE710;" Style="{StaticResource IconButton}"
                            Command="{Binding OpenConstructorCommand}" Margin="5,0,0,0"
                            ToolTip="{local:Translate Toolbar_NewWorkflow}" />
                    <Button Content="&#xE72C;" Style="{StaticResource IconButton}"
                            Command="{Binding RefreshModelsCommand}" Margin="5,0,0,0"
                            ToolTip="{local:Translate Toolbar_RefreshModels}" />
                    <Button Content="&#xE75F;" Style="{StaticResource IconButton}"
                            Command="{Binding ToggleConsoleCommand}" Margin="5,0,0,0"
                            ToolTip="{local:Translate Toolbar_ToggleConsole}" />
                    <Button Content="&#xE713;" Style="{StaticResource IconButton}"
                            Command="{Binding OpenSettingsCommand}" Margin="5,0,0,0"
                            ToolTip="{local:Translate Toolbar_Settings}" />
                    <Button Content="&#xE897;" Style="{StaticResource IconButton}" Command="{Binding OpenHelpCommand}"
                            Margin="5,0,0,0" ToolTip="{local:Translate Toolbar_Help}" />
                </StackPanel>

                <local:FilterableComboBox
                    ItemsSource="{Binding WorkflowDisplayList}"
                    SelectedItem="{Binding SelectedWorkflow, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource FileNameTrimmerConverter}}"
                    SearchFilter="{Binding WorkflowSearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    ItemSelected="FilterableComboBox_ItemSelected"
                    PlaceholderText="{local:Translate FilterableComboBox_Placeholder}"
                    ItemTemplateSelector="{StaticResource WorkflowTemplateSelector}"
                    ShowCycleButtons="False" />
            </DockPanel>
        </Border>

        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <TabControl Grid.Row="0" ItemsSource="{Binding OpenTabs}" SelectedItem="{Binding SelectedTab, Mode=TwoWay}"
                        Margin="5,0,5,0" Background="Transparent" BorderThickness="0">
                <TabControl.ContentTemplate>
                    <DataTemplate />
                </TabControl.ContentTemplate>
                <TabControl.Style>
                    <Style TargetType="TabControl">
                        <Setter Property="Visibility" Value="Visible" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding OpenTabs.Count}" Value="0">
                                <Setter Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TabControl.Style>
                <TabControl.ItemContainerStyle>
                    <Style TargetType="TabItem">
                        <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}" />
                        <Setter Property="Background" Value="{StaticResource SecondaryBackground}" />
                        <Setter Property="Padding" Value="8,5" />
                        <Setter Property="AllowDrop" Value="True" />
                        <EventSetter Event="DragOver" Handler="TabItem_DragOver" />
                        <EventSetter Event="DragEnter" Handler="TabItem_DragEnter" />
                        <EventSetter Event="PreviewMouseLeftButtonDown" Handler="TabItem_PreviewMouseLeftButtonDown" />
                        <EventSetter Event="Drop" Handler="TabItem_Drop" />
                        <EventSetter Event="MouseMove" Handler="TabItem_MouseMove" />
                        <EventSetter Event="PreviewMouseUp" Handler="TabItem_PreviewMouseUp" />

                        <Setter Property="Tag"
                                Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=TabControl}}" />


                        <Setter Property="ContextMenu">
                            <Setter.Value>
                                <ContextMenu Style="{StaticResource AppContextMenuStyle}">
                                    <MenuItem Header="{local:Translate ContextMenu_RenameWorkflow}"
                                              Command="{Binding PlacementTarget.Tag.RenameWorkflowCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}" />
                                    <MenuItem Header="{local:Translate ContextMenu_DeleteWorkflow}"
                                              Command="{Binding PlacementTarget.Tag.DeleteWorkflowCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}" />
                                    <Separator />
                                    <MenuItem Header="{local:Translate ContextMenu_SaveChanges}"
                                              Command="{Binding PlacementTarget.Tag.SaveChangesToWorkflowCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}" />
                                    <MenuItem Header="{local:Translate ContextMenu_ExportState}"
                                              Command="{Binding PlacementTarget.Tag.ExportCurrentStateCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}" />
                                    <Separator />
                                    <MenuItem Header="{local:Translate ContextMenu_ResetSession}"
                                              Command="{Binding PlacementTarget.Tag.ClearSessionCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}" />
                                    <MenuItem Header="{local:Translate ContextMenu_ClearBlockedNodes}"
                                              Command="{Binding PlacementTarget.Tag.ClearBlockedNodesCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}" />
                                    <Separator />
                                    <MenuItem Header="{local:Translate ContextMenu_CopyMarkdownLink}"
                                              Command="{Binding PlacementTarget.Tag.CopyWorkflowLinkCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}" />
                                </ContextMenu>
                            </Setter.Value>
                        </Setter>

                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TabItem">
                                    <Border x:Name="Border" BorderThickness="0,0,0,2" BorderBrush="Transparent"
                                            Background="{TemplateBinding Background}" Margin="0,0,2,0">
                                        <ContentPresenter ContentSource="Header" HorizontalAlignment="Center"
                                                          VerticalAlignment="Center" />
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource TextBrush}" />
                                            <Setter TargetName="Border" Property="BorderBrush"
                                                    Value="{StaticResource PrimaryAccentBrush}" />
                                            <Setter Property="Background" Value="{StaticResource PrimaryBackground}" />
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource TextBrush}" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TabControl.ItemContainerStyle>
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <Grid ToolTip="{Binding RelativePathTooltip}">
                            <StackPanel Orientation="Horizontal"
                                        Visibility="{Binding IsRenaming, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=invert}">
                                <TextBlock Text="{Binding Header}" VerticalAlignment="Center" />
                                <Button Content="&#xE711;"
                                        Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                                        CommandParameter="{Binding}"
                                        Style="{StaticResource IconButton}" Width="20" Height="20" Margin="8,0,0,0" />
                            </StackPanel>
                            <TextBox Text="{Binding EditableHeader, UpdateSourceTrigger=Explicit}"
                                     Visibility="{Binding IsRenaming, Converter={StaticResource BooleanToVisibilityConverter}}"
                                     MinWidth="100"
                                     KeyDown="RenameTextBox_KeyDown"
                                     LostFocus="RenameTextBox_LostFocus">
                                <TextBox.Style>
                                    <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                                        <Style.Triggers>
                                            <Trigger Property="IsVisible" Value="True">
                                                <Setter Property="FocusManager.FocusedElement"
                                                        Value="{Binding RelativeSource={RelativeSource Self}}" />
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBox.Style>
                            </TextBox>
                        </Grid>
                    </DataTemplate>
                </TabControl.ItemTemplate>
            </TabControl>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1.2*" MinWidth="350" />
                    <ColumnDefinition Width="5" />
                    <ColumnDefinition Width="2*" MinWidth="400" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="1*" MinWidth="300" />
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Background="{StaticResource SecondaryBackground}" CornerRadius="0,0,0,5"
                        Margin="5,0,0,5">
                    <DockPanel Visibility="{Binding SelectedTab, Converter={StaticResource StringToIsNotNullOrEmptyConverter}}">
                        <DockPanel.Resources>
                            <DataTemplate DataType="{x:Type local:GlobalControlsViewModel}">
                                <Expander Header="{Binding Header}" IsExpanded="{Binding IsExpanded, Mode=TwoWay}"
                                          BorderBrush="Orange" Margin="5"
                                          Visibility="{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <StackPanel Margin="5">
                                        <!-- Seed Controls -->
                                        <Grid
                                            Visibility="{Binding IsSeedSectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,10,0"
                                                        VerticalAlignment="Center">
                                                <TextBlock Text="{local:Translate Tab_WildcardSeed}" />
                                                <TextBlock Text="💡" VerticalAlignment="Center" Margin="5,0,0,0"
                                                           Foreground="{StaticResource TextSecondaryBrush}" />
                                            </StackPanel>
                                            <Grid Grid.Column="1">
                                                <TextBox
                                                    Text="{Binding WildcardSeed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                    Padding="5,5,28,5" />
                                                <ToggleButton IsChecked="{Binding IsSeedLocked, Mode=TwoWay}"
                                                              Style="{StaticResource LockToggleButtonStyle}"
                                                              HorizontalAlignment="Right"
                                                              VerticalAlignment="Center" Margin="0,0,4,0" />
                                            </Grid>
                                        </Grid>
                                        <!-- Preset Controls -->
                                        <Grid Visibility="{Binding IsPresetsSectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                                              Margin="0,5,0,0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{local:Translate GlobalPresets_Label}" VerticalAlignment="Center" Margin="0,0,10,0" />
                                            
                                            <local:FilterableComboBox Grid.Column="1"
                                                                      ItemsSource="{Binding GlobalPresets}"
                                                                      SelectedItem="{Binding SelectedGlobalPreset, Mode=TwoWay}"
                                                                      PlaceholderText="{local:Translate Presets_LoadPlaceholder}">
                                                <local:FilterableComboBox.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type local:GlobalPreset}">
                                                        <TextBlock Text="{Binding Name}" Padding="2" />
                                                    </DataTemplate>
                                                </local:FilterableComboBox.ItemTemplate>
                                                <local:FilterableComboBox.Style>
                                                    <Style TargetType="local:FilterableComboBox">
                                                        <Setter Property="IsEnabled" Value="True" />
                                                        <Style.Triggers>
                                                            <DataTrigger
                                                                Binding="{Binding GlobalPresets.Count}"
                                                                Value="0">
                                                                <Setter Property="IsEnabled" Value="False" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </local:FilterableComboBox.Style>
                                            </local:FilterableComboBox>

                                            <Button Grid.Column="2" Content="&#xE713;" Style="{StaticResource IconButton}"
                                                    Command="{Binding OpenGlobalPresetEditorCommand}"
                                                    Width="24" Height="24" Margin="5,0,0,0"
                                                    ToolTip="{local:Translate Presets_ManageTooltip}"/>
                                        </Grid>

                                        <Border Margin="0,5,0,0" Padding="0,5,0,0" BorderThickness="0,1,0,0"
                                                BorderBrush="{StaticResource TertiaryBackground}"
                                                Visibility="{Binding IsHooksSectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <ItemsControl ItemsSource="{Binding ImplementedHooks}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal" />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type local:HookToggleViewModel}">
                                                        <CheckBox IsChecked="{Binding IsEnabled, Mode=TwoWay}"
                                                                  Margin="0,0,15,5"
                                                                  VerticalContentAlignment="Center">
                                                            <TextBlock Text="{Binding HookName}" />
                                                        </CheckBox>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Border>
                                    </StackPanel>
                                </Expander>
                            </DataTemplate>
                        </DockPanel.Resources>
                        <ContentControl DockPanel.Dock="Top" Content="{Binding SelectedTab.WorkflowInputsController.GlobalControls}" />

                        <!-- НАЧАЛО ИЗМЕНЕНИЯ: Всплывающее окно редактора -->
                        <Popup IsOpen="{Binding SelectedTab.WorkflowInputsController.IsGlobalPresetEditorOpen, Mode=TwoWay}"
                               StaysOpen="False"
                               Placement="Center"
                               AllowsTransparency="True">
                            <Border Background="{StaticResource SecondaryBackground}"
                                    BorderBrush="{StaticResource PrimaryAccentBrush}"
                                    BorderThickness="1"
                                    CornerRadius="5"
                                    MinWidth="600"
                                    MinHeight="400"
                                    MaxHeight="700"
                                    DataContext="{Binding SelectedTab.WorkflowInputsController.GlobalPresetEditor}">
                                <Grid Margin="10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="1*" MinWidth="180"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="2*" MinWidth="350"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Left Panel: List of Presets -->
                                    <DockPanel Grid.Column="0">
                                        <Button DockPanel.Dock="Top" Content="{local:Translate Presets_CreateNewGlobal}" Command="{Binding AddNewCommand}" Margin="0,0,0,10"/>
                                        <ListBox ItemsSource="{Binding GlobalPresets}"
                                                 SelectedItem="{Binding SelectedPreset, Mode=TwoWay}"
                                                 Background="{StaticResource PrimaryBackground}"
                                                 BorderThickness="0">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate DataType="{x:Type local:GlobalPreset}">
                                                    <TextBlock Text="{Binding Name}" Padding="5"/>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </DockPanel>

                                    <GridSplitter Grid.Column="1" Style="{StaticResource VerticalGridSplitterStyle}" ResizeBehavior="PreviousAndNext"/>

                                    <!-- Right Panel: Editor -->
                                    <DockPanel Grid.Column="2">
                                        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                                            <Button Content="{local:Translate UIConstructor_Delete}" Command="{Binding DeleteCommand}" Background="{StaticResource ErrorBrush}" MinWidth="80"/>
                                            <Button Content="{local:Translate UIConstructor_Save}" Command="{Binding SaveCommand}" IsDefault="True" MinWidth="100" Margin="10,0,0,0"/>
                                        </StackPanel>

                                        <StackPanel>
                                            <TextBlock Text="Preset Name" Foreground="{StaticResource TextSecondaryBrush}"/>
                                            <TextBox Text="{Binding EditingPresetName, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,15"/>
                                            
                                            <TextBlock Text="Group Layers" FontWeight="Bold" Margin="0,0,0,5"/>
                                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                                <ItemsControl ItemsSource="{Binding GroupStates}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="{x:Type local:GroupStateViewModel}">
                                                            <Grid Margin="0,4">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="150"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                </Grid.ColumnDefinitions>
                                                                <TextBlock Grid.Column="0" Text="{Binding GroupName}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                                                                <ComboBox Grid.Column="1" 
                                                                          ItemsSource="{Binding AvailablePresets}"
                                                                          SelectedItem="{Binding SelectedPreset, Mode=TwoWay}"
                                                                          DisplayMemberPath="Name"/>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </ScrollViewer>
                                        </StackPanel>
                                    </DockPanel>
                                </Grid>
                            </Border>
                        </Popup>

                        <TabControl x:Name="WorkflowTabsControl"
                                    ItemsSource="{Binding SelectedTab.WorkflowInputsController.TabLayoouts}"
                                    SelectedItem="{Binding SelectedTab.WorkflowInputsController.SelectedTabLayout, Mode=TwoWay}"
                                    Margin="5,0,5,5"
                                    Style="{StaticResource WorkflowTabControlStyle}"
                                    ItemContainerStyle="{StaticResource WorkflowTabItemStyle}">
                            <TabControl.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Header}" />
                                </DataTemplate>
                            </TabControl.ItemTemplate>
                            <TabControl.ContentTemplate>
                                <DataTemplate>
                                    <ScrollViewer x:Name="ControlsScrollViewer" VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Disabled"
                                                  PreviewMouseWheel="ControlsScrollViewer_PreviewMouseWheel">
                                        <ItemsControl ItemsSource="{Binding Groups}" Margin="0,5,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type local:WorkflowGroupViewModel}">
                                                    <ContentControl>
                                                        <ContentControl.Style>
                                                            <Style TargetType="ContentControl">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Style.Triggers>
                                                                    <!-- ADD: This trigger hides the group from the main list when it's undocked -->
                                                                    <DataTrigger Binding="{Binding IsUndocked}"
                                                                        Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </ContentControl.Style>

                                                        <Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}"
                                                                  Margin="5">
                                                        <Expander.Header>
                                                            <TextBlock Text="{Binding Name}" FontWeight="Bold" />
                                                        </Expander.Header>
                                                        <Expander.Template>
                                                <ControlTemplate TargetType="Expander">
                                                                    <Border BorderBrush="{TemplateBinding BorderBrush}"
                                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                                            CornerRadius="3" Background="Transparent">
                                                        <DockPanel>
                                                                            <ToggleButton DockPanel.Dock="Top"
                                                                                IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                                                                OverridesDefaultStyle="True"
                                                                                Content="{TemplateBinding Header}"
                                                                                ContentTemplate="{TemplateBinding HeaderTemplate}">
                                                                <ToggleButton.Template>
                                                                                    <ControlTemplate
                                                                                        TargetType="ToggleButton">
                                                                        <Grid>
                                                                                            <Border
                                                                                                Background="{StaticResource TertiaryBackground}"
                                                                                                CornerRadius="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=Expander}, Converter={StaticResource ExpanderCornerRadiusConverter}}" />
                                                                                            <Border
                                                                                                CornerRadius="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=Expander}, Converter={StaticResource ExpanderCornerRadiusConverter}}"
                                                                                                Background="{Binding DataContext.HighlightColor, RelativeSource={RelativeSource AncestorType=Expander}, Converter={StaticResource HexToBrushConverter}}">
                                                                                <Border.Style>
                                                                                                    <Style
                                                                                                        TargetType="Border">
                                                                                                        <Setter
                                                                                                            Property="Opacity"
                                                                                                            Value="0.2" />
                                                                                        <Style.Triggers>
                                                                                                            <DataTrigger
                                                                                                                Binding="{Binding DataContext.HighlightColor, RelativeSource={RelativeSource AncestorType=Expander}}"
                                                                                                                Value="{x:Null}">
                                                                                                                <Setter
                                                                                                                    Property="Opacity"
                                                                                                                    Value="0" />
                                                                                            </DataTrigger>
                                                                                        </Style.Triggers>
                                                                                    </Style>
                                                                                </Border.Style>
                                                                            </Border>
                                                                            <Border Padding="8">
                                                                                <Grid>
                                                                                    <Grid.ColumnDefinitions>
                                                                                                        <ColumnDefinition
                                                                                                            Width="Auto" />
                                                                                                        <ColumnDefinition
                                                                                                            Width="*" />
                                                                                                        <ColumnDefinition
                                                                                                            Width="Auto" />
                                                                                    </Grid.ColumnDefinitions>

                                                                                                    <StackPanel
                                                                                                        Grid.Column="0"
                                                                                                        Orientation="Horizontal">
                                                                                                        <TextBlock
                                                                                                            x:Name="Arrow"
                                                                                                            Text="▶"
                                                                                                            VerticalAlignment="Center"
                                                                                                            Margin="0,0,5,0" />
                                                                                                        <ContentPresenter
                                                                                                            SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                                                                                            RecognizesAccessKey="True" />
                                                                                    </StackPanel>

                                                                                                    <StackPanel
                                                                                                        Grid.Column="2"
                                                                                                        Orientation="Horizontal"
                                                                                                        HorizontalAlignment="Right"
                                                                                        Visibility="{Binding Fields.Count, Converter={StaticResource TaskCountToVisibilityConverter}}">

                                                                                                        <ContentPresenter
                                                                                                            Content="{Binding}"
                                                                                            ContentTemplate="{StaticResource GroupHeaderPresetControls}"
                                                                                                            VerticalAlignment="Center" />
                                                                                                        
                                                                                                        <Grid>
                                                                                                            <ToggleButton x:Name="MoreOptionsButton"
                                                                                                                Style="{StaticResource IconToggleButton}"
                                                                                                                Content="&#xE712;"
                                                                                                                Width="24" Height="24" Margin="5,0,0,0"
                                                                                                                ToolTip="{local:Translate ContextMenu_MoreOptions}"/>
                                                                                                            
                                                                                                            <Popup IsOpen="{Binding IsChecked, ElementName=MoreOptionsButton, Mode=TwoWay}"
                                                                                                                PlacementTarget="{Binding ElementName=MoreOptionsButton}"
                                                                                                                Placement="Bottom"
                                                                                                                StaysOpen="False"
                                                                                                                AllowsTransparency="True">
                                                                                                                
                                                                                                                <Border DataContext="{Binding DataContext, ElementName=MoreOptionsButton}"
                                                                                                                    Background="{StaticResource SecondaryBackground}"
                                                                                                                    BorderBrush="{StaticResource TertiaryBackground}"
                                                                                                                    BorderThickness="1"
                                                                                                                    CornerRadius="3"
                                                                                                                    Margin="0,2,0,0">
                                                                                                                    
                                                                                                                    <StackPanel>
                                                                                                                        <MenuItem Header="{local:Translate ContextMenu_ExportPresets}"
                                                                                                                            Command="{Binding ExportPresetsCommand}" />
                                                                                                                        <MenuItem Header="{local:Translate ContextMenu_ImportPresets}"
                                                                                                                            Command="{Binding ImportPresetsCommand}" />
                                                                                                                    </StackPanel>
                                                                                                                </Border>
                                                                                                            </Popup>
                                                                                                        </Grid>
                                                                                                        
                                                                                                        <Button
                                                                                                            Content="&#xE8A7;"
                                                                                                            Style="{StaticResource IconButton}"
                                                                                                            Width="24"
                                                                                                            Height="24"
                                                                                            Command="{Binding DataContext.ToggleUndockGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                            CommandParameter="{Binding}"
                                                                                            ToolTip="Undock Group"
                                                                                                            Margin="5,0,0,0" />

                                                                                    </StackPanel>
                                                                                </Grid>
                                                                            </Border>
                                                                        </Grid>
                                                                        <ControlTemplate.Triggers>
                                                                                            <Trigger
                                                                                                Property="IsChecked"
                                                                                                Value="True">
                                                                                                <Setter
                                                                                                    TargetName="Arrow"
                                                                                                    Property="Text"
                                                                                                    Value="▼" />
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </ToggleButton.Template>
                                                            </ToggleButton>

                                                                            <Grid x:Name="ContentSite"
                                                                                DockPanel.Dock="Bottom"
                                                                                Visibility="Collapsed">
                                                                                <Border Opacity="0.2"
                                                                                    Background="{Binding DataContext.HighlightColor, RelativeSource={RelativeSource AncestorType=Expander}, Converter={StaticResource HexToBrushConverter}}" />
                                                                                <ContentPresenter
                                                                                    ContentSource="Content" Margin="8" />
                                                            </Grid>
                                                        </DockPanel>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsExpanded" Value="True">
                                                                            <Setter TargetName="ContentSite"
                                                                                Property="Visibility" Value="Visible" />
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Expander.Template>
                                                <ContentControl Content="{Binding}">
                                                                <ContentControl.Resources>
                                                                    <DataTemplate x:Key="SingleTabViewTemplate">
                                                                        <ItemsControl
                                                                            ItemsSource="{Binding Tabs[0].Fields}"
                                                                            ItemTemplate="{StaticResource FieldDataTemplate}" />
                                                                    </DataTemplate>

                                                                    <DataTemplate x:Key="MultiTabViewTemplate">
                                                                        <TabControl ItemsSource="{Binding Tabs}"
                                                                            SelectedItem="{Binding SelectedTab, Mode=TwoWay}"
                                                                            ItemContainerStyle="{StaticResource GroupInternalTabItemStyle}"
                                                                            Style="{StaticResource GroupInternalTabControlStyle}">
                                                                            <TabControl.ItemTemplate>
                                                                                <DataTemplate
                                                                                    DataType="{x:Type local:WorkflowGroupTabViewModel}">
                                                                                    <!-- The Tab Header is now just the text, clean and simple -->
                                                                                    <TextBlock Text="{Binding Name}"
                                                                                        HorizontalAlignment="Center"
                                                                                        Margin="0,0,0,2" />
                                                                                </DataTemplate>
                                                                            </TabControl.ItemTemplate>
                                                                            <TabControl.ContentTemplate>
                                                                                <DataTemplate
                                                                                    DataType="{x:Type local:WorkflowGroupTabViewModel}">
                                                                                    <ItemsControl
                                                                                        ItemsSource="{Binding Fields}"
                                                                                        ItemTemplate="{StaticResource FieldDataTemplate}" />
                                                                                </DataTemplate>
                                                                            </TabControl.ContentTemplate>
                                                                        </TabControl>
                                                                    </DataTemplate>
                                                                </ContentControl.Resources>
                                                                <ContentControl.Style>
                                                                    <Style TargetType="ContentControl">
                                                                        <Setter Property="ContentTemplate"
                                                                            Value="{StaticResource SingleTabViewTemplate}" />
                                                                        <Style.Triggers>
                                                                            <DataTrigger
                                                                                Binding="{Binding Tabs.Count, Converter={StaticResource IsGreaterThanConverter}, ConverterParameter=1}"
                                                                                Value="True">
                                                                                <Setter Property="ContentTemplate"
                                                                                    Value="{StaticResource MultiTabViewTemplate}" />
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </ContentControl.Style>
                                                            </ContentControl>
                                                        </Expander>
                                                        </ContentControl>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </DataTemplate>
                            </TabControl.ContentTemplate>
                        </TabControl>
                    </DockPanel>
                </Border>

                <GridSplitter Grid.Column="1"
                              Style="{StaticResource VerticalGridSplitterStyle}"
                              ResizeBehavior="PreviousAndNext"
                              HorizontalAlignment="Center" />

                <Grid Grid.Column="2">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsQueueManagerVisible}" Value="False">
                                    <Setter Property="Grid.ColumnSpan" Value="3" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>

                    <Border Background="{StaticResource SecondaryBackground}" CornerRadius="0,0,5,0" Margin="0,0,5,5">
                        <DockPanel>
                            <Border DockPanel.Dock="Top" Padding="8" BorderBrush="{StaticResource TertiaryBackground}"
                                    BorderThickness="0,0,0,1">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <TextBox Grid.Column="0"
                                             Text="{Binding ImageProcessing.SearchFilterText, UpdateSourceTrigger=PropertyChanged}"
                                             Width="120" HorizontalAlignment="Left" VerticalAlignment="Center"
                                             ToolTip="{local:Translate Tab_GallerySearchPlaceholder}" />

                                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center"
                                                VerticalAlignment="Center">

                                        <!-- Type Filter -->
                                        <TextBlock Text="{local:Translate Tab_GalleryFilterType}" Margin="0,0,5,0"
                                                   VerticalAlignment="Center" />
                                        <Border BorderBrush="{StaticResource TertiaryBackground}"
                                                BorderThickness="0,0,1,0">
                                            <StackPanel Orientation="Horizontal">
                                                <RadioButton Tag="First"
                                                             Style="{StaticResource SegmentedRadioButtonStyle}"
                                                             GroupName="FileType"
                                                             Content="{local:Translate Tab_GalleryFilterAll}"
                                                             IsChecked="{Binding ImageProcessing.SelectedFileTypeFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:FileTypeFilter.All}}" />
                                                <RadioButton Tag="Middle"
                                                             Style="{StaticResource SegmentedRadioButtonStyle}"
                                                             GroupName="FileType"
                                                             Content="{local:Translate Tab_GalleryFilterImages}"
                                                             IsChecked="{Binding ImageProcessing.SelectedFileTypeFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:FileTypeFilter.Images}}" />
                                                <RadioButton Tag="Last"
                                                             Style="{StaticResource SegmentedRadioButtonStyle}"
                                                             GroupName="FileType"
                                                             Content="{local:Translate Tab_GalleryFilterVideo}"
                                                             IsChecked="{Binding ImageProcessing.SelectedFileTypeFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:FileTypeFilter.Video}}" />
                                            </StackPanel>
                                        </Border>

                                        <!-- Saved Status Filter -->
                                        <TextBlock Text="{local:Translate Tab_GalleryFilterSavedStatus}"
                                                   Margin="15,0,5,0" VerticalAlignment="Center" />
                                        <Border BorderBrush="{StaticResource TertiaryBackground}"
                                                BorderThickness="0,0,1,0">
                                            <StackPanel Orientation="Horizontal">
                                                <RadioButton Tag="First"
                                                             Style="{StaticResource SegmentedRadioButtonStyle}"
                                                             GroupName="SavedStatus"
                                                             Content="{local:Translate Tab_GalleryFilterAll}"
                                                             IsChecked="{Binding ImageProcessing.SelectedSavedStatusFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:SavedStatusFilter.All}}" />
                                                <RadioButton Tag="Middle"
                                                             Style="{StaticResource SegmentedRadioButtonStyle}"
                                                             GroupName="SavedStatus"
                                                             Content="{local:Translate Tab_GalleryFilterSaved}"
                                                             IsChecked="{Binding ImageProcessing.SelectedSavedStatusFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:SavedStatusFilter.Saved}}" />
                                                <RadioButton Tag="Last"
                                                             Style="{StaticResource SegmentedRadioButtonStyle}"
                                                             GroupName="SavedStatus"
                                                             Content="{local:Translate Tab_GalleryFilterUnsaved}"
                                                             IsChecked="{Binding ImageProcessing.SelectedSavedStatusFilter, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:SavedStatusFilter.Unsaved}}" />
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center"
                                                    Margin="0,0,15,0"
                                                    Visibility="{Binding ImageProcessing.IsSimilaritySortActive, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <TextBlock Text="{local:Translate Tab_GallerySimilarityThreshold}"
                                                       VerticalAlignment="Center" />
                                            <Slider Width="70" Margin="5,0" Minimum="50" Maximum="100"
                                                    IsSnapToTickEnabled="True" TickFrequency="1"
                                                    Value="{Binding ImageProcessing.SimilarityThreshold, Mode=TwoWay, Delay=200}" />
                                            <TextBlock
                                                Text="{Binding ImageProcessing.SimilarityThreshold, StringFormat={}{0:F0}%}"
                                                MinWidth="30" />
                                        </StackPanel>

                                        <TextBlock Text="{local:Translate Tab_GallerySort}" Margin="15,0,5,0" />
                                        <ComboBox
                                            ItemsSource="{Binding Source={local:EnumBindingSource {x:Type local:SortOption}}}"
                                            SelectedItem="{Binding ImageProcessing.SelectedSortOption}" Width="120" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                            <Border DockPanel.Dock="Bottom" Padding="8"
                                    BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="0,1,0,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <TextBlock Text="{local:Translate Tab_GalleryThumbnailSize}"
                                                   VerticalAlignment="Center" Margin="0,0,5,0" />
                                        <Slider x:Name="ThumbnailSizeSlider" Minimum="64" Maximum="1024"
                                                Value="{Binding ImageProcessing.GalleryThumbnailSize, Mode=TwoWay}"
                                                Width="100" />
                                    </StackPanel>
                                    
                                    <ContentControl Grid.Column="1" HorizontalAlignment="Right" Content="{Binding}">
                                        <ContentControl.ContentTemplate>
                                            <DataTemplate>
                                                <ContentControl Content="{Binding}" ContentTemplate="{StaticResource UndockableQueueControlsTemplate}">
                                                    <ContentControl.Style>
                                                        <Style TargetType="ContentControl">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsQueueControlsUndocked}" Value="True">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </ContentControl.Style>
                                                </ContentControl>
                                            </DataTemplate>
                                        </ContentControl.ContentTemplate>
                                    </ContentControl>
                                </Grid>
                                            </Border>
                                        <Grid>
                                <ListView x:Name="lvOutputs" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                          ItemsSource="{Binding ImageProcessing.FilteredImageOutputs}"
                                          Background="Transparent" BorderThickness="0"
                                          SelectionMode="Extended"
                                          SelectionChanged="LvOutputs_SelectionChanged"
                                          PreviewKeyDown="LvOutputs_PreviewKeyDown"
                                          KeyDown="LvOutputs_KeyDown"
                                          SelectedItem="{Binding ImageProcessing.SelectedGalleryImage, Mode=TwoWay}">
                                    <ListView.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal" Margin="5" />
                                        </ItemsPanelTemplate>
                                    </ListView.ItemsPanel>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                            <Border x:Name="ItemBorder" CornerRadius="3" Margin="5"
                                                    BorderBrush="{StaticResource TertiaryBackground}"
                                                    BorderThickness="1"
                                                Width="{Binding ElementName=ThumbnailSizeSlider, Path=Value}"
                                                Height="{Binding ElementName=ThumbnailSizeSlider, Path=Value}">
                                            <Border.ToolTip>
                                                <ToolTip>
                                                    <TextBlock>
                                                            <Run
                                                                Text="{Binding NodeTitle, Mode=OneWay, StringFormat='Node: {0}'}"
                                                                FontWeight="Bold" />
                                                            <Run
                                                                Text="{Binding NodeId, Mode=OneWay, StringFormat=' ({0})'}"
                                                                FontWeight="Bold" />
                                                            <LineBreak />
                                                            <Run
                                                                Text="{Binding NodeType, Mode=OneWay, StringFormat='Type: {0}'}"
                                                                Foreground="{StaticResource TextSecondaryBrush}" />
                                                            <LineBreak />
                                                            <Run
                                                                Text="{Binding FileName, Mode=OneWay, StringFormat='File: {0}'}" />
                                                    </TextBlock>
                                                </ToolTip>
                                            </Border.ToolTip>
                                            <Grid>
                                                    <Border Background="Transparent" />
                                                    <Image x:Name="ImgDisplay" Source="{Binding Image}"
                                                           Visibility="Visible" Stretch="Uniform" />
                                                <MediaElement x:Name="VidDisplay" Visibility="Collapsed"
                                                                  LoadedBehavior="Manual" UnloadedBehavior="Stop"
                                                                  IsMuted="True"
                                                              Loaded="MediaElement_Loaded"
                                                              Unloaded="MediaElement_Unloaded"
                                                                  MediaEnded="MediaElement_MediaEnded"
                                                                  Stretch="Uniform" />
                                                    <TextBlock x:Name="SavedIndicator" Text="💾"
                                                           HorizontalAlignment="Left" VerticalAlignment="Top"
                                                           Margin="4" FontSize="16"
                                                           ToolTip="Saved"
                                                           Visibility="Collapsed">
                                                    <TextBlock.Effect>
                                                            <DropShadowEffect ShadowDepth="1" Color="Black"
                                                                              Opacity="0.7" BlurRadius="2" />
                                                    </TextBlock.Effect>
                                                </TextBlock>
                                                    <Border x:Name="NameOverlay" VerticalAlignment="Bottom"
                                                            Background="#B22D2D30" Padding="5,2" CornerRadius="0,0,2,2"
                                                            Opacity="0" IsHitTestVisible="False">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Style.Triggers>
                                                                    <DataTrigger
                                                                        Binding="{Binding IsMouseOver, ElementName=ItemBorder}"
                                                                        Value="True">
                                                                        <DataTrigger.EnterActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation
                                                                                        Storyboard.TargetProperty="Opacity"
                                                                                        To="1" Duration="0:0:0.2" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.EnterActions>
                                                                        <DataTrigger.ExitActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation
                                                                                        Storyboard.TargetProperty="Opacity"
                                                                                        To="0" Duration="0:0:0.3" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.ExitActions>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <TextBlock Text="{Binding FileName}" Foreground="White"
                                                                   TextTrimming="CharacterEllipsis" />
                                                </Border>
                                                    <Button x:Name="DeleteButton" Content="&#xE74D;"
                                                            Style="{StaticResource IconButton}"
                                                        HorizontalAlignment="Right" VerticalAlignment="Top"
                                                        Width="24" Height="24" Margin="2"
                                                        ToolTip="{local:Translate Tab_DeleteFile}"
                                                        Command="{Binding DataContext.ImageProcessing.DeleteImageCommand, ElementName=lvOutputs}"
                                                        CommandParameter="{Binding}"
                                                            Visibility="Collapsed" />
                                            </Grid>
                                        </Border>
                                        <DataTemplate.Triggers>
                                                <DataTrigger Binding="{Binding Type}" Value="Video">
                                                    <Setter TargetName="VidDisplay" Property="Visibility"
                                                            Value="Visible" />
                                                    <Setter TargetName="ImgDisplay" Property="Visibility"
                                                            Value="Collapsed" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsMouseOver, ElementName=ItemBorder}"
                                                             Value="True">
                                                    <Setter TargetName="DeleteButton" Property="Visibility"
                                                            Value="Visible" />
                                                </DataTrigger>
                                            <DataTrigger Binding="{Binding IsSaved}" Value="True">
                                                    <Setter TargetName="ItemBorder" Property="BorderBrush"
                                                            Value="{StaticResource SuccessBrush}" />
                                                    <Setter TargetName="SavedIndicator" Property="Visibility"
                                                            Value="Visible" />
                                            </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListViewItem}}"
                                                    Value="True">
                                                    <Setter TargetName="ItemBorder" Property="BorderBrush"
                                                            Value="{StaticResource PrimaryAccentBrush}" />
                                                    <Setter TargetName="ItemBorder" Property="BorderThickness"
                                                            Value="2" />
                                            </DataTrigger>
                                        </DataTemplate.Triggers>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="{x:Type ListViewItem}">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="ListViewItem">
                                                        <ContentPresenter />
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <EventSetter Event="MouseDoubleClick"
                                                         Handler="ListViewItem_MouseDoubleClick" />
                                            <EventSetter Event="PreviewMouseLeftButtonDown"
                                                         Handler="ListViewItem_PreviewMouseLeftButtonDown" />
                                            <EventSetter Event="MouseMove" Handler="ListViewItem_MouseMove" />

                                            <Setter Property="Tag" Value="{Binding DataContext, ElementName=lvOutputs}" />

                                        <Setter Property="ContextMenu">
                                            <Setter.Value>
                                                <ContextMenu Style="{StaticResource AppContextMenuStyle}">
                                                    <MenuItem Header="{local:Translate ContextMenu_BlockNode}"
                                                              Command="{Binding PlacementTarget.Tag.BlockNodeCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                  CommandParameter="{Binding}" />
                                                </ContextMenu>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ListView.ItemContainerStyle>
                            </ListView>

                            <Border Background="#DD3F3F46" CornerRadius="5" Padding="10"
                                HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,10"
                                Visibility="{Binding ImageProcessing.SelectedItemsCount, Converter={StaticResource CountToVisibilityConverter}}"> <!-- ИЗМЕНЕНО: Используем другой конвертер -->
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock VerticalAlignment="Center" Margin="0,0,10,0">
                                            <Run Text="{local:Translate Tab_SelectedItems}" />
                                            <Run Text="{Binding ImageProcessing.SelectedItemsCount}" />
                                    </TextBlock>

                                    <Button Content="{local:Translate SliderCompare_Compare}" Margin="0,0,5,0"
                                            Command="{Binding CompareSelectedImagesCommand}"
                                                CommandParameter="{Binding ElementName=lvOutputs, Path=SelectedItems}" />
                                        <Button Content="{local:Translate Tab_SaveSelected}"
                                                Background="{StaticResource SuccessBrush}"
                                            Command="{Binding ImageProcessing.SaveSelectedImagesCommand}"
                                                CommandParameter="{Binding ElementName=lvOutputs, Path=SelectedItems}" />
                                        <Button Content="{local:Translate Tab_SaveSelectedAs}"
                                                Background="{StaticResource SuccessBrush}"
                                                Command="{Binding ImageProcessing.SaveSelectedImagesAsCommand}"
                                                CommandParameter="{Binding ElementName=lvOutputs, Path=SelectedItems}" 
                                                Margin="5,0,0,0"/>
                                        <Button Content="{local:Translate Tab_DeleteSelected}"
                                                Background="{StaticResource ErrorBrush}"
                                            Command="{Binding ImageProcessing.DeleteSelectedImagesCommand}"
                                            CommandParameter="{Binding ElementName=lvOutputs, Path=SelectedItems}"
                                                Margin="5,0,0,0" />
                                </StackPanel>
                            </Border>
                                <Button Content="&#xE74D;" Style="{StaticResource IconButton}"
                                        Command="{Binding ImageProcessing.ClearOutputsCommand}"
                                        Background="{StaticResource ErrorBrush}" HorizontalAlignment="Right"
                                        VerticalAlignment="Bottom" Margin="0,0,10,10"
                                        ToolTip="{local:Translate Tab_ClearFilteredResults}" />
                        </Grid>
                        </DockPanel>
                    </Border>
                </Grid>

                <GridSplitter Grid.Column="3"
                              Style="{StaticResource VerticalGridSplitterStyle}"
                              ResizeBehavior="PreviousAndNext"
                              HorizontalAlignment="Center"
                              Visibility="{Binding IsQueueManagerVisible, Converter={StaticResource BooleanToVisibilityConverter}}" />

                <Border Grid.Column="4" Background="{StaticResource SecondaryBackground}" CornerRadius="0,0,5,0"
                        Margin="0,0,5,5"
                        Visibility="{Binding IsQueueManagerVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <DockPanel>
                        <DockPanel.Resources>
                            <DataTemplate x:Key="QueueItemTemplate" DataType="{x:Type local:QueueItemViewModel}">
                                <StackPanel>
                                    <Border x:Name="DropIndicatorBefore" Height="2"
                                            Background="{StaticResource PrimaryAccentBrush}" CornerRadius="1"
                                            Margin="0,1" Visibility="Collapsed" IsHitTestVisible="False" />
                                    <Border Background="{StaticResource PrimaryBackground}" CornerRadius="3"
                                            BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="1"
                                            Margin="0,2" Padding="8">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <Grid Grid.Row="0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Grid.Column="0" FontWeight="Bold" VerticalAlignment="Center">
                                                    <Run Text="{Binding DisplayIndex, StringFormat='{}{0}: '}" />
                                                    <Run Text="{Binding WorkflowName, Mode=OneWay}" />
                                                </TextBlock>

                                                <Button Grid.Column="1" Content="&#xE74D;"
                                                        Style="{StaticResource IconButton}"
                                                        Width="20" Height="20"
                                                        ToolTip="{local:Translate QueueManager_DeleteItem}"
                                                        Command="{Binding DataContext.DeleteSelectedQueueItemCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                        CommandParameter="{Binding}" />
                                            </Grid>

                                            <ItemsControl Grid.Row="1" ItemsSource="{Binding Details}" Margin="0,5,0,0">
                                                <ItemsControl.Style>
                                                    <Style TargetType="ItemsControl">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger
                                                                Binding="{Binding Details.Count, Converter={StaticResource CountToBooleanConverter}}"
                                                                Value="True">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ItemsControl.Style>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type local:QueueItemDetailViewModel}">
                                                        <TextBlock FontSize="11"
                                                                   Foreground="{StaticResource TextSecondaryBrush}"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   ToolTipService.InitialShowDelay="0"
                                                                   ToolTipService.ShowDuration="20000">
                                                            <TextBlock.ToolTip>
                                                                <ToolTip>
                                                                    <TextBlock Text="{Binding NewValue}" MaxWidth="500"
                                                                               TextWrapping="Wrap" />
                                                                </ToolTip>
                                                            </TextBlock.ToolTip>
                                                            <Run Text="{Binding DisplayName}" FontWeight="SemiBold">
                                                                <Run.ToolTip>
                                                                    <ToolTip>
                                                                        <TextBlock>
                                                                            <Run
                                                                                Text="{Binding NodeTitle, Mode=OneWay, StringFormat='Node: {0}'}"
                                                                                FontWeight="Bold" />
                                                                            <LineBreak />
                                                                            <Run
                                                                                Text="{Binding NodeType, Mode=OneWay, StringFormat='Type: {0}'}"
                                                                                Foreground="{StaticResource TextSecondaryBrush}" />
                                                                            <LineBreak />
                                                                            <Run
                                                                                Text="{Binding FieldPath, Mode=OneWay, StringFormat='Path: {0}'}" />
                                                                        </TextBlock>
                                                                    </ToolTip>
                                                                </Run.ToolTip>
                                                            </Run>
                                                            :
                                                            <Run Text="{Binding NewValue}" Foreground="#E6DB74" />
                                                        </TextBlock>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Grid>
                                    </Border>
                                    <Border x:Name="DropIndicatorAfter" Height="2"
                                            Background="{StaticResource PrimaryAccentBrush}" CornerRadius="1"
                                            Margin="0,1" Visibility="Collapsed" IsHitTestVisible="False" />
                                </StackPanel>
                            </DataTemplate>
                        </DockPanel.Resources>

                        <Border DockPanel.Dock="Top" Padding="8,5" Background="{StaticResource TertiaryBackground}">
                            <Grid>
                                <TextBlock Text="{local:Translate QueueManager_Title}" FontWeight="Bold"
                                           HorizontalAlignment="Left" VerticalAlignment="Center" />
                                <Button Content="&#xE711;" Style="{StaticResource IconButton}"
                                        Command="{Binding HideQueueManagerCommand}"
                                        Width="24" Height="24"
                                        ToolTip="{local:Translate Window_Close}"
                                        HorizontalAlignment="Right" VerticalAlignment="Center" />
                            </Grid>
                        </Border>
                        
                        <TextBox DockPanel.Dock="Top" Text="{Binding QueueSearchText, UpdateSourceTrigger=PropertyChanged}" 
                                 Margin="5"
                                 local:TextBoxExtensions.PlaceholderText="Search queue..."/>

                        <ScrollViewer x:Name="QueueScrollViewer" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                                      Margin="5">
                            <StackPanel>
                                <!-- Display Area for the Current Task -->
                                <Border>
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Visibility" Value="Visible" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding CurrentTaskVm}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>

                                    <Grid>
                                        <ContentPresenter Content="{Binding CurrentTaskVm}"
                                                          ContentTemplate="{StaticResource QueueItemTemplate}" />
                                        <Border Background="#90000000" IsHitTestVisible="False" CornerRadius="3"
                                                Margin="0,4,0,3" />
                                        <TextBlock Text="&#xE895;" FontFamily="Segoe MDL2 Assets"
                                                   FontSize="16" FontWeight="Bold"
                                                   Foreground="{StaticResource PrimaryAccentBrush}"
                                                   HorizontalAlignment="Left" VerticalAlignment="Top"
                                                   Margin="12,12,0,0">
                                            <TextBlock.RenderTransform>
                                                <RotateTransform CenterX="8" CenterY="8" />
                                            </TextBlock.RenderTransform>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsVisible" Value="True">
                                                            <Trigger.EnterActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation
                                                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                                            From="0" To="360" Duration="0:0:2"
                                                                            RepeatBehavior="Forever" />
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.EnterActions>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>

                                <!-- ListBox for Pending Tasks -->
                                <ListBox ItemsSource="{Binding FilteredPendingQueueItemsView}"
                                         SelectedItem="{Binding SelectedQueueItem}"
                                         Background="{StaticResource TertiaryBackground}" BorderThickness="0"
                                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                         PreviewMouseWheel="QueueListBox_PreviewMouseWheel"
                                         ItemTemplate="{StaticResource QueueItemTemplate}">
                                    <ListBox.ItemContainerStyle>
                                        <Style TargetType="ListBoxItem">
                                            <Setter Property="AllowDrop" Value="True" />
                                            <EventSetter Event="PreviewMouseLeftButtonDown"
                                                         Handler="QueueItem_PreviewMouseLeftButtonDown" />
                                            <EventSetter Event="MouseMove" Handler="QueueItem_MouseMove" />
                                            <EventSetter Event="Drop" Handler="QueueItem_Drop" />
                                            <EventSetter Event="DragOver" Handler="QueueItem_DragOver" />
                                            <EventSetter Event="DragLeave" Handler="QueueItem_DragLeave" />
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="ListBoxItem">
                                                        <ContentPresenter />
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter Property="Effect">
                                                        <Setter.Value>
                                                            <DropShadowEffect ShadowDepth="0"
                                                                              Color="{Binding Source={StaticResource PrimaryAccentBrush}, Path=Color}"
                                                                              BlurRadius="8" Opacity="0.8" />
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ListBox.ItemContainerStyle>
                                </ListBox>
                            </StackPanel>
                        </ScrollViewer>
                    </DockPanel>
                </Border>

                <Border Grid.Column="0" Grid.ColumnSpan="5" Background="{StaticResource PrimaryBackground}"
                        Margin="5,0,5,5">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding OpenTabs.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <TextBlock Text="{local:Translate Tab_NoWorkflowSelected}" HorizontalAlignment="Center"
                               VerticalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}"
                               FontSize="16" />
                </Border>
            </Grid>
        </Grid>

        <GridSplitter Grid.Row="2"
                      Height="5"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Center"
                      Background="{StaticResource TertiaryBackground}"
                      ResizeDirection="Rows"
                      ResizeBehavior="PreviousAndNext"
                      Visibility="{Binding IsConsoleVisible, Converter={StaticResource BooleanToVisibilityConverter}}" />

        <Border Grid.Row="3"
                Background="{StaticResource SecondaryBackground}"
                Margin="5,0,5,5"
                BorderBrush="{StaticResource TertiaryBackground}"
                BorderThickness="0,1,0,0"
                Visibility="{Binding IsConsoleVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <DockPanel>
                <Border DockPanel.Dock="Top" Padding="8,5" Background="{StaticResource TertiaryBackground}">
                    <Grid>
                        <TextBlock Text="{local:Translate Console_Title}" FontWeight="Bold" HorizontalAlignment="Left" />

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <RadioButton Content="{local:Translate Console_FilterAll}" GroupName="LogFilter"
                                         IsChecked="{Binding SelectedLogFilterType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:LogFilterType.All}}" />
                            <RadioButton Content="{local:Translate Console_FilterComfy}" GroupName="LogFilter"
                                         Margin="10,0,0,0"
                                         IsChecked="{Binding SelectedLogFilterType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:LogFilterType.Comfy}}" />
                            <RadioButton Content="{local:Translate Console_FilterLocal}" GroupName="LogFilter"
                                         Margin="10,0,0,0"
                                         IsChecked="{Binding SelectedLogFilterType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:LogFilterType.Local}}" />
                            <RadioButton Content="{local:Translate Console_FilterPython}" GroupName="LogFilter"
                                         Margin="10,0,0,0"
                                         IsChecked="{Binding SelectedLogFilterType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:LogFilterType.Python}}" />
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Button Content="&#xE8C8;" Style="{StaticResource IconButton}"
                                    Command="{Binding CopyConsoleCommand}"
                                    Width="24" Height="24"
                                    ToolTip="{local:Translate Console_Copy}"
                                    Margin="0,0,5,0" />

                            <Button Content="&#xE74D;" Style="{StaticResource IconButton}"
                                    Command="{Binding ClearConsoleCommand}"
                                    Width="24" Height="24"
                                    ToolTip="{local:Translate Console_Clear}" />

                            <Button Content="&#xE711;" Style="{StaticResource IconButton}"
                                    Command="{Binding HideConsoleCommand}"
                                    Width="24" Height="24"
                                    ToolTip="{local:Translate Window_Close}" />
                        </StackPanel>
                    </Grid>
                </Border>

                <Grid x:Name="ConsoleContentGrid"
                      PreviewMouseLeftButtonDown="Console_PreviewMouseLeftButtonDown"
                      PreviewMouseMove="Console_PreviewMouseMove"
                      PreviewMouseLeftButtonUp="Console_PreviewMouseLeftButtonUp">
                    <Border Background="{StaticResource TertiaryBackground}" CornerRadius="3" Padding="15" Margin="10"
                            HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ConsoleLogMessages.Count}" Value="0">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock TextWrapping="Wrap" TextAlignment="Center"
                                   Foreground="{StaticResource TextSecondaryBrush}" MaxWidth="500">
                            <Run Text="{local:Translate Console_Instructions}" />
                        </TextBlock>
                    </Border>

                    <ScrollViewer x:Name="ConsoleScrollViewer" VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Disabled">
                        <ScrollViewer.Style>
                            <Style TargetType="ScrollViewer">
                                <Setter Property="Visibility" Value="Visible" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ConsoleLogMessages.Count}" Value="0">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ScrollViewer.Style>
                        <ListBox x:Name="ConsoleListBox" ItemsSource="{Binding ConsoleLogMessages}"
                                 Background="Transparent" BorderThickness="0" Margin="5"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                 ScrollViewer.VerticalScrollBarVisibility="Disabled"
                                 PreviewMouseWheel="ConsoleListBox_PreviewMouseWheel">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <ContentPresenter />
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="Tag"
                                            Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=ListBox}}" />
                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource AppContextMenuStyle}">
                                                <MenuItem Header="{local:Translate Console_CopyItem}"
                                                          Command="{Binding PlacementTarget.Tag.CopyConsoleItemCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding}" />
                                                <Separator/>
                                                <MenuItem Header="{local:Translate Console_Clear}"
                                                          Command="{Binding PlacementTarget.Tag.ClearConsoleCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate DataType="{x:Type local:LogMessage}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="{Binding Timestamp, StringFormat='HH:mm:ss'}"
                                                   Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,10,0"
                                                   VerticalAlignment="Top" />
                                        <TextBlock Grid.Column="1"
                                                   local:TextBlockExtensions.BindableInlines="{Binding Segments}"
                                                   TextWrapping="Wrap">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock"
                                                       BasedOn="{StaticResource {x:Type TextBlock}}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Level}" Value="Warning">
                                                            <Setter Property="Foreground" Value="Orange" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Level}" Value="Error">
                                                            <Setter Property="Foreground"
                                                                    Value="{StaticResource ErrorBrush}" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Level}" Value="Critical">
                                                            <Setter Property="Foreground"
                                                                    Value="{StaticResource ErrorBrush}" />
                                                            <Setter Property="FontWeight" Value="Bold" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Grid>
            </DockPanel>
        </Border>

        <Grid x:Name="FullScreenViewer" Grid.Row="0" Grid.RowSpan="4" Background="#D8000000"
              Focusable="True" PreviewKeyDown="FullScreenViewer_PreviewKeyDown"
              Visibility="{Binding FullScreen.IsFullScreenOpen, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"
              MouseLeftButtonDown="FullScreenViewer_MouseLeftButtonDown"
              IsVisibleChanged="FullScreenViewer_IsVisibleChanged"
              SizeChanged="FullScreenViewer_SizeChanged">
            <Grid.Resources>
                <Style x:Key="OverlayButton" TargetType="Button">
                    <Setter Property="Background" Value="#80000000" /> <Setter Property="Foreground" Value="White" />
                    <Setter Property="BorderThickness" Value="0" /> <Setter Property="FontSize" Value="24" />
                    <Setter Property="FontWeight" Value="Bold" /> <Setter Property="Width" Value="50" />
                    <Setter Property="Height" Value="50" /> <Setter Property="Cursor" Value="Hand" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" CornerRadius="25">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                </Border>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="#A0000000" />
                        </Trigger>
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter Property="Opacity" Value="0.3" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
                <Style x:Key="FullScreenSaveButton" TargetType="Button">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="Foreground" Value="White" />
                    <Setter Property="BorderThickness" Value="0" />
                    <Setter Property="FontSize" Value="24" />
                    <Setter Property="Padding" Value="8" />
                    <Setter Property="Cursor" Value="Hand" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="Button">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Opacity" Value="0.8" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Grid.Resources>
            <Viewbox>
                <Image Source="{Binding FullScreen.CurrentFullScreenImage.Image}" Stretch="Uniform">
                    <Image.Style>
                        <Style TargetType="Image">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding FullScreen.CurrentFullScreenImage.Type}" Value="Video">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Image.Style>
                </Image>
            </Viewbox>
            <MediaElement x:Name="FullScreenMediaElement"
                          Stretch="Uniform" LoadedBehavior="Manual"
                          UnloadedBehavior="Stop" IsMuted="False"
                          DataContext="{Binding FullScreen.CurrentFullScreenImage}"
                          DataContextChanged="FullScreenMediaElement_DataContextChanged"
                          MediaOpened="FullScreenMediaElement_MediaOpened"
                          MediaEnded="FullScreenMediaElement_MediaEnded">
                <MediaElement.Style>
                    <Style TargetType="MediaElement">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Type}" Value="Video">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </MediaElement.Style>
            </MediaElement>
            <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="#A0000000" CornerRadius="10"
                    Padding="20,10" IsHitTestVisible="False">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed" /><Setter Property="Opacity" Value="0" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding FullScreen.ShowSaveConfirmation}" Value="True">
                                <Setter Property="Visibility" Value="Visible" />
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1"
                                                             Duration="0:0:0.3" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0"
                                                             Duration="0:0:0.3" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.ExitActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <TextBlock Text="{Binding FullScreen.SaveConfirmationText}" Foreground="White" FontSize="18" />
            </Border>

            <Grid x:Name="ControlsOverlay">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Opacity" Value="1" />
                        <Setter Property="IsHitTestVisible" Value="True" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsMouseOver, ElementName=SafeZone}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0"
                                                             Duration="0:0:0.3" />
                                            <BooleanAnimationUsingKeyFrames
                                                Storyboard.TargetProperty="IsHitTestVisible">
                                                <DiscreteBooleanKeyFrame KeyTime="0:0:0.3" Value="False" />
                                            </BooleanAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1"
                                                             Duration="0:0:0.2" />
                                            <BooleanAnimationUsingKeyFrames
                                                Storyboard.TargetProperty="IsHitTestVisible">
                                                <DiscreteBooleanKeyFrame KeyTime="0:0:0" Value="True" />
                                            </BooleanAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.ExitActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>

                <Border HorizontalAlignment="Left" VerticalAlignment="Top" Margin="20" Background="#A0000000"
                        CornerRadius="5" Padding="8,4">
                    <TextBlock Text="{Binding FullScreen.CurrentFullScreenImage.Resolution}" Foreground="White"
                               FontSize="14" />
                </Border>

                <Border HorizontalAlignment="Left" VerticalAlignment="Top" Margin="20" Background="#A0000000"
                        CornerRadius="5" Padding="8,4">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding FullScreen.CurrentFullScreenImage.Resolution}" Foreground="White"
                                   FontSize="14" />
                        <TextBlock Foreground="White" FontSize="14" Margin="10,0,0,0">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} / {1}">
                                    <Binding Path="FullScreen.CurrentImageIndex" />
                                    <Binding Path="FullScreen.TotalImages" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <Button Content="✕" Style="{StaticResource OverlayButton}"
                        Command="{Binding FullScreen.CloseFullScreenCommand}"
                        HorizontalAlignment="Right" VerticalAlignment="Top" Margin="20" Width="40" Height="40"
                        FontSize="20"
                        ToolTip="{x:Static local:Hotkeys.CloseFullscreenTooltip}" />

                <Button Content="‹" Style="{StaticResource OverlayButton}"
                        Command="{Binding FullScreen.MovePreviousCommand}"
                        HorizontalAlignment="Left" VerticalAlignment="Center" Margin="20,0"
                        ToolTip="{x:Static local:Hotkeys.MovePreviousTooltip}" />

                <Button Content="›" Style="{StaticResource OverlayButton}"
                        Command="{Binding FullScreen.MoveNextCommand}"
                        HorizontalAlignment="Right" VerticalAlignment="Center" Margin="20,0"
                        ToolTip="{x:Static local:Hotkeys.MoveNextTooltip}" />
                <Border VerticalAlignment="Bottom"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,20"
                        Background="#A0000000"
                        CornerRadius="10">
                    <StackPanel Orientation="Vertical">
                        <Grid Margin="10,5,10,0" MinWidth="400">
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding FullScreen.CurrentFullScreenImage.Type}"
                                                     Value="{x:Static local:FileType.Video}">
                                            <Setter Property="Visibility" Value="Visible" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" Command="{Binding FullScreen.PlayPauseCommand}" Width="40"
                                    Height="40" FontSize="16" Margin="0,0,10,0">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource OverlayButton}">
                                        <Setter Property="Content" Value="▶" /> <!-- Play Icon -->
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding FullScreen.IsPlaying}" Value="True">
                                                <Setter Property="Content" Value="⏸" /> <!-- Pause Icon -->
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <TextBlock x:Name="CurrentTimeTextBlock" Grid.Column="1" Text="00:00" Margin="0,0,10,0"
                                       Foreground="White" VerticalAlignment="Center" />

                            <Slider x:Name="PositionSlider" Grid.Column="2"
                                    Style="{StaticResource VideoSliderStyle}"
                                    ValueChanged="PositionSlider_ValueChanged"
                                    MouseMove="PositionSlider_MouseMove"
                                    PreviewMouseLeftButtonUp="PositionSlider_PreviewMouseLeftButtonUp"
                                    Thumb.DragStarted="PositionSlider_DragStarted"
                                    Thumb.DragCompleted="PositionSlider_DragCompleted" />

                            <TextBlock x:Name="DurationTextBlock" Grid.Column="3" Text="00:00" Margin="10,0,0,0"
                                       Foreground="White" VerticalAlignment="Center" />
                        </Grid>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="5">
                            <Button Content="💾"
                                    Style="{StaticResource FullScreenSaveButton}"
                                    Command="{Binding FullScreen.SaveCurrentImageCommand}">
                                <Button.ToolTip>
                                    <MultiBinding Converter="{StaticResource BoolToStringConverter}">
                                        <Binding Path="FullScreen.CurrentFullScreenImage.IsSaved"/>
                                        <Binding Source="{x:Static local:Hotkeys.SaveImageTooltip}"/>
                                        <Binding Source="{x:Static local:Hotkeys.SaveImageResaveTooltip}"/>
                                    </MultiBinding>
                                </Button.ToolTip>
                            </Button>
                            <Button Content="&#xE8C8;" FontFamily="Segoe MDL2 Assets"
                                    ToolTip="{local:Translate Fullscreen_Copy}"
                                    Style="{StaticResource FullScreenSaveButton}"
                                    Command="{Binding FullScreen.CopyImageCommand}"
                                    Margin="10,0,0,0"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
            <Border x:Name="SafeZone" Background="Transparent" Margin="120, 80, 120, 100" />
        </Grid>

        <local:SliderCompareView DataContext="{Binding SliderCompare}" Grid.Row="0" Grid.RowSpan="4" Panel.ZIndex="99" />

        <Popup x:Name="GroupNavigationPopup"
               IsOpen="{Binding IsGroupNavigationPopupOpen}"
               StaysOpen="False"
               Placement="Center"
               AllowsTransparency="True"
               Opened="GroupNavigationPopup_Opened">
            <Border Background="{StaticResource SecondaryBackground}"
                    BorderBrush="{StaticResource PrimaryAccentBrush}"
                    BorderThickness="1"
                    CornerRadius="5"
                    MinWidth="300"
                    MinHeight="300"
                    MaxHeight="500">
                <DockPanel Margin="5">
                    <TextBlock DockPanel.Dock="Top" Text="{local:Translate GroupNavigation_Title}" FontWeight="Bold" Margin="5" />
                    
                    <TextBox DockPanel.Dock="Top" 
                             x:Name="GroupNavigationSearchBox"
                             Text="{Binding GroupNavigationSearchText, UpdateSourceTrigger=PropertyChanged}" 
                             Margin="5,0,5,8"
                             PreviewKeyDown="GroupNavigationSearchBox_PreviewKeyDown">
                        <TextBox.Style>
                            <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                                <Setter Property="local:TextBoxExtensions.PlaceholderText" Value="{local:Translate GroupNavigation_SearchPlaceholder}"/>
                            </Style>
                        </TextBox.Style>
                    </TextBox>

                    <ScrollViewer x:Name="GroupNavigationScrollViewer" VerticalScrollBarVisibility="Auto">
                        <ListBox x:Name="GroupNavigationListBox"
                                 ItemsSource="{Binding FilteredNavigableGroupsView}"
                             Background="Transparent"
                                 BorderThickness="0"
                                 PreviewMouseWheel="GroupNavigationListBox_PreviewMouseWheel"
                                 PreviewKeyDown="GroupNavigationListBox_PreviewKeyDown">
                            <ListBox.GroupStyle>
                                <GroupStyle>
                                    <GroupStyle.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Background="{StaticResource TertiaryBackground}" CornerRadius="3" Padding="8,4" Margin="0,5,0,2">
                                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="{StaticResource TextBrush}"/>
                                            </Border>
                                        </DataTemplate>
                                    </GroupStyle.HeaderTemplate>
                                </GroupStyle>
                            </ListBox.GroupStyle>
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Padding" Value="8,5"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="ItemBorder" Background="Transparent" Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="ItemBorder" Property="Background" Value="{StaticResource TertiaryBackground}"/>
                                                    </Trigger>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="ItemBorder" Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <EventSetter Event="PreviewMouseLeftButtonUp" Handler="GroupNavigationListBoxItem_Click"/>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}" Margin="10,0,0,0"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
            </DockPanel>
        </Border>
    </Popup>

    </Grid>
</Window>