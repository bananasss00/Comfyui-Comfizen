<Application x:Class="Comfizen.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:Comfizen"
             xmlns:global="clr-namespace:"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             Startup="Application_Startup">
    <Application.Resources>
        
        <!-- Converters -->
        <local:ToTitleCaseConverter x:Key="ToTitleCaseConverter"/>
        <local:IsInpaintViewModelConverter x:Key="IsInpaintViewModelConverter"/>
        <local:IsMarkdownViewModelConverter x:Key="IsMarkdownViewModelConverter"/>
        <local:TaskCountToVisibilityConverter x:Key="TaskCountToVisibilityConverter" />
        <local:TabCountToVisibilityConverter x:Key="TabCountToVisibilityConverter" />
        <local:TabCountToHeaderHeightConverter x:Key="TabCountToHeaderHeightConverter" />
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <global:IsHeaderConverter x:Key="IsHeaderConverter"/>
        <local:StringListToStringConverter x:Key="StringListConverter"/>
        <local:StringToIsNotNullOrEmptyConverter x:Key="StringToIsNotNullOrEmptyConverter"/>
        <local:FileNameTrimmerConverter x:Key="FileNameTrimmerConverter"/>
        <local:EnumToBooleanConverter x:Key="EnumToBooleanConverter"/>
        <local:MultiSelectCountToVisibilityConverter x:Key="MultiSelectCountToVisibilityConverter"/>
        <local:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        <local:CountToBooleanConverter x:Key="CountToBooleanConverter"/>
        <local:BoolToGridLengthConverter x:Key="BoolToGridLengthConverter"/>
        <local:CultureInfoToNameConverter x:Key="CultureInfoToNameConverter"/>
        <local:MultiBindingStringFormatConverter x:Key="MultiBindingStringFormatConverter"/>
        <local:HexToBrushConverter x:Key="HexToBrushConverter"/>
        <local:PriorityColorToBrushConverter x:Key="PriorityColorToBrushConverter"/>
        <local:MultiValueToArrayConverter x:Key="MultiValueToArrayConverter"/>
        <local:ExpanderCornerRadiusConverter x:Key="ExpanderCornerRadiusConverter"/>
        <local:EqualityConverter x:Key="EqualityConverter" />
        <local:StringToBoolConverter x:Key="StringToBoolConverter" />
        <local:CornerRadiusConverter x:Key="CornerRadiusConverter" />
        <local:SelectionCountToBooleanConverter x:Key="SelectionCountToBooleanConverter"/>
        <local:AddOneConverter x:Key="AddOneConverter"/>
        <local:IsGreaterThanConverter x:Key="IsGreaterThanConverter"/>
        <local:InvertBooleanConverter x:Key="InvertBooleanConverter"/>
        <local:BooleanAndConverter x:Key="BooleanAndConverter"/>
        <local:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <local:BoolToStringConverter x:Key="BoolToStringConverter"/>
        <local:SliderPresetsFilterConverter x:Key="SliderPresetsFilterConverter"/>
        <local:GlobalPresetDetailConverter x:Key="GlobalPresetDetailConverter"/>
        
        
        
        <!-- ScrollBar Thumb Style -->
        <Style x:Key="ScrollBarThumb" TargetType="{x:Type Thumb}">
            <Setter Property="OverridesDefaultStyle" Value="true"/>
            <Setter Property="IsTabStop" Value="false"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Thumb}">
                        <Border x:Name="rectangle"
                                Background="{DynamicResource TertiaryBackground}"
                                CornerRadius="2.5"
                                SnapsToDevicePixels="True"/>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="true">
                                <Setter TargetName="rectangle" Property="Background" Value="{DynamicResource PrimaryAccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsDragging" Value="true">
                                <Setter TargetName="rectangle" Property="Background" Value="{DynamicResource PrimaryAccentBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ScrollBar Page Button Style (Transparent track) -->
        <Style x:Key="ScrollBarPageButton" TargetType="{x:Type RepeatButton}">
            <Setter Property="OverridesDefaultStyle" Value="true"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Focusable" Value="false"/>
            <Setter Property="IsTabStop" Value="false"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type RepeatButton}">
                        <Rectangle Fill="{TemplateBinding Background}" Width="{TemplateBinding Width}" Height="{TemplateBinding Height}"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Implicit ScrollBar Style -->
        <Style TargetType="{x:Type ScrollBar}">
            <Setter Property="Background" Value="{DynamicResource SecondaryBackground}"/>
            <Setter Property="Width" Value="10"/>
            <Setter Property="MinWidth" Value="10"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                        <Grid SnapsToDevicePixels="true" Background="{TemplateBinding Background}">
                            <Track x:Name="PART_Track" IsDirectionReversed="true" Grid.Row="1">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="{x:Static ScrollBar.PageUpCommand}" Style="{DynamicResource ScrollBarPageButton}"/>
                                </Track.DecreaseRepeatButton>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="{x:Static ScrollBar.PageDownCommand}" Style="{DynamicResource ScrollBarPageButton}"/>
                                </Track.IncreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Style="{DynamicResource ScrollBarThumb}" />
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="Orientation" Value="Horizontal">
                    <Setter Property="Width" Value="Auto"/>
                    <Setter Property="Height" Value="10"/>
                    <Setter Property="MinHeight" Value="10"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="{x:Type ScrollBar}">
                                <Grid SnapsToDevicePixels="True" Background="{TemplateBinding Background}">
                                    <Track x:Name="PART_Track">
                                        <Track.DecreaseRepeatButton>
                                            <RepeatButton Command="{x:Static ScrollBar.PageLeftCommand}" Style="{DynamicResource ScrollBarPageButton}"/>
                                        </Track.DecreaseRepeatButton>
                                        <Track.IncreaseRepeatButton>
                                            <RepeatButton Command="{x:Static ScrollBar.PageRightCommand}" Style="{DynamicResource ScrollBarPageButton}"/>
                                        </Track.IncreaseRepeatButton>
                                        <Track.Thumb>
                                            <Thumb Style="{DynamicResource ScrollBarThumb}" />
                                        </Track.Thumb>
                                    </Track>
                                </Grid>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Implicit ScrollViewer Style -->
        <Style TargetType="{x:Type ScrollViewer}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollViewer}">
                        <Grid x:Name="Grid" Background="{TemplateBinding Background}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <ScrollContentPresenter x:Name="PART_ScrollContentPresenter" CanContentScroll="{TemplateBinding CanContentScroll}" CanHorizontallyScroll="False" CanVerticallyScroll="False" ContentTemplate="{TemplateBinding ContentTemplate}" Content="{TemplateBinding Content}" Grid.Column="0" Margin="{TemplateBinding Padding}" Grid.Row="0"/>
                            <ScrollBar x:Name="PART_VerticalScrollBar" AutomationProperties.AutomationId="VerticalScrollBar" Cursor="Arrow" Grid.Column="1" Maximum="{TemplateBinding ScrollableHeight}" Minimum="0" Grid.Row="0" Visibility="{TemplateBinding ComputedVerticalScrollBarVisibility}" Value="{Binding VerticalOffset, Mode=OneWay, RelativeSource={RelativeSource TemplatedParent}}" ViewportSize="{TemplateBinding ViewportHeight}"/>
                            <ScrollBar x:Name="PART_HorizontalScrollBar" AutomationProperties.AutomationId="HorizontalScrollBar" Cursor="Arrow" Grid.Column="0" Maximum="{TemplateBinding ScrollableWidth}" Minimum="0" Orientation="Horizontal" Grid.Row="1" Visibility="{TemplateBinding ComputedHorizontalScrollBarVisibility}" Value="{Binding HorizontalOffset, Mode=OneWay, RelativeSource={RelativeSource TemplatedParent}}" ViewportSize="{TemplateBinding ViewportWidth}"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Color Palette -->
        <SolidColorBrush x:Key="PrimaryBackground" Color="#FF2D2D30"/>
        <SolidColorBrush x:Key="SecondaryBackground" Color="#FF3F3F46"/>
        <SolidColorBrush x:Key="TertiaryBackground" Color="#FF52525B"/>
        <SolidColorBrush x:Key="PrimaryAccentBrush" Color="#FF007ACC"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#FF2ECC71"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#FFE74C3C"/>
        <SolidColorBrush x:Key="TextBrush" Color="#FFE0E0E0"/>
        <SolidColorBrush x:Key="TextSecondaryBrush" Color="#FFA0A0A0"/>
        
        <ControlTemplate x:Key="CustomContextMenuTemplate" TargetType="ContextMenu">
            <Border x:Name="Border" 
                    Background="{StaticResource SecondaryBackground}"
                    BorderBrush="{StaticResource TertiaryBackground}"
                    BorderThickness="1">
                <ItemsPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
            </Border>
            <ControlTemplate.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter TargetName="Border" Property="Background" Value="{StaticResource TertiaryBackground}"/>
                    <Setter TargetName="Border" Property="BorderBrush" Value="#454545"/>
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <Style x:Key="AppContextMenuStyle" TargetType="ContextMenu">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Template" Value="{StaticResource CustomContextMenuTemplate}"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
        </Style>

        <Style TargetType="MenuItem">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border x:Name="Border" 
                                Background="Transparent"
                                Padding="{TemplateBinding Padding}">
                            <TextBlock x:Name="HeaderText"
                                       Text="{TemplateBinding Header}"
                                       VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                                <Setter TargetName="HeaderText" Property="Foreground" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="HeaderText" Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <Style x:Key="SystemButton" TargetType="Button">
            <Setter Property="Width" Value="46"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <Path Data="{Binding Content, RelativeSource={RelativeSource TemplatedParent}}" 
                                  Stroke="{TemplateBinding Foreground}" 
                                  StrokeThickness="1"
                                  HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource TertiaryBackground}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="SystemButtonClose" TargetType="Button" BasedOn="{StaticResource SystemButton}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <Path Data="{Binding Content, RelativeSource={RelativeSource TemplatedParent}}" 
                                  Stroke="{TemplateBinding Foreground}" 
                                  StrokeThickness="1.5"
                                  HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#C42B1C"/>
                    <Setter Property="Foreground" Value="White"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Style for Icon ToggleButtons -->
        <Style x:Key="IconToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Width" Value="30"/>
            <Setter Property="Height" Value="30"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}" CornerRadius="3" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}">
                            <TextBlock Text="{TemplateBinding Content}" FontFamily="Segoe MDL2 Assets" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="{TemplateBinding Foreground}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource TertiaryBackground}"/>
                </Trigger>
                <!-- Trigger for active (checked) state -->
                <Trigger Property="IsChecked" Value="True">
                    <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                    <Setter Property="Foreground" Value="White"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <Style x:Key="SegmentedRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource TertiaryBackground}"/>
            <Setter Property="BorderThickness" Value="1,1,0,1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{Binding Tag, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource CornerRadiusConverter}}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource TertiaryBackground}"/>
                </Trigger>
                <Trigger Property="IsChecked" Value="True">
                    <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryAccentBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <Style x:Key="SegmentedToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource TertiaryBackground}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{Binding Tag, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource CornerRadiusConverter}}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource TertiaryBackground}"/>
                </Trigger>
                <Trigger Property="IsChecked" Value="True">
                    <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryAccentBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Style for ComboBox ToggleButtons -->
        <Style x:Key="ComboBoxToggleButton" TargetType="ToggleButton">
            <Setter Property="Focusable" Value="False"/> 
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="templateRoot" 
                                Background="Transparent" 
                                Width="25" 
                                SnapsToDevicePixels="true">
                            <Path x:Name="arrow" 
                                  Data="F1 M 0,0 L 2.5,2.5 L 5,0 Z" 
                                  Fill="{StaticResource TextBrush}" 
                                  HorizontalAlignment="Center" 
                                  VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="true">
                                <Setter TargetName="arrow" Property="Data" Value="F1 M 0,2.5 L 2.5,0 L 5,2.5 Z" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
            
        <Style x:Key="GroupInternalTabControlStyle" TargetType="TabControl" BasedOn="{StaticResource {x:Type TabControl}}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabControl">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- 1. The Tab Bar is now a neutral container -->
                            <Border Grid.Row="0" Background="{DynamicResource TertiaryBackground}" CornerRadius="3,3,0,0" Padding="5,5,5,0">
                                <TabPanel IsItemsHost="True" Background="Transparent"/>
                            </Border>

                            <!-- 2. The Content Area's background is now directly bound to the SELECTED TAB's color -->
                            <Border Grid.Row="1" BorderThickness="0">
                                <Border.Background>
                                    <MultiBinding Converter="{StaticResource PriorityColorToBrushConverter}">
                                        <!-- This is the key change: we bind to the selected item's color -->
                                        <Binding Path="SelectedItem.HighlightColor" RelativeSource="{RelativeSource TemplatedParent}"/>
                                        <!-- Fallback to the default content color if the tab has no color -->
                                        <Binding Source="{StaticResource SecondaryBackground}"/>
                                    </MultiBinding>
                                </Border.Background>
                                <ContentPresenter ContentSource="SelectedContent"/>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

            
<Style x:Key="GroupInternalTabItemStyle" TargetType="TabItem">
            <Setter Property="Foreground" Value="{DynamicResource TextBrush}"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="0,0,2,0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="BackgroundBorder" CornerRadius="3,3,0,0">
                            <Border.Background>
                                <MultiBinding Converter="{StaticResource PriorityColorToBrushConverter}">
                                    <Binding Path="HighlightColor"/>
                                    <Binding Source="{StaticResource TertiaryBackground}"/>
                                </MultiBinding>
                            </Border.Background>

                            <Grid>
                                <!-- NEW: A thin line that will only be visible for the active tab -->
                                <Border x:Name="ActiveTabIndicator" 
                                        Height="2" 
                                        Background="{StaticResource PrimaryAccentBrush}"
                                        VerticalAlignment="Top"
                                        CornerRadius="2,2,0,0"
                                        Visibility="Collapsed"/>

                            <Border x:Name="StateOverlay">
                                    <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                                </Border>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <!-- Style for the INACTIVE tab: apply a darkening overlay -->
                            <Trigger Property="IsSelected" Value="False">
                                <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
                                <Setter TargetName="StateOverlay" Property="Background" Value="#40000000"/>
                            </Trigger>
                            
                            <!-- Style for the SELECTED tab -->
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{DynamicResource TextBrush}"/>
                                <Setter TargetName="StateOverlay" Property="Background" Value="Transparent"/>
                                <!-- Show the top indicator line -->
                                <Setter TargetName="ActiveTabIndicator" Property="Visibility" Value="Visible"/>
                                <!-- This is the key to the "folder" effect -->
                                <Setter TargetName="BackgroundBorder" Property="Background">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource PriorityColorToBrushConverter}">
                                            <Binding Path="HighlightColor"/>
                                            <Binding Source="{StaticResource SecondaryBackground}"/>
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <!-- Style for hovering over an UNSELECTED tab -->
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsSelected" Value="False"/>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                </MultiTrigger.Conditions>
                                <Setter Property="Foreground" Value="{DynamicResource TextBrush}"/>
                                <Setter TargetName="StateOverlay" Property="Background" Value="#20FFFFFF"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    

    
    
    <!-- Custom Window Style -->
        <Style x:Key="CustomWindowStyle" TargetType="Window">
            <Setter Property="WindowStyle" Value="None"/>
            <Setter Property="AllowsTransparency" Value="True"/>
            <Setter Property="Background" Value="{StaticResource PrimaryBackground}"/>
            <EventSetter Event="Loaded" Handler="Window_Loaded"/>
            <EventSetter Event="Button.Click" Handler="WorkflowField_ButtonClick"/>
            
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Window">
                        <ControlTemplate.Resources>
                            
                        </ControlTemplate.Resources>
                        
                        <Border BorderBrush="{StaticResource PrimaryAccentBrush}" BorderThickness="1" Background="{TemplateBinding Background}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="32"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <Border x:Name="TitleBar" Grid.Row="0" Background="{StaticResource SecondaryBackground}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Image Grid.Column="0" Source="{Binding Icon, RelativeSource={RelativeSource TemplatedParent}}" Height="16" Margin="8,0"/>
                                        <TextBlock Grid.Column="1" Text="{Binding Title, RelativeSource={RelativeSource TemplatedParent}}" VerticalAlignment="Center" Foreground="{StaticResource TextBrush}"/>

                                        <StackPanel Grid.Column="2" Orientation="Horizontal">
                                            <Button x:Name="MinimizeButton" Style="{StaticResource SystemButton}" Content="M 0 5 H 10" ToolTip="{local:Translate Window_Minimize}"/>
                                            <Button x:Name="MaximizeButton" Style="{StaticResource SystemButton}" Content="M 0 0 H 10 V 10 H 0 Z" ToolTip="{local:Translate Window_Maximize}"/>
                                            <Button x:Name="RestoreButton" Style="{StaticResource SystemButton}" Content="M 0 2 H 8 V 10 H 0 Z M 2 0 H 10 V 8 H 2 Z" Visibility="Collapsed" ToolTip="{local:Translate Window_Restore}"/>
                                            <Button x:Name="CloseButton" Style="{StaticResource SystemButtonClose}" Content="M 0 0 L 10 10 M 10 0 L 0 10" ToolTip="{local:Translate Window_Close}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <ContentPresenter Grid.Row="1"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="WindowState" Value="Maximized">
                                <Setter TargetName="MaximizeButton" Property="Visibility" Value="Collapsed"/>
                                <Setter TargetName="RestoreButton" Property="Visibility" Value="Visible"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <Style x:Key="ToolWindowStyle" TargetType="Window">
            <Setter Property="WindowStyle" Value="None"/>
            <Setter Property="AllowsTransparency" Value="True"/>
            <Setter Property="Background" Value="{StaticResource PrimaryBackground}"/>
            <EventSetter Event="Loaded" Handler="Window_Loaded"/>
            <EventSetter Event="Thumb.DragDelta" Handler="OnResizeThumbDragDelta"/>
            <EventSetter Event="Button.Click" Handler="WorkflowField_ButtonClick"/>
            
            <Setter Property="local:InputBindingBehavior.InputBindings">
                <Setter.Value>
                    <InputBindingCollection>
                        <KeyBinding Command="{x:Static local:MainViewModel.GlobalQueueCommand}" Gesture="Ctrl+Enter" />
                    </InputBindingCollection>
                </Setter.Value>
            </Setter>
            
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Window">
                        <Border BorderBrush="{StaticResource PrimaryAccentBrush}" BorderThickness="1" Background="{TemplateBinding Background}" CornerRadius="3">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <!-- Reduced height for a more compact title bar -->
                                    <RowDefinition Height="26"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <Border Grid.Row="0" Grid.RowSpan="2" Opacity="0.15">
                                    <Border.Background>
                                        <Binding Path="HighlightColor" Converter="{StaticResource HexToBrushConverter}"/>
                                    </Border.Background>
                                </Border>

                                <Border x:Name="TitleBar" Grid.Row="0" Background="{StaticResource SecondaryBackground}" CornerRadius="3,3,0,0">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Grid.ColumnSpan="2" Opacity="0.3">
                                            <Border.Background>
                                                <Binding Path="HighlightColor" Converter="{StaticResource HexToBrushConverter}"/>
                                            </Border.Background>
                                        </Border>
                                        
                                        <TextBlock Grid.Column="0" Text="{Binding Title, RelativeSource={RelativeSource TemplatedParent}}" VerticalAlignment="Center" Foreground="{StaticResource TextBrush}" Margin="8,0" FontWeight="Bold"/>
                                        
                                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                                            <!-- The preset controls will be inserted here -->
                                            <ContentPresenter Content="{Binding DataContext, RelativeSource={RelativeSource TemplatedParent}}" 
                                                              ContentTemplate="{DynamicResource GroupHeaderPresetControls}"/>
                                            
                                            <!-- Only the Close button remains -->
                                            <Button x:Name="CloseButton" Style="{StaticResource SystemButtonClose}" Content="M 0 0 L 10 10 M 10 0 L 0 10" 
                                                    ToolTip="{local:Translate Window_Close}"
                                                    Width="32" Height="26"/> <!-- Adjusted size -->
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <ContentPresenter Grid.Row="1"/>
                            </Grid>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

            
        <!-- Style for the Video Slider -->
        <Style x:Key="VideoSliderStyle" TargetType="{x:Type Slider}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/> <!-- Default color for the thumb -->
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Height" Value="24"/> <!-- Overall height for easier interaction -->
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Slider}">
                        <Grid VerticalAlignment="Center">
                            <!-- 1. The track's background. This is just a visual element. -->
                            <Border x:Name="TrackBackground"
                                    VerticalAlignment="Center"
                                    Height="4"
                                    CornerRadius="2"
                                    Background="#55FFFFFF" />

                            <!-- 2. The logical Track panel. It's invisible, but its height is large enough to contain the thumb. -->
                            <Track x:Name="PART_Track"
                                   Height="16"> <!-- <<<< KEY CHANGE: Track height matches the thumb height -->

                                <!-- The progress part (blue) -->
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="{x:Static Slider.DecreaseLarge}">
                                        <RepeatButton.Template>
                                            <ControlTemplate TargetType="RepeatButton">
                                                <!-- The visual part of the progress bar. It's thin and centered. -->
                                                <Border VerticalAlignment="Center"
                                                        Height="4"
                                                        CornerRadius="2,0,0,2"
                                                        Background="{StaticResource PrimaryAccentBrush}" />
                                            </ControlTemplate>
                                        </RepeatButton.Template>
                                    </RepeatButton>
                                </Track.DecreaseRepeatButton>

                                <!-- The remaining part -->
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="{x:Static Slider.IncreaseLarge}">
                                        <RepeatButton.Template>
                                            <ControlTemplate TargetType="RepeatButton">
                                                <Border Background="Transparent" />
                                            </ControlTemplate>
                                        </RepeatButton.Template>
                                    </RepeatButton>
                                </Track.IncreaseRepeatButton>

                                <!-- 3. The thumb. It now fits completely inside the Track panel and is not clipped. -->
                                <Track.Thumb>
                                    <Thumb x:Name="Thumb"
                                           Width="16" Height="16"
                                           Background="{TemplateBinding Foreground}">
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="{x:Type Thumb}">
                                                <Grid>
                                                    <!-- Glow effect on hover/drag -->
                                                    <Ellipse x:Name="Glow" Fill="{StaticResource PrimaryAccentBrush}" Opacity="0" Width="24" Height="24">
                                                        <Ellipse.Effect>
                                                            <BlurEffect Radius="8"/>
                                                        </Ellipse.Effect>
                                                    </Ellipse>
                                                    <!-- The main thumb circle -->
                                                    <Ellipse x:Name="Circle" Fill="{TemplateBinding Background}" Width="12" Height="12"/>
                                                </Grid>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="Glow" Property="Opacity" Value="0.4"/>
                                                    </Trigger>
                                                    <Trigger Property="IsDragging" Value="True">
                                                        <Setter TargetName="Glow" Property="Opacity" Value="0.7"/>
                                                        <Setter TargetName="Circle" Property="Fill" Value="{StaticResource PrimaryAccentBrush}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Global Tooltip Style -->
        <Style TargetType="ToolTip">
            <Setter Property="Background" Value="{StaticResource SecondaryBackground}"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource TertiaryBackground}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToolTip">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3">
                            <ContentPresenter Margin="{TemplateBinding Padding}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Base Button Style -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True"><Setter Property="Background" Value="#FF3C90D1"/></Trigger>
                <Trigger Property="IsEnabled" Value="False"><Setter Property="Opacity" Value="0.6"/></Trigger>
            </Style.Triggers>
        </Style>
        
        <Style x:Key="TextButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <TextBlock x:Name="Text" Text="{TemplateBinding Content}"
                                   VerticalAlignment="Center"/>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                <Setter TargetName="Text" Property="TextDecorations" Value="Underline"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="Gray"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Icon Button Style -->
        <Style x:Key="IconButton" TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Width" Value="30"/>
            <Setter Property="Height" Value="30"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="3" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}">
                            <TextBlock Text="{TemplateBinding Content}" 
                                       FontFamily="{TemplateBinding FontFamily}" 
                                       VerticalAlignment="Center" HorizontalAlignment="Center" 
                                       Foreground="{TemplateBinding Foreground}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                 <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource TertiaryBackground}"/>
                 </Trigger>
                 <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                 </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Overlay Icon Button Style -->
        <Style x:Key="OverlayIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource TertiaryBackground}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <Style x:Key="IconFontOverlayButton" TargetType="Button" BasedOn="{StaticResource OverlayIconButton}">
            <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
        </Style>

        <!-- Global Control Styles -->
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        
        <Style TargetType="TextBox">
            <Setter Property="Background" Value="{StaticResource SecondaryBackground}"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource TertiaryBackground}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="CaretBrush" Value="{StaticResource TextBrush}"/>
            <Setter Property="SelectionBrush" Value="{StaticResource PrimaryAccentBrush}"/>
        </Style>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="5"/>
            <Style.Triggers>
                <Trigger Property="IsHighlighted" Value="True"><Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}"/></Trigger>
            </Style.Triggers>
        </Style>

            
        <ControlTemplate x:Key="DarkComboBoxTemplate" TargetType="ComboBox">
            <Grid>
                <ToggleButton x:Name="ToggleButton" Grid.Column="2" Focusable="false" IsChecked="{Binding Path=IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}" Style="{x:Null}">
                    <ToggleButton.Template>
                        <ControlTemplate TargetType="ToggleButton">
                            <Border x:Name="templateRoot" Background="{StaticResource SecondaryBackground}" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="1" SnapsToDevicePixels="true">
                                <Path x:Name="arrow" Data="F1 M 0,0 L 2.5,2.5 L 5,0 Z" Fill="{StaticResource TextBrush}" HorizontalAlignment="Right" Margin="0,0,8,0" VerticalAlignment="Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="true"><Setter TargetName="templateRoot" Property="BorderBrush" Value="{StaticResource PrimaryAccentBrush}" /></Trigger>
                                <Trigger Property="IsChecked" Value="true"><Setter TargetName="arrow" Property="Data" Value="F1 M 0,2.5 L 2.5,0 L 5,2.5 Z" /></Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </ToggleButton.Template>
                </ToggleButton>
                
                <!-- START OF CHANGE: Added an editable TextBox and a trigger to show it -->
                <TextBox x:Name="PART_EditableTextBox"
                         Style="{StaticResource {x:Type TextBox}}"
                         Background="Transparent"
                         BorderThickness="0"
                         Padding="0"
                         VerticalAlignment="Center"
                         Margin="5,3,23,3"
                         Text="{Binding Text, RelativeSource={RelativeSource TemplatedParent}, UpdateSourceTrigger=PropertyChanged}"
                         Visibility="Hidden"/>
                
                <ContentPresenter x:Name="ContentSite" IsHitTestVisible="False" Content="{TemplateBinding SelectionBoxItem}" ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}" ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}" Margin="5,3,23,3" VerticalAlignment="Center" HorizontalAlignment="Left" />
                
                <Popup x:Name="PART_Popup" AllowsTransparency="true" Focusable="false" IsOpen="{Binding Path=IsDropDownOpen, RelativeSource={RelativeSource TemplatedParent}}" Placement="Bottom" PopupAnimation="Slide">
                    <Border x:Name="dropDownBorder" Background="{StaticResource SecondaryBackground}" BorderBrush="{StaticResource TertiaryBackground}" BorderThickness="1" MaxHeight="{TemplateBinding MaxDropDownHeight}" MinWidth="{Binding Path=ActualWidth, ElementName=ToggleButton}">
                        <ScrollViewer CanContentScroll="true">
                            <ItemsPresenter KeyboardNavigation.DirectionalNavigation="Contained" />
                        </ScrollViewer>
                    </Border>
                </Popup>
            </Grid>
            <ControlTemplate.Triggers>
                <Trigger Property="IsEditable" Value="True">
                    <Setter Property="Visibility" TargetName="ContentSite" Value="Hidden"/>
                    <Setter Property="Visibility" TargetName="PART_EditableTextBox" Value="Visible"/>
                </Trigger>
            </ControlTemplate.Triggers>
            <!-- END OF CHANGE -->
        </ControlTemplate>

  

        <Style TargetType="ComboBox">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource TertiaryBackground}"/>
            <Setter Property="Template" Value="{StaticResource DarkComboBoxTemplate}"/>
        </Style>

        <Style TargetType="{x:Type RadioButton}">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type RadioButton}">
                        <Grid Background="Transparent">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Ellipse x:Name="RadioCircle" Stroke="{StaticResource TextSecondaryBrush}" StrokeThickness="1" Width="14" Height="14"/>
                            <Ellipse x:Name="RadioMark" Fill="{StaticResource PrimaryAccentBrush}" Width="8" Height="8" Visibility="Collapsed"/>
                            <ContentPresenter Grid.Column="1" Margin="5,0,0,0" RecognizesAccessKey="True" VerticalAlignment="Center"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True"><Setter TargetName="RadioMark" Property="Visibility" Value="Visible"/><Setter TargetName="RadioCircle" Property="Stroke" Value="{StaticResource PrimaryAccentBrush}"/></Trigger>
                            <Trigger Property="IsMouseOver" Value="True"><Setter TargetName="RadioCircle" Property="Stroke" Value="{StaticResource TextBrush}"/></Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Expander">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource TertiaryBackground}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Expander">
                        <Border BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="3" 
                                Background="{TemplateBinding Background}">
                            <DockPanel>
                                <ToggleButton DockPanel.Dock="Top" IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}" OverridesDefaultStyle="True" Content="{TemplateBinding Header}" ContentTemplate="{TemplateBinding HeaderTemplate}">
                                    <ToggleButton.Template>
                                        <ControlTemplate TargetType="ToggleButton">
                                            <!-- And the ToggleButton's background is transparent so the parent color shows through -->
                                            <Border Padding="8" Background="Transparent">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock x:Name="Arrow" Grid.Column="0" Text="&#xE76C;" FontFamily="Segoe MDL2 Assets" VerticalAlignment="Center"/>
                                                    <ContentPresenter Grid.Column="1" Margin="5,0,0,0" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" RecognizesAccessKey="True"/>
                                                </Grid>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsChecked" Value="True"><Setter TargetName="Arrow" Property="Text" Value="&#xE70D;"/></Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </ToggleButton.Template>
                                </ToggleButton>
                                <ContentPresenter x:Name="ContentSite" DockPanel.Dock="Bottom" Visibility="Collapsed" Margin="8"/>
                            </DockPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsExpanded" Value="True"><Setter TargetName="ContentSite" Property="Visibility" Value="Visible"/></Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        
        <Style x:Key="WorkflowTabControlStyle" TargetType="TabControl">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabControl">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="{Binding Items.Count, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource TabCountToHeaderHeightConverter}}"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            <!-- This Border acts as the "tab bar" background -->
                                            <Border Grid.Row="0" Background="{StaticResource TertiaryBackground}" CornerRadius="3" Padding="5,5,5,0">
                                                <TabPanel IsItemsHost="True" Background="Transparent"/>
                                            </Border>
                                            <Border Grid.Row="1" Background="Transparent" BorderThickness="0">
                                                <ContentPresenter ContentSource="SelectedContent"/>
                                            </Border>
                                        </Grid>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                
                        <Style x:Key="WorkflowTabItemStyle" TargetType="TabItem">
                            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Padding" Value="10,6"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <!-- This Border is the clickable tab itself -->
                                        <Border x:Name="Border" 
                                        Background="{TemplateBinding Background}" 
                                        BorderThickness="0" 
                                        CornerRadius="3,3,0,0" 
                                        Margin="0,0,2,0"
                                        Padding="{TemplateBinding Padding}">
                                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <!-- Style for the selected tab -->
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                                <!-- The background matches the content area, making it look connected -->
                                                <Setter TargetName="Border" Property="Background" Value="{StaticResource SecondaryBackground}"/>
                                            </Trigger>
                                            <!-- Style for hovering over an unselected tab -->
                                            <MultiTrigger>
                                                <MultiTrigger.Conditions>
                                                    <Condition Property="IsSelected" Value="False"/>
                                                    <Condition Property="IsMouseOver" Value="True"/>
                                                </MultiTrigger.Conditions>
                                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                                <Setter TargetName="Border" Property="Background" Value="{StaticResource PrimaryBackground}"/>
                                            </MultiTrigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
        
        <!-- Input Field MVVM Templates -->
        
        <!-- ADD: Reusable template for group preset controls -->
        <DataTemplate x:Key="GroupHeaderPresetControls">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right"
                        MouseLeftButtonDown="StopRoutedEventPropagation"
                        MouseLeftButtonUp="StopRoutedEventPropagation"
                        ButtonBase.Click="StopRoutedEventPropagation"
                        ToggleButton.Checked="StopRoutedEventPropagation"
                        ToggleButton.Unchecked="StopRoutedEventPropagation">
                
                <!-- Status Text -->
                <TextBlock Text="{Binding CurrentStateStatus}" 
                           VerticalAlignment="Center" 
                           Foreground="{StaticResource TextSecondaryBrush}" 
                           TextTrimming="CharacterEllipsis"
                           TextWrapping="NoWrap"
                           HorizontalAlignment="Right"
                           Visibility="{Binding HasPresets, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <!-- START OF NEW TOOLTIP -->
                    <TextBlock.ToolTip>
                        <ToolTip>
                            <StackPanel MinWidth="200" MaxWidth="400">
                                <!-- Tooltip Header -->
                                <TextBlock Text="{local:Translate Presets_ActiveLayers}" FontWeight="Bold" Margin="0,0,0,5"
                                           Visibility="{Binding ActiveLayers.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                                
                                <!-- List of Active Layers -->
                                <ItemsControl ItemsSource="{Binding ActiveLayers}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="{x:Type local:ActiveLayerViewModel}">
                                            <Grid Margin="0,1">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <!-- Layer Name -->
                                                <TextBlock Grid.Column="0" Text="{Binding Name}" TextTrimming="CharacterEllipsis"/>
                                                
                                                <!-- "Modified" State Indicator -->
                                                <TextBlock Grid.Column="1" Text="[ * ]" Foreground="Orange" FontWeight="SemiBold" Margin="8,0,0,0">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding State}" Value="{x:Static local:ActiveLayerViewModel+LayerState.Modified}">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Message for when no layers are active -->
                                <TextBlock Text="{local:Translate Presets_State_Unsaved}" FontStyle="Italic">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding ActiveLayers.Count, Converter={StaticResource CountToBooleanConverter}}" Value="False">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </ToolTip>
                    </TextBlock.ToolTip>
                    <!-- END OF NEW TOOLTIP -->
                </TextBlock>

                <!-- "Layers" Button and Popup -->
                <Grid>
                    <ToggleButton x:Name="PresetPanelToggle" 
                                  Content="&#xE8B4;" 
                                  FontFamily="Segoe MDL2 Assets" 
                                  Style="{StaticResource IconToggleButton}" 
                                  Width="24" Height="24"
                                  IsChecked="{Binding IsPresetPanelOpen, Mode=TwoWay}"
                                  ToolTip="{local:Translate Presets_LayersButtonTooltip}"/>
            
                    <Popup StaysOpen="False"
                           PlacementTarget="{Binding ElementName=PresetPanelToggle}"
                           Placement="Bottom"
                           AllowsTransparency="True">
                        <Popup.IsOpen>
                            <MultiBinding Converter="{StaticResource BooleanAndConverter}">
                                <Binding Path="IsChecked" ElementName="PresetPanelToggle" Mode="TwoWay"/>
                                <Binding Path="IsVisible" ElementName="PresetPanelToggle" Mode="OneWay"/>
                            </MultiBinding>
                        </Popup.IsOpen>
                
                        <Border DataContext="{Binding DataContext, ElementName=PresetPanelToggle}"
                                Background="{StaticResource SecondaryBackground}"
                                BorderBrush="{StaticResource TertiaryBackground}"
                                BorderThickness="1" CornerRadius="3" 
                                Padding="10" Margin="0,2,0,0"
                                MinWidth="350" MaxHeight="600"
                                MaxWidth="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Expander}}"
                                MouseLeftButtonDown="StopEventPropagation">
                    
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel>
                                    <!-- Search and Main Filters -->
                                    <Grid Margin="0,0,0,10">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                
                                        <TextBox Grid.Column="0"
                                                 Text="{Binding PresetSearchFilter, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                 local:TextBoxExtensions.PlaceholderText="{local:Translate Presets_SearchPlaceholder}"/>
                                
                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="5,0,0,0" VerticalAlignment="Center">
                                            <RadioButton Tag="First" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="PresetSort"
                                                         IsChecked="{Binding CurrentPresetSortOption, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:PresetSortOption.Alphabetical}}"
                                                         ToolTip="{local:Translate Presets_SortAlphabetical}">
                                                <TextBlock Text="A-Z" FontFamily="Segoe UI Symbol"/>
                                            </RadioButton>
                                            <RadioButton Tag="Last" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="PresetSort"
                                                         IsChecked="{Binding CurrentPresetSortOption, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:PresetSortOption.DateModified}}"
                                                         ToolTip="{local:Translate Presets_SortByDate}">
                                                <TextBlock Text="&#xE823;" FontFamily="Segoe MDL2 Assets"/>
                                            </RadioButton>
                                        </StackPanel>
                                    </Grid>
                                    
                                    <!-- Category and Tag Filters -->
                                    <Grid Margin="0,0,0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <ComboBox Grid.Column="0" Margin="0,0,5,0"
                                                  ItemsSource="{Binding AllCategories}"
                                                  SelectedItem="{Binding SelectedCategoryFilter, Mode=TwoWay}"/>
                                        <ComboBox Grid.Column="1" Margin="0,0,5,0"
                                                  ItemsSource="{Binding AllTags}"
                                                  SelectedItem="{Binding SelectedTagFilter, Mode=TwoWay}"/>
                                        <Button Grid.Column="2" 
                                                Content="&#xE711;"
                                                Style="{StaticResource IconButton}"
                                                Width="24" Height="24"
                                                Command="{Binding ClearPresetFiltersCommand}"
                                                ToolTip="{local:Translate Presets_ClearFilters}"/>
                                    </Grid>
                                    
                                    <!-- Field-based Filters (collapsible) -->
                                    <Expander Margin="0,5,0,0">
                                        <Expander.Header>
                                            <StackPanel Orientation="Horizontal">
                                                <ToggleButton IsChecked="{Binding IsFilterByFieldsActive, Mode=TwoWay}"
                                                              Style="{StaticResource SegmentedToggleButtonStyle}" Tag="First"
                                                              Content="{local:Translate Presets_FilterByFields}"
                                                              VerticalAlignment="Center"/>

                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="10,0,0,0">
                                                     <StackPanel.Style>
                                                        <Style TargetType="StackPanel">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsFilterByFieldsActive}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </StackPanel.Style>
                                                    <RadioButton Tag="Middle" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="PresetFilterLogic"
                                                                 IsChecked="{Binding CurrentPresetFilterLogic, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:PresetFilterLogic.OR}}">
                                                        <TextBlock Text="{local:Translate Presets_FilterLogicOR}"/>
                                                    </RadioButton>
                                                    <RadioButton Tag="Last" Style="{StaticResource SegmentedRadioButtonStyle}" GroupName="PresetFilterLogic"
                                                                 IsChecked="{Binding CurrentPresetFilterLogic, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:PresetFilterLogic.AND}}">
                                                        <TextBlock Text="{local:Translate Presets_FilterLogicAND}"/>
                                                    </RadioButton>
                                                </StackPanel>
                                            </StackPanel>
                                        </Expander.Header>
                                        <Border MaxHeight="150" Margin="0,5,0,0">
                                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                                <ItemsControl ItemsSource="{Binding FieldsForPresetFilter}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="{x:Type local:PresetFieldSelectionViewModel}">
                                                            <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" Margin="2" VerticalContentAlignment="Center">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <TextBlock Text="{Binding TabName, StringFormat='[{0}]'}" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,5,0"/>
                                                                    <TextBlock Text="{Binding Name}" />
                                                                </StackPanel>
                                                            </CheckBox>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </ScrollViewer>
                                        </Border>
                                    </Expander>

                                    <!-- Active Layers Section -->
                                    <TextBlock Text="{local:Translate Presets_ActiveLayers}" FontWeight="Bold" Margin="0,10,0,0"/>
                                    <ItemsControl ItemsSource="{Binding ActiveLayers}" Margin="0,5,0,10">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="{x:Type local:ActiveLayerViewModel}">
                                                <Border CornerRadius="3" Padding="5,3" Margin="0,2">
                                                    <Border.ToolTip>
                                                        <ToolTip MaxWidth="400">
                                                            <StackPanel>
                                                                <TextBlock Text="{Binding SourcePreset.Name}" FontWeight="Bold" Margin="0,0,0,5"/>
                                                                <Separator Margin="0,0,0,5"/>
                                                                <ItemsControl ItemsSource="{Binding SourcePreset.FieldDetails}">
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate DataType="{x:Type local:PresetFieldInfo}">
                                                                            <TextBlock TextWrapping="Wrap">
                                                                                <Run Text="{Binding FieldName}" FontWeight="SemiBold"/>
                                                                                <TextBlock Text="{Binding TabName, StringFormat=' ({0})'}" Foreground="{StaticResource TextSecondaryBrush}">
                                                                                    <TextBlock.Style>
                                                                                        <Style TargetType="TextBlock">
                                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                                            <Style.Triggers>
                                                                                                <DataTrigger Binding="{Binding ShowTabName}" Value="True">
                                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                                </DataTrigger>
                                                                                            </Style.Triggers>
                                                                                        </Style>
                                                                                    </TextBlock.Style>
                                                                                </TextBlock>
                                                                                <Run Text=": "/>
                                                                                <Run Text="{Binding FieldValue}" Foreground="#E6DB74"/>
                                                                            </TextBlock>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                                <StackPanel>
                                                                    <StackPanel.Style>
                                                                        <Style TargetType="StackPanel">
                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding State}" Value="Modified">
                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </StackPanel.Style>
                                                                    <Separator Margin="0,5,0,5"/>
                                                                    <TextBlock Text="{local:Translate Presets_State_Modified_Tooltip}" FontStyle="Italic" Foreground="Orange"/>
                                                                </StackPanel>
                                                            </StackPanel>
                                                        </ToolTip>
                                                    </Border.ToolTip>
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding State}" Value="Modified">
                                                                    <Setter Property="Background" Value="Orange"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                
                                                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding Name}" VerticalAlignment="Center" TextWrapping="Wrap"/>
                                                            <TextBlock Text="*" FontWeight="Bold" Margin="2,0,0,0" VerticalAlignment="Center">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding State}" Value="Modified">
                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </StackPanel>
                                                        <!-- END OF XAML FIX -->

                                                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                            <Button Content="&#xE74E;" Style="{StaticResource IconButton}" Width="20" Height="20" ToolTip="{local:Translate Presets_UpdateTooltip}"
                                                                    Command="{Binding DataContext.UpdateLayerCommand, RelativeSource={RelativeSource AncestorType=Popup}}"
                                                                    CommandParameter="{Binding}"/>
                                                            <Button Content="&#xE72C;" Style="{StaticResource IconButton}" Width="20" Height="20" ToolTip="{local:Translate Presets_ReapplyTooltip}"
                                                                    Command="{Binding DataContext.ReapplyLayerCommand, RelativeSource={RelativeSource AncestorType=Popup}}"
                                                                    CommandParameter="{Binding}"/>
                                                            <Button Content="&#xE711;" Style="{StaticResource IconButton}" Width="20" Height="20" ToolTip="{local:Translate Presets_DetachTooltip}"
                                                                    Command="{Binding DataContext.DetachLayerCommand, RelativeSource={RelativeSource AncestorType=Popup}}"
                                                                    CommandParameter="{Binding}"/>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Layouts Section -->
                                    <TextBlock Text="{local:Translate Presets_Layouts}" FontWeight="Bold" Visibility="{Binding FilteredLayouts.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                                    <ItemsControl ItemsSource="{Binding FilteredLayoutsView}" Margin="0,5,0,10">
                                        <ItemsControl.GroupStyle>
                                            <GroupStyle>
                                                <GroupStyle.HeaderTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,5,0,2" Foreground="{StaticResource TextSecondaryBrush}"
                                                                   Visibility="{Binding Name, Converter={StaticResource StringToVisibilityConverter}}"/>
                                                    </DataTemplate>
                                                </GroupStyle.HeaderTemplate>
                                            </GroupStyle>
                                        </ItemsControl.GroupStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="{x:Type local:GroupPresetViewModel}">
                                                <Button Command="{Binding DataContext.ApplyPresetCommand, RelativeSource={RelativeSource AncestorType=Popup}}" CommandParameter="{Binding}" 
                                                        HorizontalContentAlignment="Stretch">
                                                    <Button.ToolTip>
                                                        <ToolTip MaxWidth="400">
                                                            <StackPanel>
                                                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,0,5"/>
                                                                
                                                                <TextBlock Text="{Binding Model.Description}" TextWrapping="Wrap" FontStyle="Italic"
                                                                           Visibility="{Binding Model.Description, Converter={StaticResource StringToIsNotNullOrEmptyConverter}}"/>
                                                                
                                                                <TextBlock Margin="0,5,0,0" Visibility="{Binding Model.Tags.Count, Converter={StaticResource CountToVisibilityConverter}}">
                                                                    <Run Text="Tags:" FontWeight="SemiBold"/>
                                                                    <Run Text="{Binding Model.Tags, Converter={StaticResource StringListConverter}}"/>
                                                                </TextBlock>

                                                                <Separator Margin="0,5,0,5"/>
                                                                <ItemsControl ItemsSource="{Binding FieldDetails}">
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate DataType="{x:Type local:PresetFieldInfo}">
                                                                            <TextBlock TextWrapping="Wrap">
                                                                                <Run Text="{Binding FieldName}" FontWeight="SemiBold"/>
                                                                                <TextBlock Text="{Binding TabName, StringFormat=' ({0})'}" Foreground="{StaticResource TextSecondaryBrush}">
                                                                                    <TextBlock.Style>
                                                                                        <Style TargetType="TextBlock">
                                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                                            <Style.Triggers>
                                                                                                <DataTrigger Binding="{Binding ShowTabName}" Value="True">
                                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                                </DataTrigger>
                                                                                            </Style.Triggers>
                                                                                        </Style>
                                                                                    </TextBlock.Style>
                                                                                </TextBlock>
                                                                                <Run Text=": "/>
                                                                                <Run Text="{Binding FieldValue}" Foreground="#E6DB74"/>
                                                                            </TextBlock>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                            </StackPanel>
                                                        </ToolTip>
                                                    </Button.ToolTip>
                                                    <Grid Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Button}}">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        <ToggleButton Content="&#xE734;" IsChecked="{Binding IsFavorite, Mode=OneWay}"
                                                                      Command="{Binding DataContext.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=Popup}}" CommandParameter="{Binding}"
                                                                      Width="20" Height="20">
                                                            <ToggleButton.Style>
                                                                <Style TargetType="ToggleButton" BasedOn="{StaticResource IconToggleButton}">
                                                                    <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                                                    <Setter Property="Visibility" Value="Hidden"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Setter Property="Foreground" Value="Gold"/>
                                                                            <Setter Property="Content" Value="&#xE735;"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Button}}" Value="True">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </ToggleButton.Style>
                                                        </ToggleButton>
                                                        <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" Margin="5,0,0,0" TextWrapping="Wrap"/>
                                                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                                            <Button Content="&#xE70F;" Style="{StaticResource IconButton}" Width="20" Height="20" ToolTip="{local:Translate Presets_UpdateTooltip}"
                                                                    Command="{Binding DataContext.StartUpdatePresetCommand, RelativeSource={RelativeSource AncestorType=Popup}}"
                                                                    CommandParameter="{Binding}"/>
                                                            <Button Content="&#xE74D;" Style="{StaticResource IconButton}" Width="20" Height="20" ToolTip="{local:Translate Presets_DeleteTooltip}"
                                                                    Command="{Binding DataContext.DeletePresetCommand, RelativeSource={RelativeSource AncestorType=Popup}}"
                                                                    CommandParameter="{Binding Name}"/>
                                                            <StackPanel.Style>
                                                                <Style TargetType="StackPanel">
                                                                    <Setter Property="Visibility" Value="Hidden"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Button}}" Value="True">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </StackPanel.Style>
                                                        </StackPanel>
                                                    </Grid>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Snippets Section -->
                                    <TextBlock Text="{local:Translate Presets_Snippets}" FontWeight="Bold" Visibility="{Binding Snippets.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                                    <ItemsControl ItemsSource="{Binding FilteredSnippetsView}" Margin="0,5,0,0">
                                         <ItemsControl.GroupStyle>
                                            <GroupStyle>
                                                <GroupStyle.HeaderTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,5,0,2" Foreground="{StaticResource TextSecondaryBrush}"
                                                                   Visibility="{Binding Name, Converter={StaticResource StringToVisibilityConverter}}"/>
                                                    </DataTemplate>
                                                </GroupStyle.HeaderTemplate>
                                            </GroupStyle>
                                        </ItemsControl.GroupStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="{x:Type local:GroupPresetViewModel}">
                                                <Button Command="{Binding DataContext.ApplyPresetCommand, RelativeSource={RelativeSource AncestorType=Popup}}" CommandParameter="{Binding}" 
                                                        HorizontalContentAlignment="Stretch">
                                                    <Button.ToolTip>
                                                        <ToolTip MaxWidth="400">
                                                             <StackPanel>
                                                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,0,5"/>
                                                                
                                                                <TextBlock Text="{Binding Model.Description}" TextWrapping="Wrap" FontStyle="Italic"
                                                                           Visibility="{Binding Model.Description, Converter={StaticResource StringToIsNotNullOrEmptyConverter}}"/>
                                                                
                                                                <TextBlock Margin="0,5,0,0" Visibility="{Binding Model.Tags.Count, Converter={StaticResource CountToVisibilityConverter}}">
                                                                    <Run Text="Tags:" FontWeight="SemiBold"/>
                                                                    <Run Text="{Binding Model.Tags, Converter={StaticResource StringListConverter}}"/>
                                                                </TextBlock>

                                                                <Separator Margin="0,5,0,5"/>
                                                                <ItemsControl ItemsSource="{Binding FieldDetails}">
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate DataType="{x:Type local:PresetFieldInfo}">
                                                                            <TextBlock TextWrapping="Wrap">
                                                                                <Run Text="{Binding FieldName}" FontWeight="SemiBold"/>
                                                                                <TextBlock Text="{Binding TabName, StringFormat=' ({0})'}" Foreground="{StaticResource TextSecondaryBrush}">
                                                                                    <TextBlock.Style>
                                                                                        <Style TargetType="TextBlock">
                                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                                            <Style.Triggers>
                                                                                                <DataTrigger Binding="{Binding ShowTabName}" Value="True">
                                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                                </DataTrigger>
                                                                                            </Style.Triggers>
                                                                                        </Style>
                                                                                    </TextBlock.Style>
                                                                                </TextBlock>
                                                                                <Run Text=": "/>
                                                                                <Run Text="{Binding FieldValue}" Foreground="#E6DB74"/>
                                                                            </TextBlock>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                            </StackPanel>
                                                        </ToolTip>
                                                    </Button.ToolTip>
                                                    <Grid Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Button}}">
                                                        <Grid.ColumnDefinitions>
                                                             <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        <ToggleButton Grid.Column="0" Content="&#xE734;" IsChecked="{Binding IsFavorite, Mode=OneWay}"
                                                                      Command="{Binding DataContext.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=Popup}}" CommandParameter="{Binding}"
                                                                      Width="20" Height="20">
                                                            <ToggleButton.Style>
                                                                <Style TargetType="ToggleButton" BasedOn="{StaticResource IconToggleButton}">
                                                                    <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                                                    <Setter Property="Visibility" Value="Hidden"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Setter Property="Foreground" Value="Gold"/>
                                                                            <Setter Property="Content" Value="&#xE735;"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Button}}" Value="True">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </ToggleButton.Style>
                                                        </ToggleButton>
                                                        <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" Margin="5,0,0,0" TextWrapping="Wrap"/>
                                                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                                            <Button Content="&#xE70F;" Style="{StaticResource IconButton}" Width="20" Height="20" ToolTip="{local:Translate Presets_UpdateTooltip}"
                                                                    Command="{Binding DataContext.StartUpdatePresetCommand, RelativeSource={RelativeSource AncestorType=Popup}}"
                                                                    CommandParameter="{Binding}"/>
                                                            <Button Content="&#xE74D;" Style="{StaticResource IconButton}" Width="20" Height="20" ToolTip="{local:Translate Presets_DeleteTooltip}"
                                                                    Command="{Binding DataContext.DeletePresetCommand, RelativeSource={RelativeSource AncestorType=Popup}}"
                                                                    CommandParameter="{Binding Name}"/>
                                                            <StackPanel.Style>
                                                                <Style TargetType="StackPanel">
                                                                    <Setter Property="Visibility" Value="Hidden"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Button}}" Value="True">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </StackPanel.Style>
                                                        </StackPanel>
                                                    </Grid>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>
                    </Popup>
                </Grid>

                <Grid>
                    <ToggleButton x:Name="SavePresetToggle" 
                                  Content="&#xE74E;" FontFamily="Segoe MDL2 Assets" 
                                  Style="{StaticResource IconToggleButton}" Width="24" Height="24"
                                  IsChecked="{Binding IsSavePresetPopupOpen, Mode=TwoWay}"
                                  ToolTip="{local:Translate Presets_SaveButton}"/>
                    
                    <Popup PlacementTarget="{Binding ElementName=SavePresetToggle}"
                           StaysOpen="False"
                           Placement="Bottom"
                           AllowsTransparency="True"
                           Opened="PresetPopup_Opened">
                        <Popup.IsOpen>
                            <MultiBinding Converter="{StaticResource BooleanAndConverter}">
                                <Binding Path="IsChecked" ElementName="SavePresetToggle" Mode="TwoWay"/>
                                <Binding Path="IsVisible" ElementName="SavePresetToggle" Mode="OneWay"/>
                            </MultiBinding>
                        </Popup.IsOpen>
                        <Border
                            Background="{StaticResource SecondaryBackground}"
                            BorderBrush="{StaticResource TertiaryBackground}"
                            BorderThickness="1"
                            CornerRadius="3" Padding="10"
                            Margin="0,2,0,0">
                            <StackPanel MinWidth="300">
                                <TextBlock
                                    FontWeight="Bold"
                                    Margin="0,0,0,10">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="{local:Translate Presets_SaveCurrentState}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsUpdateMode}" Value="True">
                                                    <Setter Property="Text" Value="{local:Translate Presets_UpdatePreset}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>

                                <!-- Preset Name Input -->
                                <TextBlock Text="Name" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,2"/>
                                <TextBox x:Name="PresetNameTextBox"
                                    Text="{Binding NewPresetName, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,8"/>
                                
                                <!-- Description -->
                                <TextBlock Text="Description (Optional)" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,2"/>
                                <TextBox Text="{Binding NewPresetDescription, UpdateSourceTrigger=PropertyChanged}" MinLines="2" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto" Margin="0,0,0,8"/>
                                
                                <!-- Category -->
                                <TextBlock Text="Category (Optional)" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,2"/>
                                <ComboBox IsEditable="True" ItemsSource="{Binding AllCategories}" Text="{Binding NewPresetCategory, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,8"
                                          local:TextBoxExtensions.PlaceholderText="Выберите или создайте категорию"/>

                                <!-- Tags -->
                                <TextBlock Text="Tags" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,2"/>
                                <local:TagEditor Tags="{Binding NewPresetTags}" 
                                                 AvailableTags="{Binding AllTags}"
                                                 Margin="0,0,0,8"/>

                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition
                                            Height="Auto" />
                                        <RowDefinition
                                            Height="Auto" />
                                        <RowDefinition
                                            Height="Auto" />
                                    </Grid.RowDefinitions>
                                    
                                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,8,0,0">
                                        <RadioButton Content="{local:Translate Presets_SaveAsSnippet}" GroupName="PresetType"
                                            IsChecked="{Binding NewPresetType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:WorkflowGroupViewModel+SavePresetType.Snippet}}"/>
                                        <RadioButton Content="{local:Translate Presets_SaveAsLayout}" GroupName="PresetType" Margin="15,0,0,0"
                                            IsChecked="{Binding NewPresetType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:WorkflowGroupViewModel+SavePresetType.Layout}}"/>
                                    </StackPanel>

                                    <!-- Field Selection List -->
                                    <Border Grid.Row="1"
                                        BorderBrush="{StaticResource TertiaryBackground}"
                                        BorderThickness="0,1"
                                        Margin="0,8"
                                        Padding="0,8,0,5">
                                        <StackPanel>
                                            <!-- START OF CHANGE: Disable field list for layouts -->
                                            <StackPanel.Style>
                                                <Style TargetType="StackPanel">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding NewPresetType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:WorkflowGroupViewModel+SavePresetType.Layout}}" Value="True">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </StackPanel.Style>
                                            <!-- END OF CHANGE -->
                                            <TextBlock
                                                Text="{local:Translate Presets_FieldsToInclude}"
                                                Margin="0,0,0,5"
                                                Foreground="{StaticResource TextSecondaryBrush}" />
                                            <ScrollViewer
                                                MaxHeight="200"
                                                VerticalScrollBarVisibility="Auto">
                                                <ItemsControl
                                                    ItemsSource="{Binding FieldsForPresetSelection}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="{x:Type local:PresetFieldSelectionViewModel}">
                                                            <CheckBox
                                                                IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                                Margin="2"
                                                                VerticalContentAlignment="Center">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <TextBlock Text="{Binding TabName, StringFormat='[{0}]'}" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,5,0"/>
                                                                    <TextBlock Text="{Binding Name}" />
                                                                </StackPanel>
                                                            </CheckBox>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </ScrollViewer>

                                            <StackPanel
                                                Orientation="Horizontal"
                                                Margin="2,5,0,0">
                                                <Button
                                                    Content="{local:Translate Presets_SelectAll}"
                                                    Command="{Binding SelectAllFieldsForPresetCommand}"
                                                    Style="{StaticResource TextButtonStyle}" />
                                                <Button
                                                    Content="{local:Translate Presets_DeselectAll}"
                                                    Command="{Binding DeselectAllFieldsForPresetCommand}"
                                                    Style="{StaticResource TextButtonStyle}"
                                                    Margin="10,0,0,0" />
                                            </StackPanel>

                                        </StackPanel>
                                    </Border>

                                    <!-- Save Button -->
                                    <Button Grid.Row="2"
                                            Command="{Binding SavePresetCommand}"
                                            HorizontalAlignment="Right"
                                            IsDefault="True">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                                <Setter Property="Content" Value="{local:Translate Presets_SaveButton}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsUpdateMode}" Value="True">
                                                        <Setter Property="Content" Value="{local:Translate Presets_UpdateButton}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </Popup>
                </Grid>
            </StackPanel>
        </DataTemplate>
        
        <DataTemplate x:Key="TextTemplate" DataType="{x:Type local:TextFieldViewModel}">
            <!-- WRAP IN GRID TO OVERLAY BUTTONS -->
            <Grid>
                <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                         AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto" MaxHeight="100"
                         x:Name="MainTextBox" Padding="5,5,28,5"/>
                <!-- UNDO/REDO BUTTONS -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,4,4,0"
                            Visibility="{Binding Source={x:Static local:SettingsService.Instance}, Path=Settings.ShowUndoRedoButtons, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Button Content="&#xE7A7;" Style="{StaticResource IconFontOverlayButton}"
                            Command="ApplicationCommands.Undo" CommandTarget="{Binding ElementName=MainTextBox}"
                            ToolTip="{local:Translate Toolbar_Undo}"/>
                    <Button Content="&#xE7A6;" Style="{StaticResource IconFontOverlayButton}"
                            Command="ApplicationCommands.Redo" CommandTarget="{Binding ElementName=MainTextBox}"
                            ToolTip="{local:Translate Toolbar_Redo}"/>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="AnyTypeTemplate" DataType="{x:Type local:TextFieldViewModel}">
            <!-- WRAP IN GRID TO OVERLAY BUTTONS -->
            <Grid>
                <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                         AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto" MaxHeight="100"
                         AllowDrop="True"
                         PreviewDragOver="TextBox_PreviewDragOver"
                         Drop="TextBox_Drop"
                         PreviewKeyDown="TextBox_PreviewKeyDown"
                         x:Name="AnyTypeTextBox" Padding="5,5,28,5"/>
                <!-- UNDO/REDO BUTTONS -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,4,4,0"
                            Visibility="{Binding Source={x:Static local:SettingsService.Instance}, Path=Settings.ShowUndoRedoButtons, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Button Content="&#xE7A7;" Style="{StaticResource IconFontOverlayButton}"
                            Command="ApplicationCommands.Undo" CommandTarget="{Binding ElementName=AnyTypeTextBox}"
                            ToolTip="{local:Translate Toolbar_Undo}"/>
                    <Button Content="&#xE7A6;" Style="{StaticResource IconFontOverlayButton}"
                            Command="ApplicationCommands.Redo" CommandTarget="{Binding ElementName=AnyTypeTextBox}"
                            ToolTip="{local:Translate Toolbar_Redo}"/>
                </StackPanel>
            </Grid>
        </DataTemplate>

            
        <DataTemplate x:Key="WildcardTemplate" DataType="{x:Type local:TextFieldViewModel}">
            <!-- The root is now a Grid that will contain both editors -->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Simple Editor (visible by default) -->
                <Grid x:Name="SimpleEditor" Grid.Row="0">
                    <TextBox x:Name="WildcardTextBox" Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             AcceptsReturn="True" TextWrapping="Wrap" Padding="5,5,52,5"
                             VerticalScrollBarVisibility="Auto" MinHeight="60"
                             PreviewKeyDown="WildcardTextBox_PreviewKeyDown"/>
    
                    <!-- GROUPED BUTTONS -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,4,0">
                        <!-- UNDO/REDO BUTTONS -->
                        <StackPanel Orientation="Horizontal"
                                    Visibility="{Binding Source={x:Static local:SettingsService.Instance}, Path=Settings.ShowUndoRedoButtons, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button Content="&#xE7A7;" Style="{StaticResource IconFontOverlayButton}"
                                    Command="ApplicationCommands.Undo" CommandTarget="{Binding ElementName=WildcardTextBox}"
                                    ToolTip="{local:Translate Toolbar_Undo}"/>
                            <Button Content="&#xE7A6;" Style="{StaticResource IconFontOverlayButton}"
                                    Command="ApplicationCommands.Redo" CommandTarget="{Binding ElementName=WildcardTextBox}"
                                    ToolTip="{local:Translate Toolbar_Redo}"/>
                        </StackPanel>
                        <!-- WILDCARD BROWSER BUTTON -->
                        <Button Content="..." Style="{StaticResource OverlayIconButton}"
                                ToolTip="{local:Translate Wildcard_Browse}"
                                Tag="OpenWildcardBrowser"/>
                    </StackPanel>
                </Grid>
        
                <!-- Advanced Editor (hidden by default) -->
                <local:AdvancedPromptEditor x:Name="AdvancedEditor" Grid.Row="0"
                                            PromptText="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                            Visibility="Collapsed"
                                            MinHeight="150"/>

                <!-- Resizing Thumb -->
                <Thumb Grid.Row="1" Height="5" Cursor="SizeNS" Margin="0,2,0,0">
                    <Thumb.Style>
                        <Style TargetType="Thumb">
                            <EventSetter Event="DragDelta" Handler="OnResizeThumbDragDelta" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Thumb">
                                        <Border Background="{StaticResource TertiaryBackground}" CornerRadius="2.5"/>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Thumb">
                                                <Border Background="{StaticResource PrimaryAccentBrush}" CornerRadius="2.5"/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Thumb.Style>
                </Thumb>
            </Grid>

            <DataTemplate.Triggers>
                <!-- Trigger to show the Advanced Editor when the model property is true -->
                <DataTrigger Binding="{Binding FieldModel.AdvancedPrompt}" Value="True">
                    <Setter TargetName="SimpleEditor" Property="Visibility" Value="Collapsed"/>
                    <Setter TargetName="AdvancedEditor" Property="Visibility" Value="Visible"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
        
        <DataTemplate x:Key="SliderTemplate" DataType="{x:Type local:SliderFieldViewModel}">
            <StackPanel Orientation="Horizontal">
                <Slider Value="{Binding Value, Mode=TwoWay}"
                        Minimum="{Binding MinValue}" Maximum="{Binding MaxValue}" SmallChange="{Binding StepValue}"
                        MinWidth="150" Margin="0,0,5,0" VerticalAlignment="Center"
                        IsMoveToPointEnabled="True" />
                <Grid MinWidth="50" VerticalAlignment="Center">
                    <TextBlock x:Name="ValueTextBlock" Text="{Binding FormattedValue}" 
                               MouseLeftButtonDown="ValueTextBlock_MouseLeftButtonDown">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Cursor" Value="IBeam"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                    <TextBox x:Name="ValueTextBox" 
                             Text="{Binding Value, StringFormat={}{0:G}, UpdateSourceTrigger=Explicit}"
                             Visibility="Collapsed"
                             LostFocus="ValueTextBox_LostFocus"
                             KeyDown="ValueTextBox_KeyDown"/>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="ComboBoxTemplate" DataType="{x:Type local:ComboBoxFieldViewModel}">
            <local:FilterableComboBox ItemsSource="{Binding ItemsSource}"
                                      SelectedItem="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                      PlaceholderText="{local:Translate ComboBox_PlaceholderDefault}" />
        </DataTemplate>

        <DataTemplate x:Key="CheckBoxTemplate" DataType="{x:Type local:CheckBoxFieldViewModel}">
            <CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay}" VerticalAlignment="Center" />
        </DataTemplate>
        
        <DataTemplate x:Key="ScriptButtonTemplate" DataType="{x:Type local:ScriptButtonFieldViewModel}">
            <Button Content="{Binding Name}"
                    Command="{Binding ExecuteScriptCommand}"
                    CommandParameter="{Binding ActionName}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="8"
                    FontWeight="SemiBold">
                <Button.Style>
                    <Style TargetType="Button">
                        <!-- Default properties -->
                        <Setter Property="Background">
                            <Setter.Value>
                                <MultiBinding Converter="{StaticResource PriorityColorToBrushConverter}">
                                    <Binding Path="HighlightColor"/>
                                    <Binding Source="{StaticResource PrimaryAccentBrush}"/>
                                </MultiBinding>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Foreground" Value="White"/>
                        <Setter Property="BorderThickness" Value="1"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                        <Setter Property="Cursor" Value="Hand"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}" 
                                            BorderBrush="{TemplateBinding BorderBrush}" 
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            CornerRadius="3">
                                        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <!-- Triggers for interactivity -->
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="BorderBrush" Value="{StaticResource PrimaryAccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </DataTemplate>
        
        <DataTemplate x:Key="LabelTemplate" DataType="{x:Type local:LabelFieldViewModel}">
            <!-- A grid to create a separator with text in the middle -->
            <Grid Margin="0,15,0,5" VerticalAlignment="Center">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Left line (now a Grid for layering) -->
                <Grid Grid.Column="0" VerticalAlignment="Center">
                    <Rectangle Height="1" Fill="{StaticResource TertiaryBackground}"/>
                    <Rectangle Height="1">
                        <Rectangle.Fill>
                            <Binding Path="HighlightColor" Converter="{StaticResource HexToBrushConverter}"/>
                        </Rectangle.Fill>
                    </Rectangle>
                </Grid>
                
                <!-- Label Text -->
                <TextBlock Grid.Column="1" Text="{Binding Name}" 
                           FontWeight="Bold" 
                           Foreground="{StaticResource TextSecondaryBrush}"
                           Margin="10,0"/>
                
                <!-- Right line (now a Grid for layering) -->
                <Grid Grid.Column="2" VerticalAlignment="Center">
                    <Rectangle Height="1" Fill="{StaticResource TertiaryBackground}"/>
                    <Rectangle Height="1">
                        <Rectangle.Fill>
                            <Binding Path="HighlightColor" Converter="{StaticResource HexToBrushConverter}"/>
                        </Rectangle.Fill>
                    </Rectangle>
                </Grid>
            </Grid>
        </DataTemplate>
        
        <DataTemplate x:Key="NodeBypassTemplate" DataType="{x:Type local:NodeBypassFieldViewModel}">
            <CheckBox IsChecked="{Binding IsEnabled, Mode=TwoWay}" VerticalAlignment="Center" />
        </DataTemplate>
        
            
        <DataTemplate x:Key="SeparatorTemplate" DataType="{x:Type local:SeparatorFieldViewModel}">
            <!-- Use a Grid to allow the Line to bind to its width -->
            <Grid x:Name="LineContainer" Margin="0,8,0,8" VerticalAlignment="Center" Height="2">
                
                <!-- Base Line -->
                <Line x:Name="BaseLine" 
                      X1="0" Y1="1" X2="{Binding ActualWidth, ElementName=LineContainer}" Y2="1"
                      Stroke="{StaticResource TertiaryBackground}"
                      StrokeThickness="1" />
                
                <!-- Highlight Line on top -->
                <Line x:Name="HighlightLine" 
                      X1="0" Y1="1" X2="{Binding ActualWidth, ElementName=LineContainer}" Y2="1"
                      StrokeThickness="1">
                    <Line.Stroke>
                        <Binding Path="HighlightColor" Converter="{StaticResource HexToBrushConverter}"/>
                    </Line.Stroke>
                </Line>
            </Grid>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding FieldModel.SeparatorStyle}" Value="Dashed">
                    <Setter TargetName="BaseLine" Property="StrokeDashArray" Value="4 2"/>
                    <Setter TargetName="HighlightLine" Property="StrokeDashArray" Value="4 2"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding FieldModel.SeparatorStyle}" Value="Dotted">
                    <Setter TargetName="BaseLine" Property="StrokeThickness" Value="2"/>
                    <Setter TargetName="HighlightLine" Property="StrokeThickness" Value="2"/>
                    <Setter TargetName="BaseLine" Property="StrokeDashArray" Value="0 3"/>
                    <Setter TargetName="HighlightLine" Property="StrokeDashArray" Value="0 3"/>
                    <Setter TargetName="BaseLine" Property="StrokeDashCap" Value="Round"/>
                    <Setter TargetName="HighlightLine" Property="StrokeDashCap" Value="Round"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <DataTemplate x:Key="SpoilerTemplate" DataType="{x:Type local:InputFieldViewModel}">
            <ToggleButton IsChecked="{Binding FieldModel.IsSpoilerExpanded, Mode=TwoWay}"
                          OverridesDefaultStyle="True"
                          Margin="0,10,0,5">
                <ToggleButton.Template>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="Transparent" Padding="0,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock x:Name="Arrow" Grid.Column="0" Text="▼" VerticalAlignment="Center" Margin="0,0,8,0" FontSize="10"/>
                                <TextBlock Grid.Column="1" Text="{Binding Name}" FontWeight="Bold" Foreground="{StaticResource PrimaryAccentBrush}"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="False">
                                <Setter TargetName="Arrow" Property="Text" Value="▶"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </ToggleButton.Template>
            </ToggleButton>
        </DataTemplate>
        
        <Style x:Key="LockToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
            <Setter Property="Content" Value="🔓"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}">
                            <TextBlock Text="{TemplateBinding Content}" 
                                       Foreground="{Binding Foreground, RelativeSource={RelativeSource TemplatedParent}, FallbackValue={StaticResource TextSecondaryBrush}}" 
                                       HorizontalAlignment="Center" 
                                       VerticalAlignment="Center" 
                                       FontFamily="Segoe UI Symbol"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsChecked" Value="True">
                    <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                    <Setter Property="Content" Value="🔒"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Opacity" Value="0.7"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <DataTemplate x:Key="SeedTemplate" DataType="{x:Type local:SeedFieldViewModel}">
            <Grid>
                <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                         Padding="5,5,28,5" />
                <ToggleButton IsChecked="{Binding IsLocked, Mode=TwoWay}"
                              Style="{StaticResource LockToggleButtonStyle}"
                              HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,4,0"/>
            </Grid>
        </DataTemplate>
        
        <DataTemplate x:Key="InpaintTemplate" DataType="{x:Type local:InpaintFieldViewModel}">
            <!-- 
                This ContentControl acts as the host for the InpaintEditor.
                We use a Style with a DataTrigger to correctly handle re-parenting the control
                between the main window and the undocked window.
            -->
            <ContentControl Margin="0,5">
                <ContentControl.Style>
                    <Style TargetType="ContentControl">
                        <!-- 
                            DEFAULT STATE: The Content is bound to the Editor property.
                            When the group is docked, this setter is active, and the InpaintEditor is shown here.
                        -->
                        <Setter Property="Content" Value="{Binding Editor}" />
                        <Style.Triggers>
                            <!-- 
                                UNDOCKED STATE: This trigger activates when the parent Expander's DataContext (the WorkflowGroupViewModel)
                                has its IsUndocked property set to True.
                            -->
                            <DataTrigger Binding="{Binding Path=DataContext.IsUndocked, RelativeSource={RelativeSource AncestorType=Expander}}" Value="True">
                                <!-- 
                                    CRITICAL STEP: We set the Content to null. This forces WPF to DETACH the InpaintEditor
                                    control from the main window's visual tree. This makes it "free" to be adopted 
                                    by the new floating window without errors. When IsUndocked becomes false again,
                                    the default Setter re-applies, re-attaching the control.
                                -->
                                <Setter Property="Content" Value="{x:Null}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ContentControl.Style>
            </ContentControl>
        </DataTemplate>

        <DataTemplate x:Key="MarkdownTemplate" DataType="{x:Type local:MarkdownFieldViewModel}">
            <local:MarkdownDisplay MarkdownText="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                   MaxDisplayLines="{Binding MaxDisplayLines}" />
        </DataTemplate>

        <local:FieldTemplateSelector x:Key="FieldTemplateSelector"
                                     TextTemplate="{StaticResource TextTemplate}"
                                     SeedTemplate="{StaticResource SeedTemplate}"
                                     SliderTemplate="{StaticResource SliderTemplate}"
                                     ComboBoxTemplate="{StaticResource ComboBoxTemplate}"
                                     CheckBoxTemplate="{StaticResource CheckBoxTemplate}"
                                     WildcardTemplate="{StaticResource WildcardTemplate}"
                                     AnyTypeTemplate="{StaticResource AnyTypeTemplate}" 
                                     InpaintTemplate="{StaticResource InpaintTemplate}"
                                     MarkdownTemplate="{StaticResource MarkdownTemplate}"
                                     ScriptButtonTemplate="{StaticResource ScriptButtonTemplate}"
                                     NodeBypassTemplate="{StaticResource NodeBypassTemplate}"
                                     LabelTemplate="{StaticResource LabelTemplate}"
                                     SeparatorTemplate="{StaticResource SeparatorTemplate}"
                                     SpoilerTemplate="{StaticResource SpoilerTemplate}"
        />
        
        <!-- Style for HORIZONTAL splitters (between rows) -->
        <Style x:Key="HorizontalGridSplitterStyle" TargetType="GridSplitter">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Height" Value="8"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GridSplitter">
                        <Border Background="{TemplateBinding Background}" VerticalAlignment="Center" Height="{TemplateBinding Height}">
                            <!-- This is the visible "thumb" -->
                            <Border x:Name="Thumb"
                                    Background="{StaticResource TertiaryBackground}"
                                    Height="4"
                                    Width="40"
                                    CornerRadius="2"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Thumb" Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style for VERTICAL splitters (between columns) -->
        <Style x:Key="VerticalGridSplitterStyle" TargetType="GridSplitter">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Width" Value="8"/>
            <Setter Property="VerticalAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GridSplitter">
                        <!-- MODIFIED: Removed HorizontalAlignment="Center" to allow the border to stretch and fix drag behavior -->
                        <Border Background="{TemplateBinding Background}" Width="{TemplateBinding Width}">
                            <!-- This is the visible "thumb", it can remain centered -->
                            <Border x:Name="Thumb"
                                    Background="{StaticResource TertiaryBackground}"
                                    Width="4"
                                    Height="40"
                                    CornerRadius="2"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Thumb" Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <DataTemplate x:Key="FieldDataTemplate">
            <DataTemplate.Resources>
                <!-- Add the converter here so it can be used by templates below -->
                <local:SpoilerVisibilityConverter x:Key="SpoilerVisibilityConverter"/>
                
                <ControlTemplate x:Key="NormalFieldLayoutTemplate" TargetType="ContentControl">
                    <!-- The visibility binding is now on the root Grid of the template -->
                    <Grid Margin="0,4">
                        <Grid.Visibility>
                            <MultiBinding Converter="{StaticResource SpoilerVisibilityConverter}">
                                <Binding Path="."/>
                                <!-- FIX: Bind directly to the ItemsSource of the list, which is the correct collection. -->
                                <Binding Path="ItemsSource" RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                <!-- ADD: This "listener" binding will re-trigger the converter when any spoiler's expanded state changes. -->
                                <Binding Path="ItemsSource/FieldModel.IsSpoilerExpanded" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                            </MultiBinding>
                        </Grid.Visibility>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto" MinWidth="120"/>
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                            
                            <Border Grid.Column="0" Width="3" CornerRadius="1.5" HorizontalAlignment="Left">
                                <Border.Background>
                                    <Binding Path="HighlightColor" Converter="{StaticResource HexToBrushConverter}"/>
                                </Border.Background>
                            </Border>
                            
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="10,0,10,0" VerticalAlignment="Top">
                                
                                <TextBlock Text="{Binding Name}">
                                    <TextBlock.ToolTip>
                                        <ToolTip>
                                            <TextBlock>
                                                <Run Text="{Binding NodeTitle, Mode=OneWay, StringFormat='Node: {0}'}" FontWeight="Bold"/>
                                                <LineBreak/>
                                                <Run Text="{Binding NodeType, Mode=OneWay, StringFormat='Type: {0}'}" Foreground="{StaticResource TextSecondaryBrush}"/>
                                                <LineBreak/>
                                                <Run Text="{Binding Path, Mode=OneWay, StringFormat='Path: {0}'}"/>
                                            </TextBlock>
                                        </ToolTip>
                                    </TextBlock.ToolTip>
                                </TextBlock>

                                <Border Background="Transparent" 
                                        Margin="5,0,0,0" 
                                        VerticalAlignment="Center"
                                        ToolTipService.InitialShowDelay="0"
                                        Visibility="{Binding FieldModel.Tooltip, Converter={StaticResource StringToVisibilityConverter}}">
                                    <TextBlock Text="&#xE946;" 
                                               FontFamily="Segoe MDL2 Assets" 
                                               Foreground="{StaticResource PrimaryAccentBrush}"
                                               FontSize="12"
                                               Cursor="Help"/>
                                    <Border.ToolTip>
                                        <ToolTip>
                                            <TextBlock Text="{Binding FieldModel.Tooltip}" MaxWidth="300" TextWrapping="Wrap"/>
                                        </ToolTip>
                                    </Border.ToolTip>
                                </Border>
                                
                                <TextBlock Margin="5,0,0,0" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Type}" Value="Seed"><Setter Property="Text" Value="🎲"/></DataTrigger>
                                                <DataTrigger Binding="{Binding Type}" Value="WildcardSupportPrompt"><Setter Property="Text" Value="💡"/></DataTrigger>
                                                <DataTrigger Binding="{Binding Type}" Value="FilePath"><Setter Property="Text" Value="📜"/></DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                            
                            <ContentPresenter Grid.Column="2" Content="{Binding}" ContentTemplateSelector="{StaticResource FieldTemplateSelector}" VerticalAlignment="Top" />

                            <Border x:Name="HighlightOverlay"
                                    Grid.Column="0" Grid.ColumnSpan="3"
                                    Background="{StaticResource PrimaryAccentBrush}"
                                    Opacity="0"
                                    CornerRadius="3"
                                    IsHitTestVisible="False"/>
                        </Grid>
                        
                        <ControlTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="HighlightOverlay"
                                                             Storyboard.TargetProperty="Opacity"
                                                             From="0" To="0.3" Duration="0:0:0.2"
                                                             AutoReverse="True" RepeatBehavior="2x" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                            </DataTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                <ControlTemplate x:Key="InpaintLayoutTemplate" TargetType="ContentControl">
                    <Grid>
                        <!-- Add the visibility binding here too -->
                        <Grid.Visibility>
                            <MultiBinding Converter="{StaticResource SpoilerVisibilityConverter}">
                                <Binding Path="."/>
                                <!-- FIX: Bind directly to the ItemsSource of the list, which is the correct collection. -->
                                <Binding Path="ItemsSource" RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                <!-- ADD: This "listener" binding will re-trigger the converter when any spoiler's expanded state changes. -->
                                <Binding Path="ItemsSource/FieldModel.IsSpoilerExpanded" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                            </MultiBinding>
                        </Grid.Visibility>
                        <ContentPresenter Content="{Binding}" ContentTemplateSelector="{StaticResource FieldTemplateSelector}" />
                        <Border x:Name="HighlightOverlay"
                                Background="{StaticResource PrimaryAccentBrush}"
                                Opacity="0"
                                CornerRadius="3"
                                IsHitTestVisible="False"/>
                    </Grid>
                      <!-- english: Trigger for the highlight animation. -->
                      <ControlTemplate.Triggers>
                          <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                              <DataTrigger.EnterActions>
                                  <BeginStoryboard>
                                      <Storyboard>
                                          <DoubleAnimation Storyboard.TargetName="HighlightOverlay"
                                                           Storyboard.TargetProperty="Opacity"
                                                           From="0" To="0.3" Duration="0:0:0.2"
                                                           AutoReverse="True" RepeatBehavior="2x" />
                                      </Storyboard>
                                  </BeginStoryboard>
                              </DataTrigger.EnterActions>
                          </DataTrigger>
                      </ControlTemplate.Triggers>
                  </ControlTemplate>
                <ControlTemplate x:Key="FullWidthLayoutTemplate" TargetType="ContentControl">
                    <Grid>
                        <!-- And here as well -->
                        <Grid.Visibility>
                            <MultiBinding Converter="{StaticResource SpoilerVisibilityConverter}">
                                <Binding Path="."/>
                                <!-- FIX: Bind directly to the ItemsSource of the list, which is the correct collection. -->
                                <Binding Path="ItemsSource" RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                <!-- ADD: This "listener" binding will re-trigger the converter when any spoiler's expanded state changes. -->
                                <Binding Path="ItemsSource/FieldModel.IsSpoilerExpanded" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                            </MultiBinding>
                        </Grid.Visibility>
                        <ContentPresenter Content="{Binding}" ContentTemplateSelector="{StaticResource FieldTemplateSelector}" Margin="0,4" />
                        <Border x:Name="HighlightOverlay"
                                Background="{StaticResource PrimaryAccentBrush}"
                                Opacity="0"
                                CornerRadius="3"
                                IsHitTestVisible="False"/>
                    </Grid>
                      <!-- english: Trigger for the highlight animation. -->
                      <ControlTemplate.Triggers>
                          <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                              <DataTrigger.EnterActions>
                                  <BeginStoryboard>
                                      <Storyboard>
                                          <DoubleAnimation Storyboard.TargetName="HighlightOverlay"
                                                           Storyboard.TargetProperty="Opacity"
                                                           From="0" To="0.3" Duration="0:0:0.2"
                                                           AutoReverse="True" RepeatBehavior="2x" />
                                      </Storyboard>
                                  </BeginStoryboard>
                              </DataTrigger.EnterActions>
                          </DataTrigger>
                      </ControlTemplate.Triggers>
                  </ControlTemplate>
              </DataTemplate.Resources>
              <ContentControl Content="{Binding}">
                <ContentControl.Style>
                    <Style TargetType="ContentControl">
                        <Setter Property="Template" Value="{StaticResource NormalFieldLayoutTemplate}"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Converter={StaticResource IsInpaintViewModelConverter}}" Value="True">
                                <Setter Property="Template" Value="{StaticResource InpaintLayoutTemplate}"/>
                            </DataTrigger>
                            <!-- The trigger for Spoiler needs to use FullWidthLayoutTemplate for correct rendering -->
                            <DataTrigger Binding="{Binding Type}" Value="Spoiler">
                                <Setter Property="Template" Value="{StaticResource FullWidthLayoutTemplate}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Converter={StaticResource IsMarkdownViewModelConverter}}" Value="True">
                                <Setter Property="Template" Value="{StaticResource FullWidthLayoutTemplate}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Type}" Value="ScriptButton">
                                <Setter Property="Template" Value="{StaticResource FullWidthLayoutTemplate}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Type}" Value="Label">
                                <Setter Property="Template" Value="{StaticResource FullWidthLayoutTemplate}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Type}" Value="Separator">
                                <Setter Property="Template" Value="{StaticResource FullWidthLayoutTemplate}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ContentControl.Style>
            </ContentControl>
          </DataTemplate>
          
       <DataTemplate x:Key="UndockedGroupTemplate" DataType="{x:Type local:WorkflowGroupViewModel}">
           <Grid>
                <Border>
                    <Border.Background>
                       <PriorityBinding>
                           <Binding Path="SelectedTab.HighlightColor" Converter="{StaticResource HexToBrushConverter}"/>
                            <Binding Source="{StaticResource SecondaryBackground}"/>
                       </PriorityBinding>
                    </Border.Background>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                            <ContentControl Content="{Binding}">
                                <ContentControl.Resources>
                            <DataTemplate x:Key="SingleTabViewTemplate">
                                <ItemsControl ItemsSource="{Binding Tabs[0].Fields}" Padding="8" ItemTemplate="{StaticResource FieldDataTemplate}"/>
                            </DataTemplate>
                            
                            <DataTemplate x:Key="MultiTabViewTemplate">
                                <TabControl ItemsSource="{Binding Tabs}" SelectedItem="{Binding SelectedTab, Mode=TwoWay}"
                                            Style="{StaticResource GroupInternalTabControlStyle}"
                                            ItemContainerStyle="{StaticResource GroupInternalTabItemStyle}">
                                    <TabControl.ItemTemplate>
                                        <DataTemplate DataType="{x:Type local:WorkflowGroupTabViewModel}">
                                            <!-- The Tab Header is now just the text, clean and simple -->
                                            <TextBlock Text="{Binding Name}" HorizontalAlignment="Center" Margin="0,0,0,2" />
                                        </DataTemplate>
                                </TabControl.ItemTemplate>
                                <TabControl.ContentTemplate>
                                    <DataTemplate DataType="{x:Type local:WorkflowGroupTabViewModel}">
                                        <ItemsControl ItemsSource="{Binding Fields}" Padding="8" ItemTemplate="{StaticResource FieldDataTemplate}"/>
                                    </DataTemplate>
                                </TabControl.ContentTemplate>
                            </TabControl>
                        </DataTemplate>
                    </ContentControl.Resources>
                    <ContentControl.Style>
                        <Style TargetType="ContentControl">
                            <Setter Property="ContentTemplate" Value="{StaticResource SingleTabViewTemplate}"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Tabs.Count, Converter={StaticResource IsGreaterThanConverter}, ConverterParameter=1}" Value="True">
                                    <Setter Property="ContentTemplate" Value="{StaticResource MultiTabViewTemplate}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentControl.Style>
                </ContentControl>
               </ScrollViewer>
               </Border>
           </Grid>
       </DataTemplate>

        <DataTemplate x:Key="UndockableQueueControlsTemplate">
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,0">
                        <TextBlock Text="🎲" FontSize="14" VerticalAlignment="Center"
                                   Margin="0,0,5,0" ToolTip="{local:Translate Tab_SeedControl}" />
                        <ComboBox x:Name="SeedControlComboBox"
                                  ItemsSource="{Binding SeedControlEnumValues}"
                                  SelectedItem="{Binding SelectedTab.WorkflowInputsController.SelectedSeedControl}"
                                  MinWidth="100" />
                    </StackPanel>

                    <Button Content="&#xE945;" Style="{StaticResource IconButton}"
                            Command="{Binding ToggleQueueManagerCommand}"
                            Margin="0,0,10,0"
                            ToolTip="{local:Translate QueueManager_Title}" />

                    <ToggleButton x:Name="XyGridToggleButton"
                                  Content="XY"
                                  FontWeight="Bold"
                                  IsChecked="{Binding SelectedTab.WorkflowInputsController.IsXyGridPopupOpen, Mode=TwoWay}"
                                  ToolTip="{local:Translate XYGrid_Title}"
                                  Margin="0,0,10,0">
                        <ToggleButton.Style>
                            <Style TargetType="ToggleButton"
                                   BasedOn="{StaticResource IconToggleButton}">
                                <Setter Property="IsEnabled"
                                        Value="{Binding SelectedTab.WorkflowInputsController.GridableSources.Count, Converter={StaticResource CountToBooleanConverter}}" />
                                <Style.Triggers>
                                    <DataTrigger
                                        Binding="{Binding SelectedTab.WorkflowInputsController.IsXyGridEnabled}"
                                        Value="True">
                                        <Setter Property="Background"
                                                Value="{StaticResource PrimaryAccentBrush}" />
                                        <Setter Property="Foreground" Value="White" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ToggleButton.Style>
                    </ToggleButton>

                    <Popup StaysOpen="False"
                           PlacementTarget="{Binding ElementName=XyGridToggleButton}"
                           Placement="Top"
                           AllowsTransparency="True">
                        <Popup.IsOpen>
                            <MultiBinding Converter="{StaticResource BooleanAndConverter}">
                                <Binding Path="IsChecked" ElementName="XyGridToggleButton" Mode="TwoWay"/>
                                <Binding Path="IsVisible" ElementName="XyGridToggleButton" Mode="OneWay"/>
                            </MultiBinding>
                        </Popup.IsOpen>
                        <Popup.Resources>
                            <Style TargetType="GroupBox">
                                <Setter Property="BorderBrush" Value="{StaticResource TertiaryBackground}" />
                                <Setter Property="BorderThickness" Value="1" />
                                <Setter Property="Padding" Value="8" />
                                <Setter Property="Margin" Value="0,0,0,10" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="GroupBox">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="*" />
                                                </Grid.RowDefinitions>
                                                <Border Grid.Row="0" Background="{StaticResource TertiaryBackground}"
                                                        Padding="5" CornerRadius="3,3,0,0">
                                                    <ContentPresenter ContentSource="Header" RecognizesAccessKey="True" />
                                                </Border>
                                                <Border Grid.Row="1" BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="0,1,0,0" Padding="{TemplateBinding Padding}"
                                                        CornerRadius="0,0,3,3">
                                                    <ContentPresenter />
                                                </Border>
                                            </Grid>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Popup.Resources>
                        <Border Background="{StaticResource SecondaryBackground}" CornerRadius="5"
                                Padding="10" Margin="0,0,0,5"
                                BorderBrush="{StaticResource TertiaryBackground}"
                                BorderThickness="1">
                            <StackPanel MinWidth="350">
                                <CheckBox Content="{local:Translate XYGrid_Enable}"
                                          IsChecked="{Binding SelectedTab.WorkflowInputsController.IsXyGridEnabled, Mode=TwoWay}"
                                          FontWeight="Bold" Margin="0,0,0,10" />

                                <!-- Grid Mode -->
                                <GroupBox Header="{local:Translate XYGrid_Mode}">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <RadioButton Content="{local:Translate XYGrid_ModeImage}"
                                                         GroupName="GridMode"
                                                         IsChecked="{Binding SelectedTab.WorkflowInputsController.GridMode, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:XYGridMode.Image}}" />
                                            <RadioButton Content="{local:Translate XYGrid_ModeVideo}"
                                                         GroupName="GridMode" Margin="15,0,0,0"
                                                         IsChecked="{Binding SelectedTab.WorkflowInputsController.GridMode, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Static local:XYGridMode.Video}}" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="20,8,0,0">
                                            <StackPanel.Style>
                                                <Style TargetType="StackPanel">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger
                                                            Binding="{Binding SelectedTab.WorkflowInputsController.GridMode}"
                                                            Value="{x:Static local:XYGridMode.Video}">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </StackPanel.Style>
                                            <TextBlock Text="{local:Translate XYGrid_FrameCount}"
                                                       VerticalAlignment="Center" Margin="0,0,10,0" />
                                            <xctk:IntegerUpDown
                                                Value="{Binding SelectedTab.WorkflowInputsController.VideoGridFrames, Mode=TwoWay}"
                                                Minimum="1" Maximum="16" Width="60" />
                                        </StackPanel>
                                    </StackPanel>
                                </GroupBox>

                                <GroupBox Header="{local:Translate XYGrid_CellOptions}">
                                    <StackPanel>
                                        <CheckBox Content="{local:Translate XYGrid_CreateGridImage}"
                                                  IsChecked="{Binding SelectedTab.WorkflowInputsController.XyGridCreateGridImage, Mode=TwoWay}" />
                                        <CheckBox
                                            Content="{local:Translate XYGrid_ShowIndividualImages}"
                                            IsChecked="{Binding SelectedTab.WorkflowInputsController.XyGridShowIndividualImages, Mode=TwoWay}"
                                            Margin="0,5,0,0" />

                                        <Separator Margin="0,10" />

                                        <CheckBox Content="{local:Translate XYGrid_LimitCellSize}"
                                                  IsChecked="{Binding SelectedTab.WorkflowInputsController.XyGridLimitCellSize, Mode=TwoWay}" />
                                        <StackPanel Orientation="Horizontal" Margin="20,8,0,0">
                                            <StackPanel.Style>
                                                <Style TargetType="StackPanel">
                                                    <Setter Property="IsEnabled" Value="False" />
                                                    <Style.Triggers>
                                                        <DataTrigger
                                                            Binding="{Binding SelectedTab.WorkflowInputsController.XyGridLimitCellSize}"
                                                            Value="True">
                                                            <Setter Property="IsEnabled" Value="True" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </StackPanel.Style>
                                            <TextBlock Text="{local:Translate XYGrid_MaxMegapixels}"
                                                       VerticalAlignment="Center" Margin="0,0,10,0" />
                                            <xctk:DoubleUpDown
                                                Value="{Binding SelectedTab.WorkflowInputsController.XyGridMaxMegapixels, Mode=TwoWay}"
                                                Minimum="0.1" Maximum="256" Increment="0.5" FormatString="F1"
                                                Width="70" />
                                        </StackPanel>
                                    </StackPanel>
                                </GroupBox>

                                <!-- X AXIS -->
                                <TextBlock Text="{local:Translate XYGrid_XAxisField}"
                                           Margin="0,0,0,2" />
                                <local:FilterableComboBox Margin="0,0,0,5"
                                                          ItemsSource="{Binding SelectedTab.WorkflowInputsController.GridableSources}"
                                                          SelectedItem="{Binding SelectedTab.WorkflowInputsController.SelectedXSource, Mode=TwoWay}"
                                                          ShowCycleButtons="False"
                                                          PlaceholderItem="{x:Static local:NullGridAxisSource.Instance}">
                                    <local:FilterableComboBox.ItemTemplate>
                                        <DataTemplate DataType="{x:Type local:GridAxisSource}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding DisplayName}" />
                                                <TextBlock Text="{Binding GroupName, StringFormat=' ({0})'}"
                                                           Foreground="{StaticResource TextSecondaryBrush}"
                                                           Margin="5,0,0,0" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </local:FilterableComboBox.ItemTemplate>
                                </local:FilterableComboBox>

                                <local:FilterableComboBox
                                    ItemsSource="{Binding SelectedTab.WorkflowInputsController.XSourceItemsSource}"
                                    PlaceholderText="{local:Translate XYGrid_AddValuePlaceholder}"
                                    Margin="0,0,0,5"
                                    ItemSelectedCommand="{Binding SelectedTab.WorkflowInputsController.AddValueToGridCommand}"
                                    ItemSelectedCommandParameter="X">
                                    <local:FilterableComboBox.Style>
                                        <Style TargetType="local:FilterableComboBox">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding SelectedTab.WorkflowInputsController.IsXSourceComboBox}"
                                                    Value="True">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </local:FilterableComboBox.Style>
                                </local:FilterableComboBox>

                                <local:FilterableComboBox
                                    ItemsSource="{Binding SelectedTab.WorkflowInputsController.XSourcePresetsView}"
                                    PlaceholderText="{local:Translate XYGrid_AddValuePlaceholder}"
                                    Margin="0,0,0,5"
                                    ShowCycleButtons="False"
                                    ItemSelectedCommand="{Binding SelectedTab.WorkflowInputsController.AddPresetValueToGridCommand}"
                                    ItemSelectedCommandParameter="X">
                                    <local:FilterableComboBox.Style>
                                        <Style TargetType="local:FilterableComboBox">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding SelectedTab.WorkflowInputsController.IsXSourcePresetGroup}"
                                                    Value="True">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </local:FilterableComboBox.Style>
                                    <local:FilterableComboBox.GroupStyle>
                                        <GroupStyle>
                                            <GroupStyle.HeaderTemplate>
                                                <DataTemplate>
                                                    <TextBlock FontWeight="Bold"
                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                               Margin="0,5,0,2">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding Name}" Value="False">
                                                                        <Setter Property="Text"
                                                                            Value="{local:Translate Presets_Snippets}" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Name}" Value="True">
                                                                        <Setter Property="Text"
                                                                            Value="{local:Translate Presets_Layouts}" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </DataTemplate>
                                            </GroupStyle.HeaderTemplate>
                                        </GroupStyle>
                                    </local:FilterableComboBox.GroupStyle>
                                    <local:FilterableComboBox.ItemTemplate>
                                        <DataTemplate DataType="{x:Type local:GroupPresetViewModel}">
                                            <TextBlock Text="{Binding Name}" />
                                        </DataTemplate>
                                    </local:FilterableComboBox.ItemTemplate>
                                </local:FilterableComboBox>

                                <!-- Global Presets ComboBox (for X-Axis) -->
                                <local:FilterableComboBox
                                    ItemsSource="{Binding SelectedTab.WorkflowInputsController.XSourceGlobalPresetsView}"
                                    PlaceholderText="{local:Translate XYGrid_AddValuePlaceholder}"
                                    Margin="0,0,0,5"
                                    ShowCycleButtons="False"
                                    ItemSelectedCommand="{Binding SelectedTab.WorkflowInputsController.AddGlobalPresetValueToGridCommand}"
                                    ItemSelectedCommandParameter="X">
                                    <local:FilterableComboBox.Style>
                                        <Style TargetType="local:FilterableComboBox">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedTab.WorkflowInputsController.IsXSourceGlobalPreset}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </local:FilterableComboBox.Style>
                                    <local:FilterableComboBox.ItemTemplate>
                                        <DataTemplate DataType="{x:Type local:GlobalPreset}">
                                            <TextBlock Text="{Binding Name}" />
                                        </DataTemplate>
                                    </local:FilterableComboBox.ItemTemplate>
                                </local:FilterableComboBox>

                                <TextBlock Text="{local:Translate XYGrid_XValues}" Margin="0,0,0,2" />
                                <TextBox Margin="0,0,0,10" MinHeight="60"
                                         Text="{Binding SelectedTab.WorkflowInputsController.XValues, UpdateSourceTrigger=PropertyChanged}"
                                         AcceptsReturn="True" TextWrapping="Wrap"
                                         VerticalScrollBarVisibility="Auto" />

                                <!-- Y AXIS -->
                                <TextBlock Text="{local:Translate XYGrid_YAxisField}"
                                           Margin="0,0,0,2" />
                                <local:FilterableComboBox Margin="0,0,0,5"
                                                          ItemsSource="{Binding SelectedTab.WorkflowInputsController.GridableSources}"
                                                          SelectedItem="{Binding SelectedTab.WorkflowInputsController.SelectedYSource, Mode=TwoWay}"
                                                          ShowCycleButtons="False"
                                                          PlaceholderItem="{x:Static local:NullGridAxisSource.Instance}">
                                    <local:FilterableComboBox.ItemTemplate>
                                        <DataTemplate DataType="{x:Type local:GridAxisSource}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding DisplayName}" />
                                                <TextBlock Text="{Binding GroupName, StringFormat=' ({0})'}"
                                                           Foreground="{StaticResource TextSecondaryBrush}"
                                                           Margin="5,0,0,0" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </local:FilterableComboBox.ItemTemplate>
                                </local:FilterableComboBox>

                                <local:FilterableComboBox
                                    ItemsSource="{Binding SelectedTab.WorkflowInputsController.YSourceItemsSource}"
                                    PlaceholderText="{local:Translate XYGrid_AddValuePlaceholder}"
                                    Margin="0,0,0,5"
                                    ItemSelectedCommand="{Binding SelectedTab.WorkflowInputsController.AddValueToGridCommand}"
                                    ItemSelectedCommandParameter="Y">
                                    <local:FilterableComboBox.Style>
                                        <Style TargetType="local:FilterableComboBox">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding SelectedTab.WorkflowInputsController.IsYSourceComboBox}"
                                                    Value="True">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </local:FilterableComboBox.Style>
                                </local:FilterableComboBox>

                                <local:FilterableComboBox
                                    ItemsSource="{Binding SelectedTab.WorkflowInputsController.YSourcePresetsView}"
                                    PlaceholderText="{local:Translate XYGrid_AddValuePlaceholder}"
                                    Margin="0,0,0,5"
                                    ShowCycleButtons="False"
                                    ItemSelectedCommand="{Binding SelectedTab.WorkflowInputsController.AddPresetValueToGridCommand}"
                                    ItemSelectedCommandParameter="Y">
                                    <local:FilterableComboBox.Style>
                                        <Style TargetType="local:FilterableComboBox">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding SelectedTab.WorkflowInputsController.IsYSourcePresetGroup}"
                                                    Value="True">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </local:FilterableComboBox.Style>
                                    <local:FilterableComboBox.GroupStyle>
                                        <GroupStyle>
                                            <GroupStyle.HeaderTemplate>
                                                <DataTemplate>
                                                    <TextBlock FontWeight="Bold"
                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                               Margin="0,5,0,2">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding Name}" Value="False">
                                                                        <Setter Property="Text"
                                                                            Value="{local:Translate Presets_Snippets}" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Name}" Value="True">
                                                                        <Setter Property="Text"
                                                                            Value="{local:Translate Presets_Layouts}" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </DataTemplate>
                                            </GroupStyle.HeaderTemplate>
                                        </GroupStyle>
                                    </local:FilterableComboBox.GroupStyle>
                                    <local:FilterableComboBox.ItemTemplate>
                                        <DataTemplate DataType="{x:Type local:GroupPresetViewModel}">
                                            <TextBlock Text="{Binding Name}" />
                                        </DataTemplate>
                                    </local:FilterableComboBox.ItemTemplate>
                                </local:FilterableComboBox>

                                <!-- Global Presets ComboBox (for Y-Axis) -->
                                <local:FilterableComboBox
                                    ItemsSource="{Binding SelectedTab.WorkflowInputsController.YSourceGlobalPresetsView}"
                                    PlaceholderText="{local:Translate XYGrid_AddValuePlaceholder}"
                                    Margin="0,0,0,5"
                                    ShowCycleButtons="False"
                                    ItemSelectedCommand="{Binding SelectedTab.WorkflowInputsController.AddGlobalPresetValueToGridCommand}"
                                    ItemSelectedCommandParameter="Y">
                                    <local:FilterableComboBox.Style>
                                        <Style TargetType="local:FilterableComboBox">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedTab.WorkflowInputsController.IsYSourceGlobalPreset}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </local:FilterableComboBox.Style>
                                    <local:FilterableComboBox.ItemTemplate>
                                        <DataTemplate DataType="{x:Type local:GlobalPreset}">
                                            <TextBlock Text="{Binding Name}" />
                                        </DataTemplate>
                                    </local:FilterableComboBox.ItemTemplate>
                                </local:FilterableComboBox>

                                <TextBlock Text="{local:Translate XYGrid_YValues}" Margin="0,0,0,2" />
                                <TextBox
                                    Text="{Binding SelectedTab.WorkflowInputsController.YValues, UpdateSourceTrigger=PropertyChanged}"
                                    MinHeight="60" AcceptsReturn="True" TextWrapping="Wrap"
                                    VerticalScrollBarVisibility="Auto" />
                            </StackPanel>
                        </Border>
                    </Popup>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" BorderBrush="{StaticResource TertiaryBackground}"
                                BorderThickness="1" CornerRadius="3" Height="30">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <Button Grid.Column="0"
                                        Content="{local:Translate Tab_Queue}"
                                        Background="{StaticResource SuccessBrush}"
                                        Command="{Binding QueueCommand}"
                                        BorderThickness="0"
                                        Padding="10,0">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}" CornerRadius="3,0,0,3">
                                                <ContentPresenter HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center" />
                                            </Border>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>

                                <Border Grid.Column="1" Width="1" Background="{StaticResource TertiaryBackground}" />

                                <ToggleButton Grid.Column="1" Margin="1,0,0,0"
                                              Content="&#xE8EE;"
                                              FontFamily="Segoe MDL2 Assets"
                                              Style="{StaticResource IconToggleButton}"
                                              ToolTip="{local:Translate Tab_ToggleInfiniteQueue}"
                                              IsChecked="{Binding IsInfiniteQueueEnabled, Mode=TwoWay}">
                                    <ToggleButton.Template>
                                        <ControlTemplate TargetType="ToggleButton">
                                            <Border x:Name="Bg" Background="{TemplateBinding Background}"
                                                    CornerRadius="0,3,3,0">
                                                <TextBlock Text="{TemplateBinding Content}"
                                                           FontFamily="{TemplateBinding FontFamily}"
                                                           VerticalAlignment="Center" HorizontalAlignment="Center"
                                                           Foreground="{TemplateBinding Foreground}" />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Bg" Property="Background"
                                                            Value="{StaticResource TertiaryBackground}" />
                                                </Trigger>
                                                <Trigger Property="IsChecked" Value="True">
                                                    <Setter TargetName="Bg" Property="Background"
                                                            Value="{StaticResource PrimaryAccentBrush}" />
                                                    <Setter Property="Foreground" Value="White" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </ToggleButton.Template>
                                </ToggleButton>
                            </Grid>
                        </Border>

                        <xctk:IntegerUpDown Grid.Column="1" Margin="5,0,0,0"
                                            Value="{Binding QueueSize}"
                                            Minimum="1"
                                            Maximum="{Binding MaxQueueSize}"
                                            local:IntegerUpDownSmartSpinBehavior.EnableSmartSpin="True"
                                            Width="60" />

                        <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="5,0,0,0">
                            <ToggleButton Command="{Binding TogglePauseQueueCommand}"
                                          IsChecked="{Binding IsQueuePaused, Mode=OneWay}" Margin="0,0,5,0">
                                <ToggleButton.Style>
                                    <Style TargetType="ToggleButton" BasedOn="{StaticResource IconToggleButton}">
                                        <Setter Property="Content" Value="&#xE769;" />
                                        <Setter Property="ToolTip" Value="{local:Translate Tab_PauseQueue}" />
                                        <Style.Triggers>
                                            <Trigger Property="IsChecked" Value="True">
                                                <Setter Property="Content" Value="&#xE768;" />
                                                <Setter Property="ToolTip" Value="{local:Translate Tab_ResumeQueue}" />
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>
                            <Button Content="&#xE8BB;" Style="{StaticResource IconButton}"
                                    Background="{StaticResource ErrorBrush}" Command="{Binding InterruptCommand}"
                                    ToolTip="{local:Translate Tab_InterruptGeneration}" />
                            <Button Content="&#xE71A;" Style="{StaticResource IconButton}"
                                    Background="{StaticResource ErrorBrush}" Command="{Binding ClearLocalQueueCommand}"
                                    Margin="5,0,0,0" ToolTip="{local:Translate Tab_ClearLocalQueue}" />
                            <Button
                                Command="{Binding ToggleUndockQueueControlsCommand}"
                                Margin="5,0,0,0">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource IconButton}">
                                        <Setter Property="Content" Value="&#xE8A7;" />
                                        <Setter Property="ToolTip" Value="{local:Translate UndockPanel_Undock}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsQueueControlsUndocked}" Value="True">
                                                <Setter Property="Content" Value="&#xE8A6;" />
                                                <Setter Property="ToolTip" Value="{local:Translate UndockPanel_Dock}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                    </Grid>
                </StackPanel>

                <StackPanel VerticalAlignment="Center" Margin="0,8,0,0"
                            Visibility="{Binding TotalTasks, Converter={StaticResource TaskCountToVisibilityConverter}}">
                    <ProgressBar Value="{Binding CurrentProgress}" Maximum="100" Height="5" MinWidth="200" />
                    <Grid MinWidth="200">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" HorizontalAlignment="Left" Margin="0,2,0,0" FontSize="10"
                                   Foreground="{StaticResource TextSecondaryBrush}">
                            <TextBlock.Text>
                                <MultiBinding Converter="{StaticResource MultiBindingStringFormatConverter}">
                                    <Binding Path="[Tab_CompletedTasks]"
                                             Source="{x:Static local:LocalizationService.Instance}" Mode="OneWay" />
                                    <Binding Path="CompletedTasks" />
                                    <Binding Path="TotalTasks" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                        <TextBlock Grid.Column="1" Text="{Binding EstimatedTimeRemaining}" HorizontalAlignment="Right"
                                   Margin="0,2,0,0" FontSize="10" Foreground="{StaticResource TextSecondaryBrush}"
                                   Visibility="{Binding EstimatedTimeRemaining, Converter={StaticResource StringToIsNotNullOrEmptyConverter}}" />
                    </Grid>
                </StackPanel>
            </StackPanel>
        </DataTemplate>

        <Style x:Key="ToolWindowStyle_SimpleHeader" TargetType="Window" BasedOn="{StaticResource CustomWindowStyle}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Window">
                        <Border BorderBrush="{StaticResource PrimaryAccentBrush}" BorderThickness="1"
                                Background="{TemplateBinding Background}" CornerRadius="3">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="26" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <Border x:Name="TitleBar" Grid.Row="0"
                                        Background="{StaticResource SecondaryBackground}" CornerRadius="3,3,0,0">
                                    <Grid>
                                        <TextBlock
                                            Text="{Binding Title, RelativeSource={RelativeSource TemplatedParent}}"
                                            VerticalAlignment="Center" Foreground="{StaticResource TextBrush}"
                                            Margin="8,0" FontWeight="Bold" />
                                        <Button x:Name="CloseButton" Style="{StaticResource SystemButtonClose}"
                                                Content="M 0 0 L 10 10 M 10 0 L 0 10"
                                                ToolTip="{local:Translate Window_Close}"
                                                Width="32" Height="26" HorizontalAlignment="Right" />
                                    </Grid>
                                </Border>

                                <ContentPresenter Grid.Row="1" />
                            </Grid>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
                                                           
    </Application.Resources>
</Application>