<!-- SliderCompareView.xaml.txt -->
<UserControl x:Class="Comfizen.SliderCompareView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Comfizen"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200"
             Visibility="{Binding IsViewOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
    <UserControl.Resources>
        <!-- Declare both converters -->
        <local:LeftClipConverter x:Key="LeftClipConverter"/>
        <local:RightClipConverter x:Key="RightClipConverter"/>
        <local:ResolutionToWidthConverter x:Key="ResolutionToWidthConverter"/>
        <local:ResolutionToHeightConverter x:Key="ResolutionToHeightConverter"/>
        
        <Style x:Key="OverlayButton" TargetType="Button">
            <Setter Property="Background" Value="#80000000"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Width" Value="50"/>
            <Setter Property="Height" Value="50"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="25">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True"><Setter Property="Background" Value="#A0000000"/></Trigger>
                <Trigger Property="IsEnabled" Value="False"><Setter Property="Opacity" Value="0.3"/></Trigger>
            </Style.Triggers>
        </Style>

    </UserControl.Resources>
    
    <Grid x:Name="RootGrid" Background="#D8000000" Focusable="True" PreviewKeyDown="RootGrid_PreviewKeyDown">
        <!-- Main container with margins -->
        <Grid Margin="60">

            <!-- The Viewbox is now singular and wraps the entire comparison scene. -->
            <!-- It will scale the inner Grid while preserving its aspect ratio. -->
            <Viewbox>
                <!-- This Grid is our "canvas". Its size is bound to the dimensions of the left image. -->
                <!-- All child elements (images, slider) will operate within its coordinate system. -->
                <Grid x:Name="ImageCanvas"
                      Width="{Binding ImageLeft.Resolution, Converter={StaticResource ResolutionToWidthConverter}, FallbackValue=1200}"
                      Height="{Binding ImageLeft.Resolution, Converter={StaticResource ResolutionToHeightConverter}, FallbackValue=800}"
                      AllowDrop="True" Drop="Image_Drop" DragOver="Image_DragOver">

                    <!-- Right image/video (bottom layer) -->
                    <Grid Tag="Right">
                        <Grid.Clip>
                            <MultiBinding Converter="{StaticResource RightClipConverter}">
                                <Binding Path="Value" ElementName="CompareSlider"/>
                                <Binding Path="ActualWidth" ElementName="ImageCanvas"/>
                                <Binding Path="ActualHeight" ElementName="ImageCanvas"/>
                            </MultiBinding>
                        </Grid.Clip>
                        <Image Source="{Binding ImageRight.Image}" Stretch="Fill">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ImageRight.Type}" Value="{x:Static local:FileType.Video}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                        <MediaElement x:Name="MediaElementRight" Stretch="Fill" LoadedBehavior="Manual" UnloadedBehavior="Stop" IsMuted="True" MediaOpened="MediaElement_MediaOpened" MediaEnded="MediaElement_MediaEnded">
                            <MediaElement.Style>
                                <Style TargetType="MediaElement">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ImageRight.Type}" Value="{x:Static local:FileType.Video}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </MediaElement.Style>
                        </MediaElement>
                    </Grid>

                    <!-- Left image/video (top layer) -->
                    <Grid Tag="Left">
                        <Grid.Clip>
                            <MultiBinding Converter="{StaticResource LeftClipConverter}">
                                <Binding Path="Value" ElementName="CompareSlider"/>
                                <Binding Path="ActualWidth" ElementName="ImageCanvas"/>
                                <Binding Path="ActualHeight" ElementName="ImageCanvas"/>
                            </MultiBinding>
                        </Grid.Clip>
                        <Image Source="{Binding ImageLeft.Image}" Stretch="Fill">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ImageLeft.Type}" Value="{x:Static local:FileType.Video}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                        <MediaElement x:Name="MediaElementLeft" Stretch="Fill" LoadedBehavior="Manual" UnloadedBehavior="Stop" IsMuted="True" MediaOpened="MediaElement_MediaOpened" MediaEnded="MediaElement_MediaEnded">
                             <MediaElement.Style>
                                <Style TargetType="MediaElement">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ImageLeft.Type}" Value="{x:Static local:FileType.Video}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </MediaElement.Style>
                        </MediaElement>
                    </Grid>

                    <!-- Divider slider (on top of the images) -->
                    <!-- It is also inside the ImageCanvas and will be scaled along with it. -->
                    <Slider x:Name="CompareSlider" Minimum="0" Maximum="100"
                            Value="{Binding SliderPosition, Mode=TwoWay}"
                            Foreground="{StaticResource PrimaryAccentBrush}"
                            Background="Transparent"
                            VerticalAlignment="Stretch"
                            PreviewMouseLeftButtonDown="Slider_PreviewMouseLeftButtonDown"
                            PreviewMouseLeftButtonUp="Slider_PreviewMouseLeftButtonUp"
                            MouseMove="Slider_MouseMove">
                        <Slider.Template>
                            <ControlTemplate TargetType="Slider">
                                <Grid Background="Transparent">
                                    <Track x:Name="PART_Track">
                                        <Track.Thumb>
                                            <Thumb x:Name="Thumb" Width="4" Cursor="SizeWE">
                                                <Thumb.Template>
                                                    <ControlTemplate TargetType="Thumb">
                                                        <Grid>
                                                            <Rectangle Fill="{TemplateBinding Foreground}" Width="2"/>
                                                            <Rectangle Fill="White" Width="4" Opacity="0.5"/>
                                                        </Grid>
                                                    </ControlTemplate>
                                                </Thumb.Template>
                                            </Thumb>
                                        </Track.Thumb>
                                    </Track>
                                </Grid>
                            </ControlTemplate>
                        </Slider.Template>
                    </Slider>
                </Grid>
            </Viewbox>
        </Grid>
        
        <Border HorizontalAlignment="Left" VerticalAlignment="Top" Margin="20" Background="#A0000000" CornerRadius="5" Padding="8,4">
            <TextBlock Text="{Binding ImageLeft.FileName}" TextTrimming="CharacterEllipsis" MaxWidth="300" Foreground="White" />
        </Border>
        <Border HorizontalAlignment="Right" VerticalAlignment="Top" Margin="20" Background="#A0000000" CornerRadius="5" Padding="8,4">
            <TextBlock Text="{Binding ImageRight.FileName}" TextTrimming="CharacterEllipsis" MaxWidth="300" Foreground="White" />
        </Border>
        <Button Content="✕" Style="{StaticResource OverlayButton}" Command="{Binding CloseCommand}"
                HorizontalAlignment="Right" VerticalAlignment="Top" Margin="5" Width="40" Height="40" FontSize="20"
                ToolTip="{local:Translate Fullscreen_Close}"/>
        <Border HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="20" Background="#A0000000" CornerRadius="10" Padding="10">
            <StackPanel Orientation="Horizontal">
                <Button Content="{local:Translate SliderCompare_Replace}" Command="{Binding ChangeImageLeftCommand}" Style="{StaticResource OverlayButton}" Width="Auto" Padding="15,10" FontSize="16" Height="Auto"/>
                <Button Content="↔" Command="{Binding SwapImagesCommand}" ToolTip="{local:Translate SliderCompare_Swap}" Margin="20,0" Style="{StaticResource OverlayButton}"/>
                <Button Content="{local:Translate SliderCompare_Replace}" Command="{Binding ChangeImageRightCommand}" Style="{StaticResource OverlayButton}" Width="Auto" Padding="15,10" FontSize="16" Height="Auto"/>

                <!-- ADDED: Video Controls -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="20,0,0,0"
                            Visibility="{Binding AreBothVideos, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding CurrentPositionFormatted}" Foreground="White" VerticalAlignment="Center"/>
                    <Slider x:Name="PositionSlider" Style="{StaticResource VideoSliderStyle}"
                            Value="{Binding CurrentPositionSeconds, Mode=TwoWay}"
                            Maximum="{Binding MaxDurationSeconds}"
                            IsMoveToPointEnabled="True"
                            Width="200" Margin="10,0"
                            Thumb.DragStarted="PositionSlider_DragStarted"
                            Thumb.DragCompleted="PositionSlider_DragCompleted"
                            ValueChanged="PositionSlider_ValueChanged"
                            PreviewMouseLeftButtonDown="PositionSlider_PreviewMouseLeftButtonDown"/>
                    <TextBlock Text="{Binding MaxDurationFormatted}" Foreground="White" VerticalAlignment="Center" Margin="0,0,10,0"/>

                    <Button Command="{Binding PlayPauseCommand}" Width="40" Height="40" FontSize="16">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource OverlayButton}">
                                <Setter Property="Content" Value="▶"/> <!-- Play Icon -->
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                        <Setter Property="Content" Value="⏸"/> <!-- Pause Icon -->
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </StackPanel>
        </Border>

    </Grid>
</UserControl>