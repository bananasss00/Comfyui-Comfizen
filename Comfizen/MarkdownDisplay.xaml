<UserControl x:Class="Comfizen.MarkdownDisplay"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:markdig="clr-namespace:Markdig.Wpf;assembly=Markdig.Wpf"
             mc:Ignorable="d" 
             d:DesignHeight="150" d:DesignWidth="400"
             MaxHeight="200">
    <Grid>
        <!-- The Viewer for formatted Markdown -->
        <!-- The Viewer for formatted Markdown -->
        <FlowDocumentScrollViewer x:Name="Viewer" 
                                  VerticalScrollBarVisibility="Auto" 
                                  IsToolBarVisible="False"
                                  MouseDoubleClick="Viewer_MouseDoubleClick"
                                  PreviewMouseLeftButtonDown="Viewer_PreviewMouseLeftButtonDown"
                                  Background="Transparent">
            <!-- The Hyperlink.RequestNavigate handler is removed from here -->
            <FlowDocumentScrollViewer.Resources>
                <!-- This style block is being removed as it's not effective -->
            </FlowDocumentScrollViewer.Resources>
            
            <!-- A dummy document to hold the resources and content -->
            <FlowDocument>
                <FlowDocument.Resources>
                    <!-- Global document styles -->
                    <Style TargetType="{x:Type Paragraph}">
                        <Setter Property="Margin" Value="0,0,0,8"/>
                    </Style>

                    <!-- THIS IS THE CORRECT WAY TO STYLE HYPERLINKS FOR MARKDIG.WPF -->
                    <Style x:Key="{x:Static markdig:Styles.HyperlinkStyleKey}" TargetType="Hyperlink">
                        <Setter Property="Foreground" Value="#E6DB74"/>
                        <Setter Property="Cursor" Value="Hand"/>
                        <Setter Property="TextDecorations" Value="None"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="TextDecorations" Value="Underline"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>

                    <!-- Styles for other Markdig elements remain the same -->
                    <Style x:Key="{x:Static markdig:Styles.Heading1StyleKey}" TargetType="Paragraph">
                        <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                        <Setter Property="FontWeight" Value="Bold"/>
                        <Setter Property="FontSize" Value="20"/>
                    </Style>
                    <Style x:Key="{x:Static markdig:Styles.Heading2StyleKey}" TargetType="Paragraph">
                        <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                        <Setter Property="FontWeight" Value="Bold"/>
                        <Setter Property="FontSize" Value="18"/>
                    </Style>
                    <Style x:Key="{x:Static markdig:Styles.Heading3StyleKey}" TargetType="Paragraph" BasedOn="{StaticResource {x:Type Paragraph}}">
                        <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                        <Setter Property="FontWeight" Value="Bold"/>
                        <Setter Property="FontSize" Value="16"/>
                    </Style>
                    <Style x:Key="{x:Static markdig:Styles.Heading4StyleKey}" TargetType="Paragraph" BasedOn="{StaticResource {x:Type Paragraph}}">
                        <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                        <Setter Property="FontWeight" Value="Bold"/>
                        <Setter Property="FontSize" Value="14"/>
                    </Style>
                </FlowDocument.Resources>
            </FlowDocument>
        </FlowDocumentScrollViewer>

        <!-- The Editor TextBox, initially hidden -->
        <TextBox x:Name="Editor"
                 Text="{Binding MarkdownText, RelativeSource={RelativeSource AncestorType=UserControl}, UpdateSourceTrigger=PropertyChanged}"
                 Visibility="Collapsed"
                 AcceptsReturn="True"
                 TextWrapping="Wrap"
                 VerticalScrollBarVisibility="Auto"
                 MaxHeight="200"
                 LostFocus="Editor_LostFocus"/>
    </Grid>
</UserControl>